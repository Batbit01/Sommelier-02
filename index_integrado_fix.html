<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
  <title id="vinoTitle">Ficha del Vino</title>

  <style>
    body { font-family: sans-serif; padding: 2rem; background-color: #fefefe; color: #222; max-width: 700px; margin: auto; }
    .vino-ficha img { width: 100%; max-height: 300px; object-fit: contain; border-radius: 1rem; }
    .vino-dato { margin-bottom: 1rem; }
    .vino-dato strong { display: inline-block; width: 100px; }
    #respuesta { margin-top: 2rem; font-style: italic; background: #f1f1f1; padding: 1rem; border-radius: 0.5rem; }
    #hablar { display: inline-block; margin-top: 2rem; padding: 0.75rem 1.5rem; background: #800000; color: white; border: none; border-radius: 1rem; cursor: pointer; transition: background .2s; font-weight: bold;}
    #hablar[disabled] { background: #a09797; color: #fff; cursor: not-allowed; }
    .redes a { margin-right: 1rem; text-decoration: none; color: #800000; }

    /* Compartir */
    #modulo-compartir { margin: 2rem 0 0.5rem 0; position: relative; display: flex; flex-direction: column; align-items: flex-start; }
    #btn-compartir {
      background: #fff; color: #800000; border: 2px solid #800000; border-radius: 2rem;
      padding: 0.5rem 1.25rem 0.5rem 0.75rem; font-weight: 600; font-size: 1.07rem;
      display: flex; align-items: center; gap: 0.55rem; cursor: pointer;
      transition: background 0.2s, box-shadow 0.2s; box-shadow: 0 2px 6px #80000011;
    }
    #btn-compartir:hover { background: #f8eaea; box-shadow: 0 4px 12px #8000001a; }
    #btn-compartir svg { flex-shrink: 0; }
    #menu-compartir {
      display: none; position: absolute; top: 110%; left: 0; background: #fff; border: 1.5px solid #e5dede;
      border-radius: 1.3rem; box-shadow: 0 6px 28px #80000012; min-width: 240px; padding: 0.5rem 0; z-index: 40;
      animation: fadeInCompartir 0.32s; transition: opacity 0.22s, transform 0.2s;
    }
    @keyframes fadeInCompartir { from { opacity: 0; transform: translateY(12px);} to { opacity: 1; transform: translateY(0);} }
    #menu-compartir.open { display: block; }
    .menu-item-compartir {
      display: flex; align-items: center; gap: 0.7rem; padding: 0.62rem 1.1rem; cursor: pointer;
      color: #700d18; font-size: 1.02rem; background: none; border: none; width: 100%;
      transition: background 0.17s, color 0.17s;
    }
    .menu-item-compartir:hover, .menu-item-compartir:focus { background: #f8eaea; color: #c9003f; outline: none; }
    .menu-item-compartir svg { width: 1.35em; height: 1.35em; display: block; }
    .menu-item-compartir.copiado { color: #218838; font-weight: 600; }

    /* Radar */
    #radar-svg-container {
      width: 100%; max-width: 520px; margin: 0 auto 2.5rem auto; background: #f8f4f2;
      border-radius: 22px; box-shadow: 0 2px 24px #0001; padding: 2.5rem 0; display: flex; flex-direction: column; align-items: center;
    }
    .switch-buttons { display: flex; justify-content: center; gap: 0.7rem; margin-bottom: 1.6rem; }
    .switch-buttons button {
      background-color: #a97c7c; color: white; border: 2px solid #800000; padding: 0.65rem 1.25rem;
      border-radius: 20px; cursor: pointer; transition: all 0.3s; font-weight: bold;
    }
    .switch-buttons button:hover { background-color: #800000; }
    .switch-buttons button.active { background-color: #800000; box-shadow: 0 0 10px rgba(128,0,0,0.5 ); }
    #radarSVG { background: none; display: block; margin: 0 auto; }
    .radar-label { font-size: 1rem; font-weight: bold; fill: #800000; text-anchor: middle; alignment-baseline: middle; pointer-events: none; }

    /* Valoraciones */
    #score-container, #valoracion-container { margin-top: 3rem; }
    #score-bar { width: 100%; height: 20px; background-color: #ddd; border-radius: 10px; overflow: hidden; }
    #score-fill { height: 100%; background-color: #800000; text-align: center; line-height: 20px; color: white; font-size: 0.9rem; }
    #estrellas .estrella { font-size: 2rem; color: #ccc; cursor: pointer; }
    #estrellas .estrella.seleccionada { color: #800000; }
    #estrellas-nota { color: #800000; font-size: 1.8rem; vertical-align: middle; }
    #lista-comentarios .comentario { margin-bottom: 1rem; padding: 0.75rem; border: 1px solid #ddd; border-radius: 0.5rem; background-color: #fafafa; text-align: left; }

    /* Sommelier (candado QR) */
    #modulo-sommelier { margin-bottom: 2.3rem; }
    #modulo-sommelier #sommelier-aviso {
      margin-top:0.7rem; color:#7b7171; background:#f7f3f0; padding:1rem 1.2rem;
      border-radius:1.1rem; font-size:1.07rem; display:flex; align-items:center; gap:0.7rem;
    }
  </style>

  <!-- Plyr.io CSS -->
  <link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" />
  <style>
    /* Personalización Plyr */
    .plyr--audio .plyr__controls { background: #f1f1f1; border-radius: 2rem; box-shadow: 0 2px 12px #80000012; }
    .plyr__control.plyr__control--overlaid, .plyr__control { background: #800000; color: #fff; }
    .plyr__control[aria-pressed="true"], .plyr__control:hover { background: #a97c7c; color: #fff; }
    .plyr__progress--played, .plyr__volume--display { color: #800000; background: #a97c7c; }
    .plyr__progress input[type=range]::-webkit-slider-thumb { background: #800000; }
    .plyr__menu__container, .plyr__menu__container label { color: #800000; }
  </style>
</head>

<body>
  <h1 id="vinoTitulo">Ficha del Vino</h1>
  <div class="vino-ficha">
    <img alt="Imagen del vino" id="vinoImagen" src=""/>
    <div class="vino-dato"><strong>Tipo:</strong> <span id="vinoTipo">-</span></div>
    <div class="vino-dato"><strong>Origen:</strong> <span id="vinoOrigen">-</span></div>
    <div class="vino-dato"><strong>Variedad:</strong> <span id="vinoUva">-</span></div>
    <div class="vino-dato"><strong>Bodega:</strong> <span id="bodegaNombre">-</span></div>
    <div class="vino-dato redes" id="bodega-redes"></div>
  </div>

  <!-- MÓDULO COMPARTIR -->
  <div id="modulo-compartir">
    <button id="btn-compartir" aria-label="Compartir ficha" title="Compartir ficha">
      <svg width="28" height="28" viewBox="0 0 24 24" fill="none"><path d="M13.2 5.9l2.4-2.4a1.5 1.5 0 1 1 2.1 2.1l-2.5 2.5M16.8 8.6a7 7 0 1 1-2.6-2.6" stroke="#800000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
      Compartir
    </button>
    <div id="menu-compartir"></div>
  </div>

  <!-- MÓDULO SOMMELIER VIRTUAL -->
  <div id="modulo-sommelier">
    <button id="hablar" disabled style="opacity:0.6;pointer-events:none;">
      <svg width="23" height="23" style="vertical-align:middle; margin-right:7px;" viewBox="0 0 20 20" fill="none"><circle cx="10" cy="10" r="8.5" stroke="#888" stroke-width="1.6"/><path d="M10 6.5v4.2M10 14h.01" stroke="#888" stroke-width="1.5" stroke-linecap="round"/></svg>
      Hablar con el sommelier
    </button>
    <div id="sommelier-aviso">
      <svg width="23" height="23" viewBox="0 0 20 20" fill="none"><circle cx="10" cy="10" r="8.5" stroke="#888" stroke-width="1.6"/><path d="M10 6.5v4.2M10 14h.01" stroke="#888" stroke-width="1.5" stroke-linecap="round"/></svg>
      Para vivir la experiencia del Sommelier Virtual, escanea el QR en la botella.
    </div>
  </div>

  <!-- NARRATIVA -->
  <div id="respuesta">Cargando descripción del vino...</div>
  <div id="bloque-audio-narrativa" style="margin:2.5rem 0; display:none;">
    <h3 style="margin-bottom:0.7rem; color: #800000;">Narrativa del sommelier</h3>
    <audio id="player" controls>
      Tu navegador no soporta audio HTML5.
    </audio>
  </div>

  <!-- RADAR -->
  <div id="radar-svg-container">
    <h3 style="margin-bottom:1.7rem;">Perfil organoléptico</h3>
    <div class="switch-buttons">
      <button id="btn-aromatico" onclick="setRadarType('aromatico')">Aromático</button>
      <button id="btn-gustativo" onclick="setRadarType('gustativo')">Gustativo</button>
      <button id="btn-sensorial" onclick="setRadarType('sensorial')">Sensorial</button>
    </div>
    <svg id="radarSVG" width="430" height="430"></svg>
  </div>

  <!-- VALORACIONES -->
  <div id="score-container">
    <h3>Puntuación Total</h3>
    <div id="score-bar"><div id="score-fill" style="width: 0%">0</div></div>
    <div id="rating-summary" style="display: flex; align-items: center; gap: 0.5rem; margin-top: 1rem;">
      <span id="media-nota" style="font-size:2rem; font-weight:bold;">-</span>
      <span id="estrellas-nota" style="font-size:1.5rem; color: #800000;"></span>
      <span id="total-valoraciones" style="font-size:1rem; color:#555;"></span>
    </div>
  </div>

  <div id="valoracion-container">
    <h3>Valora este vino</h3>
    <div id="estrellas">
      <span class="estrella" data-value="1">★</span><span class="estrella" data-value="2">★</span><span class="estrella" data-value="3">★</span><span class="estrella" data-value="4">★</span><span class="estrella" data-value="5">★</span>
    </div>
    <textarea id="comentario" placeholder="Deja un comentario sobre el vino..." rows="4" style="width:100%; margin-top: 1rem; padding: 0.5rem;"></textarea>
    <button id="enviar-valoracion" style="margin-top: 1rem; background:#800000; color:white; border:none; padding:0.5rem 1rem; border-radius:0.5rem; cursor:pointer;">Enviar valoración</button>
    <p id="mensaje-valoracion" style="margin-top:1rem; color: green;"></p>
  </div>

  <div id="comentarios-container" style="margin-top: 3rem;">
    <h3 style="cursor:pointer; color:#800000;" onclick="toggleComentarios()">▼ Comentarios de otros usuarios</h3>
    <div id="lista-comentarios" style="max-height: 0; overflow: hidden; transition: max-height 0.5s ease-out;">
      <p style="padding: 1rem 0;">Cargando comentarios...</p>
    </div>
  </div>

  <!-- JS LIB Plyr -->
  <script src="https://cdn.plyr.io/3.7.8/plyr.polyfilled.js"></script>

  <!-- JS APP -->
  <script>
    
  <!-- ==== BLOQUE GLOBAL DE CONTEXTO (idioma/geo/sesión/dispositivo) ==== -->
  <script>
  // ---- Parámetros globales (NUEVO) ----
  const params = new URLSearchParams(window.location.search);
  const vinoId = params.get('vino_id') || "";

  // Session ID estable
  function ensureSessionId() {
    let sid = localStorage.getItem('user_id');
    if (!sid) {
      sid = `user_${Math.random().toString(36).slice(2, 10)}`;
      localStorage.setItem('user_id', sid);
    }
    return sid;
  }

  // Dispositivo + UA
  function detectDevice() {
    const ua = navigator.userAgent || "";
    const isTablet = /iPad|Tablet|Android(?!.*Mobile)/i.test(ua);
    const isMobile = /Mobi|Android.+Mobile|iPhone/i.test(ua);
    const dispositivo = isTablet ? 'tablet' : (isMobile ? 'mobile' : 'desktop');
    return { dispositivo, ua };
  }

  // Geo + Idioma (con timeout para no bloquear)
  async function loadGeoAndLang(timeoutMs = 1000) {
    const idiomaNavegador = ((navigator.languages && navigator.languages[0]) || navigator.language || 'es').slice(0, 2);
    const controller = new AbortController();
    const id = setTimeout(() => controller.abort(), timeoutMs);

    try {
      const res = await fetch('https://ipapi.co/json/', { signal: controller.signal });
      clearTimeout(id);
      const data = await res.json().catch(() => ({}));
      return {
        ciudad: data?.city || '',
        pais: data?.country_name || '',
        idioma: idiomaNavegador
      };
    } catch (_) {
      clearTimeout(id);
      return { ciudad: '', pais: '', idioma: idiomaNavegador };
    }
  }

  // Construye el contexto común
  async function buildCtx() {
    const { dispositivo, ua } = detectDevice();
    const geo = await loadGeoAndLang(1000);
    return {
      idioma: geo.idioma,
      ciudad: geo.ciudad,
      pais: geo.pais,
      session_id: ensureSessionId(),
      dispositivo,
      ua,
      qr_id: params.get('qr') || '',
      _ts: Date.now()
    };
  }

  // Adjunta contexto a una URL GET
  async function withCtx(baseUrl) {
    const ctx = await buildCtx();
    const url = new URL(baseUrl);
    Object.entries(ctx).forEach(([k, v]) => {
      if (v !== undefined && v !== null) url.searchParams.set(k, String(v));
    });
    return url.toString();
  }
  </script>

    async function cargarNarrativaVino() {
      const respuestaEl = document.getElementById("respuesta");
      const bloqueAudio = document.getElementById("bloque-audio-narrativa");
      const playerEl    = document.getElementById("player");

      if (!vinoId) {
        respuestaEl.innerText = "No se especificó ningún vino.";
        bloqueAudio.style.display = "none";
        return;
      }

      try {
        // Espera rápida por city/country/lang (máx 1000ms)
        try {
          await Promise.race([
            window._datosUsuarioPromise,
            new Promise(r => setTimeout(r, 1000))
          ]);
        } catch (_) {}

        // Parámetros enriquecidos
        const idioma = (window._datosUsuario?.idioma || (navigator.language || 'es')).slice(0,2);
        const ciudad = window._datosUsuario?.ciudad || '';
        const pais   = window._datosUsuario?.pais || '';
        const qr_id  = new URLSearchParams(window.location.search).get('qr') || '';
        let sessionId = localStorage.getItem('user_id');
        if (!sessionId) {
          sessionId = `user_${Math.random().toString(36).slice(2,10)}`;
          localStorage.setItem('user_id', sessionId);
        }
        const ua = navigator.userAgent || '';

        // Construcción de URL con contexto
        const baseConsultar = "https://n8n-production-cb18.up.railway.app/webhook/Consultar-vino-7dbyxa8kql19qw";
        const reqUrl = await withCtx(baseConsultar + `?vino_id=${encodeURIComponent(vinoId)}&secret=${encodeURIComponent("midulcesommelier")}`);
        const res = await fetch(reqUrl, { cache: "no-store" });
        const raw = await res.text();
        if (!res.ok) throw new Error(`HTTP ${res.status} :: ${raw.slice(0,120)}`);

        let data = {};
        try { data = raw ? JSON.parse(raw) : {}; } catch { data = {}; }

        // Fallback si viene dentro de "fields"
        if (!data.audio_url && data.fields) {
          data.audio_url = data.fields["Audio URL"] || "";
          data.narrativa = data.narrativa || data.fields["narrativa"] || "";
          data.vino_id   = data.vino_id   || data.fields["ID Vino"]  || "";
        }

        // Texto
        respuestaEl.innerText = data.narrativa || "No se pudo generar la narrativa del vino.";

        // Audio (forzar https si llega http)
        let audioUrl = (data.audio_url || "").trim();
        if (audioUrl.startsWith("http://")) audioUrl = audioUrl.replace(/^http:\/\//i, "https://");

        if (audioUrl) {
          if (playerEl._plyr) { try { playerEl._plyr.destroy(); } catch(_) {} playerEl._plyr = null; }
          playerEl.innerHTML = "";
          const src = document.createElement("source");
          src.src  = audioUrl;
          src.type = "audio/mpeg";
          playerEl.appendChild(src);
          playerEl.load();

          const inst = new Plyr(playerEl, { speed: { selected: 1, options: [0.75, 1, 1.25, 1.5, 2] } });
          playerEl._plyr = inst;
          bloqueAudio.style.display = "block";
        } else {
          bloqueAudio.style.display = "none";
        }
      } catch (err) {
        console.error("❌ Narrativa/Audio:", err);
        respuestaEl.innerText = "No se pudo cargar la información del vino.";
        bloqueAudio.style.display = "none";
      }
    }

    // ---- Radar y resto de módulos ----
    document.addEventListener("DOMContentLoaded", function() {
      const perfilesConfig = {
        gustativo: {
          labels: ["Cuerpo", "Acidez", "Dulzor", "Taninos", "Frescura", "Mineralidad"],
          fields: ["cuerpo", "acidez", "dulzor", "taninos", "frescura", "mineralidad"]
        },
        aromatico: {
          labels: ["Fruta", "Floral", "Especiado", "Tostado", "Herbáceo"],
          fields: ["fruta", "floral", "especiado", "tostado", "herbaceo"]
        },
        sensorial: {
          labels: ["Persistencia", "Complejidad", "Astringencia", "Alcohol", "Armonía"],
          fields: ["persistencia", "complejidad", "astringencia", "alcohol_percibido", "armonia"]
        }
      };
      let radarType = "aromatico";
      let organo = {};

      function setRadarType(tipo) {
        radarType = tipo;
        document.querySelectorAll('.switch-buttons button').forEach(btn => btn.classList.remove('active'));
        document.getElementById(`btn-${tipo}`).classList.add('active');
        renderRadarSVG();
      }
      window.setRadarType = setRadarType;

      function polarToCartesian(cx, cy, r, angleRad) {
        return [ cx + r * Math.cos(angleRad), cy + r * Math.sin(angleRad) ];
      }

      function renderRadarSVG() {
        const svg = document.getElementById("radarSVG");
        svg.innerHTML = "";
        svg.innerHTML += `<rect x="0" y="0" width="430" height="430" fill="#f8f4f2"/>`;
        const config = perfilesConfig[radarType];
        const N = config.labels.length;
        const R = 155, cx = 215, cy = 215, min = 0, max = 10;
        let values = config.fields.map(f => parseInt(organo[f]) || 0);

        for (let c = 1; c <= 5; c++) {
          let r = (R * c) / 5;
          let mesh = [];
          for (let i = 0; i < N; i++) {
            let angle = -Math.PI / 2 + (2 * Math.PI * i) / N;
            mesh.push(polarToCartesian(cx, cy, r, angle));
          }
          svg.innerHTML += `<polygon points="${mesh.map(p=>p.join(',')).join(' ')}" fill="none" stroke="#d7bebe" stroke-width="1"/>`;
        }
        for (let i = 0; i < N; i++) {
          let angle = -Math.PI / 2 + (2 * Math.PI * i) / N;
          let [x2, y2] = polarToCartesian(cx, cy, R, angle);
          svg.innerHTML += `<line x1="${cx}" y1="${cy}" x2="${x2}" y2="${y2}" stroke="#bfa1a1" stroke-width="1"/>`;
          let [lx, ly] = polarToCartesian(cx, cy, R+30, angle);
          svg.innerHTML += `<text x="${lx}" y="${ly}" class="radar-label">${config.labels[i]}</text>`;
        }
        let poly = [];
        for (let i = 0; i < N; i++) {
          let v = values[i];
          let r = (v-min)/(max-min)*R;
          let angle = -Math.PI / 2 + (2 * Math.PI * i) / N;
          poly.push(polarToCartesian(cx, cy, r, angle));
        }
        svg.innerHTML += `<polygon points="${poly.map(p=>p.join(',')).join(' ')}" fill="rgba(128,0,0,0.17)" stroke="#800000" stroke-width="3"/>`;
        for (let i = 0; i < N; i++) {
          let v = values[i];
          let r = (v-min)/(max-min)*R;
          let angle = -Math.PI / 2 + (2 * Math.PI * i) / N;
          let [px, py] = polarToCartesian(cx, cy, r, angle);
          svg.innerHTML += `<circle cx="${px}" cy="${py}" r="8" fill="#800000" stroke="white" stroke-width="2"/>`;
        }
      }

      // --------- Cargar ficha y datos ---------
      async function cargarFichaVino() {
        try {
          const fichaData = await (await fetch(`https://sommelierlab-api-production.up.railway.app/api/vino/${vinoId}`)).json();
          document.getElementById("vinoImagen").src = fichaData.imagen?.[0]?.url || "";
          document.title = document.getElementById("vinoTitulo").innerText = fichaData.nombre || "Ficha del Vino";
          document.getElementById("vinoTipo").innerText = fichaData.tipo;
          document.getElementById("vinoUva").innerText = fichaData.variedad;
          document.getElementById("vinoOrigen").innerText = fichaData.origen;
          document.getElementById("bodegaNombre").innerText = fichaData.bodega?.nombre || "";
          const redesHtml = [];
          if (fichaData.bodega?.web) redesHtml.push(`<a href="${fichaData.bodega.web}" target="_blank">🌐 Web</a>`);
          if (fichaData.bodega?.facebook) redesHtml.push(`<a href="${fichaData.bodega.facebook}" target="_blank">📘 Facebook</a>`);
          if (fichaData.bodega?.instagram) redesHtml.push(`<a href="${fichaData.bodega.instagram}" target="_blank">📸 Instagram</a>`);
          if (fichaData.bodega?.twitter) redesHtml.push(`<a href="${fichaData.bodega.twitter}" target="_blank">🐦 Twitter</a>`);
          document.getElementById("bodega-redes").innerHTML = redesHtml.join(" · ");
        } catch (error) {
          console.error("❌ Error cargando la ficha del vino:", error);
        }
      }

      async function cargarPerfilOrganoleptico() {
        try {
          const response = await fetch(`https://sommelierlab-api-production.up.railway.app/api/organoleptica/${vinoId}`);
          organo = await response.json();
          setRadarType(radarType);
        } catch (err) {
          alert("No se pudo cargar el perfil organoléptico");
        }
      }

      async function cargarValoraciones() {
        try {
          const res = await fetch(await withCtx(`https://n8n-production-cb18.up.railway.app/webhook/consultar-valoraciones?vino_id=${vinoId}`));
        const data = await res.json();
          document.getElementById("media-nota").innerText = data.nota_media !== undefined ? data.nota_media.toFixed(1) : "-";
          const contenedor = document.getElementById("estrellas-nota");
          contenedor.innerHTML = "";
          const nota = data.nota_media || 0;
          const estrellas = Math.floor(nota);
          const media = nota - estrellas;
          for (let i = 1; i <= 5; i++) {
            if (i <= estrellas) contenedor.innerHTML += "★";
            else if (i === estrellas + 1 && media >= 0.25 && media < 0.75) contenedor.innerHTML += "⯪";
            else contenedor.innerHTML += "☆";
          }
          document.getElementById("total-valoraciones").innerText = data.total_valoraciones ? `(${data.total_valoraciones} valoraciones)` : "";
          const fill = document.getElementById("score-fill");
          const porcentaje = data.nota_media ? Math.round((data.nota_media / 5) * 100) : 0;
          fill.style.width = porcentaje + "%";
          fill.innerText = data.nota_media ? `${data.nota_media.toFixed(1)} / 5` : "0 / 5";
        } catch (error) {
          console.error("Error al cargar valoraciones:", error);
        }
      }

      async function cargarComentarios() {
        try {
          const res = await fetch(await withCtx(`https://n8n-production-cb18.up.railway.app/webhook/consultar-comentarios?vino_id=${vinoId}`));
          const data = await res.json();
          const listaComentariosEl = document.getElementById("lista-comentarios");
          const comentarios = Array.isArray(data.comentarios) ? data.comentarios : Array.isArray(data) ? data : [];
          listaComentariosEl.innerHTML = "";
          if (comentarios.length === 0) {
            listaComentariosEl.innerHTML = '<p style="padding: 1rem 0;">No hay comentarios aún. ¡Sé el primero en opinar!</p>';
          } else {
            comentarios.slice(0, 10).forEach(c => {
              const div = document.createElement("div");
              div.className = "comentario";
              div.innerHTML = `<strong style="color:#800000;">${c.ciudad || "Usuario anónimo"}</strong> · <span style="color: #666;">${(c.fecha || "").slice(0,10)}</span>  
<em>“${c.comentario}”</em>`;
              listaComentariosEl.appendChild(div);
            });
          }
          if (listaComentariosEl.style.maxHeight !== "0px" && listaComentariosEl.style.maxHeight !== "") {
            listaComentariosEl.style.maxHeight = listaComentariosEl.scrollHeight + "px";
          }
        } catch (error) {
          console.error("Error al cargar comentarios:", error);
          document.getElementById("lista-comentarios").innerHTML = "<p>No se pudieron cargar los comentarios.</p>";
        }
      }

      // Si no hay vinoId
      if (!vinoId) {
        document.getElementById("respuesta").innerText = "No se especificó ningún vino.";
        return;
      }

      // Cargas principales
      cargarFichaVino();
      cargarNarrativaVino();
      cargarPerfilOrganoleptico();
      cargarValoraciones();
      cargarComentarios();

      // Valoraciones y comentarios (interfaz)
      let puntuacionSeleccionada = 0;
      document.querySelectorAll(".estrella").forEach(e => {
        e.addEventListener("click", () => {
          puntuacionSeleccionada = parseInt(e.dataset.value);
          document.querySelectorAll(".estrella").forEach(star => {
            star.classList.toggle("seleccionada", parseInt(star.dataset.value) <= puntuacionSeleccionada);
          });
        });
      });

      document.getElementById("enviar-valoracion").addEventListener("click", async () => {
        const comentario = document.getElementById("comentario").value || "";
        const mensaje = document.getElementById("mensaje-valoracion");
        if (!puntuacionSeleccionada) {
          mensaje.innerText = "Por favor, selecciona una puntuación (de 1 a 5 estrellas).";
          mensaje.style.color = "red";
          return;
        }
        try {
          await fetch("https://n8n-production-cb18.up.railway.app/webhook/comentar-vino", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ vino_id: vinoId,
              puntuacion: puntuacionSeleccionada,
              comentario: comentario,
              user_id: localStorage.getItem("user_id") || "user_" + Math.random().toString(36).substring(2, 10),
              ciudad: window._datosUsuario?.ciudad || "Desconocida",
              pais: window._datosUsuario?.pais || "Desconocido",
              idioma: window._datosUsuario?.idioma || "es"
            , dispositivo: (detectDevice().dispositivo), ua: (navigator.userAgent||"") })
          });
          mensaje.innerText = "¡Gracias por tu valoración!";
          mensaje.style.color = "green";
          puntuacionSeleccionada = 0;
          document.querySelectorAll(".estrella").forEach(star => star.classList.remove("seleccionada"));
          document.getElementById("comentario").value = "";
          cargarValoraciones();
          cargarComentarios();
        } catch (err) {
          mensaje.innerText = "Error al enviar tu valoración.";
          mensaje.style.color = "red";
        }
      });

      // Comentarios: animar/desplegar
      window.toggleComentarios = function() {
        const listaComentariosEl = document.getElementById("lista-comentarios");
        if (listaComentariosEl.style.maxHeight === "0px" || !listaComentariosEl.style.maxHeight) {
          listaComentariosEl.style.maxHeight = listaComentariosEl.scrollHeight + "px";
        } else {
          listaComentariosEl.style.maxHeight = "0px";
        }
      };

      // ----------- CONTROL ACCESO SOMMELIER (candado QR) -----------
      const esQR = (new URLSearchParams(window.location.search)).get("qr") === "1";
      const btnHablar = document.getElementById("hablar");
      const avisoSommelier = document.getElementById("sommelier-aviso");
      if (esQR) {
        btnHablar.disabled = false;
        btnHablar.style.opacity = 1;
        btnHablar.style.pointerEvents = "auto";
        avisoSommelier.style.display = "none";
      } else {
        btnHablar.disabled = true;
        btnHablar.style.opacity = 0.6;
        btnHablar.style.pointerEvents = "none";
        avisoSommelier.style.display = "flex";
      }

      // ------------------ MÓDULO COMPARTIR (JS) ------------------
      const iconosCompartir = {
        whatsapp: `<svg viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.029-.967-.273-.099-.471-.148-.669.149-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.149-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.151-.172.2-.297.3-.495.099-.198.05-.372-.025-.521-.075-.149-.669-1.611-.916-2.207-.242-.579-.487-.5-.669-.509l-.571-.011c-.198 0-.521.074-.792.372-.272.297-1.041 1.017-1.041 2.479 0 1.462 1.066 2.875 1.214 3.074.149.198 2.098 3.2 5.076 4.363.71.306 1.263.488 1.694.625.712.227 1.36.195 1.872.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.288.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 6.412h-.004a9.87 9.87 0 0 1-5.031-1.378l-.361-.214-3.741.982.999-3.648-.235-.374a9.86 9.86 0 0 1-1.51-5.244c.001-5.455 4.436-9.888 9.893-9.888 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 0 1 2.896 6.994c-.003 5.455-4.437 9.888-9.893 9.888M20.013 3.988A11.815 11.815 0 0 0 12.004 1c-6.624 0-12 5.373-12 11.993a11.91 11.91 0 0 0 1.605 6.006L.057 23l6.118-1.605a11.933 11.933 0 0 0 5.822 1.487h.005c6.623 0 11.999-5.373 12-11.992a11.823 11.823 0 0 0-3.989-8.902" fill="#25D366"/></svg>`,
        telegram: `<svg viewBox="0 0 24 24"><path d="M9.885 15.568l-.397 3.57c.571 0 .816-.244 1.111-.54l2.664-2.53 5.526 4.043c1.01.556 1.723.264 1.981-.936l3.597-16.624c.328-1.515-.55-2.109-1.523-1.787L1.436 9.76c-1.475.461-1.455 1.398-.254 1.772l4.301 1.343 10.008-6.304c.47-.287.898-.128.545.159z" fill="#229ED9"/></svg>`,
        instagram: `<svg viewBox="0 0 24 24"><linearGradient id="a" x1="1.67" x2="22.33" y1="1.67" y2="22.33" gradientUnits="userSpaceOnUse"><stop offset="0" stop-color="#fd5"/><stop offset=".5" stop-color="#ff543f"/><stop offset="1" stop-color="#c837ab"/></linearGradient><path d="M12 2.163c3.204 0 3.584.012 4.85.07 1.206.057 2.003.24 2.47.411a4.9 4.9 0 0 1 1.675 1.013 4.898 4.898 0 0 1 1.013 1.675c.172.468.355 1.265.411 2.47.058 1.266.07 1.646.07 4.85s-.012 3.584-.07 4.85c-.056 1.206-.239 2.003-.411 2.47a4.908 4.908 0 0 1-1.013 1.675 4.9 4.9 0 0 1-1.675 1.013c-.468.172-1.265.355-2.47.411-1.266.058-1.646.07-4.85.07s-3.584-.012-4.85-.07c-1.206-.057-2.003-.24-2.47-.411a4.902 4.902 0 0 1-1.675-1.013 4.9 4.9 0 0 1-1.013-1.675c-.172-.468-.355-1.265-.411-2.47C2.175 15.797 2.163 15.417 2.163 12s.012-3.584.07-4.85c.056-1.206.239-2.003.411-2.47A4.906 4.906 0 0 1 3.657 3.006 4.902 4.902 0 0 1 5.332 1.993c.468-.172 1.265-.355 2.47-.411C8.416 2.175 8.796 2.163 12 2.163z" fill="url(#a)"/><path d="M12 5.838A6.162 6.162 0 1 0 12 18.162 6.162 6.162 0 1 0 12 5.838zm0 10.162a4 4 0 1 1 0-8 4 4 0 0 1 0 8z" fill="#fff"/></svg>`,
        gmail: `<svg viewBox="0 0 24 24"><path d="M12 13.172l7.727-7.727A2 2 0 0 1 22 5.172v13.656A2 2 0 0 1 20 21H4a2 2 0 0 1-2-2V5.172a2 2 0 0 1 2.273-1.727L12 13.172z" fill="#EA4335"/><path d="M2.273 3.445L12 13.172l9.727-9.727A2 2 0 0 0 20 3H4a2 2 0 0 0-1.727.445z" fill="#34A853"/></svg>`,
        pocket: `<svg viewBox="0 0 24 24"><path d="M17.8 2.2H6.2C3.4 2.2 1.2 4.4 1.2 7.2v9.6c0 2.8 2.2 5 5 5h11.6c2.8 0 5-2.2 5-5V7.2c0-2.8-2.2-5-5-5zm2.6 14.6c0 1.5-1.1 2.6-2.6 2.6H6.2c-1.5 0-2.6-1.1-2.6-2.6V7.2c0-1.5 1.1-2.6 2.6-2.6h11.6c1.5 0 2.6 1.1 2.6 2.6v9.6zm-4.8-4.1c-.2.2-.4.3-.7.3s-.5-.1-.7-.3l-2.5-2.6a.995.995 0 0 1 1.4-1.4l1.8 1.8 1.8-1.8a.995.995 0 1 1 1.4 1.4l-2.5 2.6z" fill="#EF3F56"/></svg>`,
        beeper: `<svg viewBox="0 0 24 24"><rect width="24" height="24" rx="5" fill="#181A20"/><path d="M16.5 8.6a.8.8 0 0 0-1.13 0l-2.4 2.4-2.4-2.4a.8.8 0 0 0-1.13 1.13l2.4 2.4-2.4 2.4a.8.8 0 1 0 1.13 1.13l2.4-2.4 2.4 2.4a.8.8 0 1 0 1.13-1.13l-2.4-2.4 2.4-2.4a.8.8 0 0 0 0-1.13z" fill="#fff"/></svg>`,
        facebook: `<svg viewBox="0 0 24 24"><path d="M22.675 0h-21.35C.595 0 0 .592 0 1.326v21.348C0 23.408.595 24 1.326 24H12.82v-9.294H9.692V11.01h3.128V8.41c0-3.1 1.893-4.788 4.659-4.788 1.325 0 2.463.099 2.797.143v3.24l-1.919.001c-1.504 0-1.797.715-1.797 1.763v2.312h3.587l-.467 3.696h-3.12V24h6.116C23.406 24 24 23.408 24 22.674V1.326C24 .592 23.406 0 22.675 0" fill="#1877F3"/></svg>`,
        twitter: `<svg viewBox="0 0 24 24"><path d="M23.954 4.569c-.885.389-1.83.654-2.825.775 1.014-.611 1.794-1.574 2.163-2.724-.951.564-2.005.974-3.127 1.195-.897-.957-2.178-1.555-3.594-1.555-2.723 0-4.928 2.204-4.928 4.928 0 .39.045.765.127 1.124-4.094-.205-7.725-2.167-10.158-5.144-.425.729-.666 1.577-.666 2.476 0 1.708.87 3.213 2.188 4.096-.807-.026-1.566-.248-2.229-.616v.062c0 2.386 1.693 4.374 3.946 4.827-.413.112-.849.171-1.296.171-.317 0-.626-.031-.928-.088.627 1.956 2.444 3.377 4.6 3.415-1.68 1.316-3.809 2.101-6.102 2.101-.395 0-.785-.023-1.17-.068 2.178 1.397 4.768 2.211 7.557 2.211 9.054 0 14.009-7.496 14.009-13.986 0-.21 0-.42-.016-.63.962-.689 1.797-1.56 2.457-2.548z" fill="#1da1f2"/></svg>`,
        copiar: `<svg viewBox="0 0 24 24"><rect x="7" y="7" width="13" height="13" rx="2" fill="#bfa1a1"/><rect x="3" y="3" width="13" height="13" rx="2" fill="#800000"/></svg>`
      };

      const opcionesCompartir = [
        { id: 'whatsapp', label: 'WhatsApp', url: link => `https://wa.me/?text=${encodeURIComponent(link)}` },
        { id: 'telegram', label: 'Telegram', url: link => `https://t.me/share/url?url=${encodeURIComponent(link)}` },
        { id: 'instagram', label: 'Instagram', url: link => `https://www.instagram.com/?url=${encodeURIComponent(link)}` },
        { id: 'gmail', label: 'Gmail', url: link => `mailto:?body=${encodeURIComponent(link)}&subject=¡Descubre este vino!` },
        { id: 'pocket', label: 'Pocket', url: link => `https://getpocket.com/save?url=${encodeURIComponent(link)}` },
        { id: 'beeper', label: 'Beeper', url: link => `https://beeper.com/share?url=${encodeURIComponent(link)}` },
        { id: 'facebook', label: 'Facebook', url: link => `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(link)}` },
        { id: 'twitter', label: 'X (Twitter)', url: link => `https://twitter.com/intent/tweet?url=${encodeURIComponent(link)}&text=¡Descubre este vino en SommelierLab!` },
        { id: 'copiar', label: 'Copiar enlace', url: link => null }
      ];

      const btnCompartir = document.getElementById('btn-compartir');
      const menuCompartir = document.getElementById('menu-compartir');

      function crearOpcion(opc) {
        const el = document.createElement('button');
        el.className = 'menu-item-compartir';
        el.innerHTML = `${iconosCompartir[opc.id] || ""}<span>${opc.label}</span>`;
        el.tabIndex = 0;
        el.onclick = (e) => {
          e.preventDefault();
          e.stopPropagation();
          // Siempre quitamos qr=1 del enlace compartido
          const urlActual = window.location.href.replace(/[?#].*$/, '') + window.location.search.replace(/[&?]qr=1/gi, '').replace(/([?&])$/, '');
          if(opc.id === 'copiar') {
            navigator.clipboard.writeText(urlActual);
            el.classList.add("copiado");
            el.innerHTML = iconosCompartir.copiar + "<span>¡Enlace copiado!</span>";
            setTimeout(() => {
              el.classList.remove("copiado");
              el.innerHTML = iconosCompartir.copiar + "<span>Copiar enlace</span>";
              menuCompartir.classList.remove("open");
            }, 1200);
          } else {
            window.open(opc.url(urlActual), '_blank');
            menuCompartir.classList.remove("open");
          }
        };
        return el;
      }

      function renderizarMenuCompartir() {
        menuCompartir.innerHTML = '';
        opcionesCompartir.forEach(opc => {
          menuCompartir.appendChild(crearOpcion(opc));
        });
      }

      btnCompartir.onclick = function(e) {
        e.stopPropagation();
        if(menuCompartir.classList.contains('open')) {
          menuCompartir.classList.remove('open');
        } else {
          renderizarMenuCompartir();
          menuCompartir.classList.add('open');
        }
      };

      document.addEventListener('click', function(){
        if(menuCompartir.classList.contains('open')) {
          menuCompartir.classList.remove('open');
        }
      });
      document.addEventListener('keydown', function(e){
        if(e.key === "Escape" && menuCompartir.classList.contains('open')) {
          menuCompartir.classList.remove('open');
        }
      });
      menuCompartir.addEventListener('keydown', function(e){
        if(e.key === "Tab") {
          let focusables = Array.from(menuCompartir.querySelectorAll('.menu-item-compartir'));
          let idx = focusables.indexOf(document.activeElement);
          if(e.shiftKey && idx === 0) {
            focusables[focusables.length-1].focus();
            e.preventDefault();
          } else if(!e.shiftKey && idx === focusables.length-1) {
            focusables[0].focus();
            e.preventDefault();
          }
        }
      });
    });
  </script>
</body>
</html>