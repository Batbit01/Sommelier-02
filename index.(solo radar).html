<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title id="vinoTitle">Ficha del Vino</title>
    <style>
        body { font-family: sans-serif; background: #fefefe; color: #222; max-width: 600px; margin: 0 auto; padding: 2rem; }
        .vino-ficha img { width: 100%; max-height: 300px; object-fit: contain; border-radius: 1rem; }
        .vino-dato { margin-bottom: 1rem; }
        .vino-dato strong { display: inline-block; width: 100px; }
        #respuesta { margin-top: 2rem; font-style: italic; background: #f1f1f1; padding: 1rem; border-radius: 0.5rem; }
        #hablar { display: inline-block; margin-top: 2rem; padding: 0.75rem 1.5rem; background: #800000; color: white; border: none; border-radius: 1rem; cursor: pointer; }
        .redes a { margin-right: 1rem; text-decoration: none; color: #800000; }

        #radar-svg-container { display: flex; flex-direction: column; align-items: center; margin-top: 2.5rem; }
        .switch-buttons {
            display: flex;
            justify-content: center;
            gap: 0.7rem;
            margin-bottom: 1.2rem;
        }
        .switch-buttons button {
            background-color: #a97c7c;
            color: white;
            border: 2px solid #800000;
            padding: 0.55rem 1.15rem;
            border-radius: 18px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
            font-size: 1.05rem;
        }
        .switch-buttons button.active {
            background-color: #800000;
            box-shadow: 0 0 8px rgba(128,0,0,0.25);
        }
        #radarSVG {
            background: #f8f4f2;
            border-radius: 50%;
            box-shadow: 0 2px 16px #0001;
        }
        .radar-label {
            font-size: 1rem;
            font-weight: bold;
            fill: #800000;
            text-anchor: middle;
            alignment-baseline: middle;
            pointer-events: none;
        }
        #score-container, #valoracion-container { margin-top: 3rem; }
        #score-bar { width: 100%; height: 20px; background-color: #ddd; border-radius: 10px; overflow: hidden; }
        #score-fill { height: 100%; background-color: #800000; text-align: center; line-height: 20px; color: white; font-size: 0.9rem; }
        #estrellas .estrella { font-size: 2rem; color: #ccc; cursor: pointer; }
        #estrellas .estrella.seleccionada { color: #800000; }
        #estrellas-nota { color: #800000; font-size: 1.8rem; vertical-align: middle; }
        #lista-comentarios .comentario { margin-bottom: 1rem; padding: 0.75rem; border: 1px solid #ddd; border-radius: 0.5rem; background-color: #fafafa; text-align: left; }
    </style>
</head>
<body>
    <h1 id="vinoTitulo">Ficha del Vino</h1>
    <div class="vino-ficha">
        <img alt="Imagen del vino" id="vinoImagen" src=""/>
        <div class="vino-dato"><strong>Tipo:</strong> <span id="vinoTipo">-</span></div>
        <div class="vino-dato"><strong>Origen:</strong> <span id="vinoOrigen">-</span></div>
        <div class="vino-dato"><strong>Variedad:</strong> <span id="vinoUva">-</span></div>
        <div class="vino-dato"><strong>Bodega:</strong> <span id="bodegaNombre">-</span></div>
        <div class="vino-dato redes" id="bodega-redes"></div>
    </div>
    <div id="respuesta">Cargando descripci√≥n del vino...</div>
    <button id="hablar">Hablar con el sommelier</button>

    <div id="radar-svg-container">
        <div class="switch-buttons">
            <button id="btn-aromatico" onclick="setRadarType('aromatico')">Arom√°tico</button>
            <button id="btn-gustativo" onclick="setRadarType('gustativo')">Gustativo</button>
            <button id="btn-sensorial" onclick="setRadarType('sensorial')">Sensorial</button>
        </div>
        <svg id="radarSVG" width="360" height="360"></svg>
    </div>
<script>
// ---------- Radar SVG conectado a API ----------
const perfilesConfig = {
    gustativo: {
        labels: ["Cuerpo", "Acidez", "Dulzor", "Taninos", "Frescura", "Mineralidad"],
        fields: ["cuerpo", "acidez", "dulzor", "taninos", "frescura", "mineralidad"]
    },
    aromatico: {
        labels: ["Fruta", "Floral", "Especiado", "Tostado", "Herb√°ceo"],
        fields: ["fruta", "floral", "especiado", "tostado", "herbaceo"]
    },
    sensorial: {
        labels: ["Persistencia", "Complejidad", "Astringencia", "Alcohol", "Armon√≠a"],
        fields: ["persistencia", "complejidad", "astringencia", "alcohol_percibido", "armonia"]
    }
};
let radarType = "aromatico";
let organo = {}; // perfil organol√©ptico desde la API

function setRadarType(tipo) {
    radarType = tipo;
    document.querySelectorAll('.switch-buttons button').forEach(btn => btn.classList.remove('active'));
    document.getElementById(`btn-${tipo}`).classList.add('active');
    renderRadarSVG();
}

function polarToCartesian(cx, cy, r, angleRad) {
    return [
        cx + r * Math.cos(angleRad),
        cy + r * Math.sin(angleRad)
    ];
}

function renderRadarSVG() {
    const svg = document.getElementById("radarSVG");
    svg.innerHTML = "";
    const config = perfilesConfig[radarType];
    const N = config.labels.length;
    const R = 135, cx = 180, cy = 180, min = 0, max = 10;
    let values = config.fields.map(f => parseInt(organo[f]) || 0);

    // 1. Malla
    for (let c = 1; c <= 5; c++) {
        let r = (R * c) / 5;
        let mesh = [];
        for (let i = 0; i < N; i++) {
            let angle = -Math.PI / 2 + (2 * Math.PI * i) / N;
            mesh.push(polarToCartesian(cx, cy, r, angle));
        }
        svg.innerHTML += `<polygon points="${mesh.map(p=>p.join(',')).join(' ')}" fill="none" stroke="#d7bebe" stroke-width="1"/>`;
    }
    // 2. L√≠neas y etiquetas
    for (let i = 0; i < N; i++) {
        let angle = -Math.PI / 2 + (2 * Math.PI * i) / N;
        let [x2, y2] = polarToCartesian(cx, cy, R, angle);
        svg.innerHTML += `<line x1="${cx}" y1="${cy}" x2="${x2}" y2="${y2}" stroke="#bfa1a1" stroke-width="1"/>`;
        let [lx, ly] = polarToCartesian(cx, cy, R+24, angle);
        svg.innerHTML += `<text x="${lx}" y="${ly}" class="radar-label">${config.labels[i]}</text>`;
    }
    // 3. Pol√≠gono real
    let poly = [];
    for (let i = 0; i < N; i++) {
        let v = values[i];
        let r = (v-min)/(max-min)*R;
        let angle = -Math.PI / 2 + (2 * Math.PI * i) / N;
        poly.push(polarToCartesian(cx, cy, r, angle));
    }
    svg.innerHTML += `<polygon points="${poly.map(p=>p.join(',')).join(' ')}" fill="rgba(128,0,0,0.17)" stroke="#800000" stroke-width="3"/>`;
    // 4. Puntos
    for (let i = 0; i < N; i++) {
        let v = values[i];
        let r = (v-min)/(max-min)*R;
        let angle = -Math.PI / 2 + (2 * Math.PI * i) / N;
        let [px, py] = polarToCartesian(cx, cy, r, angle);
        svg.innerHTML += `<circle cx="${px}" cy="${py}" r="7" fill="#800000" stroke="white" stroke-width="2"/>`;
    }
}

// ---------- Carga desde API de ficha, narrativa, puntuaci√≥n, comentarios ----------
const urlParams = new URLSearchParams(window.location.search);
const vinoId = urlParams.get("vino_id");

// Ficha del vino (imagen, nombre, etc.)
async function cargarFichaVino() {
    try {
        const fichaData = await (await fetch(`https://sommelierlab-api-production.up.railway.app/api/vino/${vinoId}` )).json();
        document.getElementById("vinoImagen").src = fichaData.imagen?.[0]?.url || "";
        document.title = document.getElementById("vinoTitulo").innerText = fichaData.nombre || "Ficha del Vino";
        document.getElementById("vinoTipo").innerText = fichaData.tipo;
        document.getElementById("vinoUva").innerText = fichaData.variedad;
        document.getElementById("vinoOrigen").innerText = fichaData.origen;
        document.getElementById("bodegaNombre").innerText = fichaData.bodega?.nombre || "";
        const redesHtml = [];
        if (fichaData.bodega?.web) redesHtml.push(`<a href="${fichaData.bodega.web}" target="_blank">üåê Web</a>`);
        if (fichaData.bodega?.facebook) redesHtml.push(`<a href="${fichaData.bodega.facebook}" target="_blank">üìò Facebook</a>`);
        if (fichaData.bodega?.instagram) redesHtml.push(`<a href="${fichaData.bodega.instagram}" target="_blank">üì∏ Instagram</a>`);
        if (fichaData.bodega?.twitter) redesHtml.push(`<a href="${fichaData.bodega.twitter}" target="_blank">üê¶ Twitter</a>`);
        document.getElementById("bodega-redes").innerHTML = redesHtml.join(" ¬∑ ");
    } catch (error) { console.error("‚ùå Error cargando la ficha del vino:", error); }
}

// Narrativa del vino
async function cargarNarrativaVino() {
    try {
        const dataCerebro = await (await fetch(`https://n8n-production-cb18.up.railway.app/webhook/consultar-vino?vino_id=${vinoId}` )).json();
        document.getElementById("respuesta").innerText = dataCerebro.narrativa || "No se pudo generar la narrativa del vino.";
    } catch (error) { console.error("‚ùå Error cargando la narrativa del vino:", error); }
}

// Perfil organol√©ptico
async function cargarPerfilOrganoleptico() {
    try {
        const response = await fetch(`https://sommelierlab-api-production.up.railway.app/api/organoleptica/${vinoId}`);
        organo = await response.json();
        setRadarType(radarType);
    } catch (err) {
        alert("No se pudo cargar el perfil organol√©ptico");
    }
}

// Puntuaci√≥n, valoraciones y comentarios (puedes conectar tu API igual que antes)

// --- Inicializa todo ---
document.addEventListener("DOMContentLoaded", () => {
    if (!vinoId) {
        document.getElementById("respuesta").innerText = "No se especific√≥ ning√∫n vino.";
        return;
    }
    cargarFichaVino();
    cargarNarrativaVino();
    cargarPerfilOrganoleptico();
});
</script>
    <div id="score-container">
        <h3>Puntuaci√≥n Total</h3>
        <div id="score-bar"><div id="score-fill" style="width: 0%">0</div></div>
        <div id="rating-summary" style="display: flex; align-items: center; gap: 0.5rem; margin-top: 1rem;">
           <span id="media-nota" style="font-size:2rem; font-weight:bold;">-</span>
           <span id="estrellas-nota" style="font-size:1.5rem; color: #800000;"></span>
           <span id="total-valoraciones" style="font-size:1rem; color:#555;"></span>
        </div>
    </div>

    <div id="valoracion-container">
        <h3>Valora este vino</h3>
        <div id="estrellas">
            <span class="estrella" data-value="1">‚òÖ</span><span class="estrella" data-value="2">‚òÖ</span><span class="estrella" data-value="3">‚òÖ</span><span class="estrella" data-value="4">‚òÖ</span><span class="estrella" data-value="5">‚òÖ</span>
        </div>
        <textarea id="comentario" placeholder="Deja un comentario sobre el vino..." rows="4" style="width:100%; margin-top: 1rem; padding: 0.5rem;"></textarea>
        <button id="enviar-valoracion" style="margin-top: 1rem; background:#800000; color:white; border:none; padding:0.5rem 1rem; border-radius:0.5rem; cursor:pointer;">Enviar valoraci√≥n</button>
        <p id="mensaje-valoracion" style="margin-top:1rem; color: green;"></p>
    </div>
    
    <div id="comentarios-container" style="margin-top: 3rem;">
        <h3 style="cursor:pointer; color:#800000;" onclick="toggleComentarios()">‚ñº Comentarios de otros usuarios</h3>
        <div id="lista-comentarios" style="max-height: 0; overflow: hidden; transition: max-height 0.5s ease-out;">
            <p style="padding: 1rem 0;">Cargando comentarios...</p>
        </div>
    </div>

    <script>
    // --------------------- BLOQUE DE VALORACIONES Y COMENTARIOS ---------------------
    let puntuacionSeleccionada = 0;
    document.addEventListener("DOMContentLoaded", () => {
        // Estrellas
        document.querySelectorAll(".estrella").forEach(e => {
            e.addEventListener("click", () => {
                puntuacionSeleccionada = parseInt(e.dataset.value);
                document.querySelectorAll(".estrella").forEach(star => {
                    star.classList.toggle("seleccionada", parseInt(star.dataset.value) <= puntuacionSeleccionada);
                });
            });
        });

        // Enviar valoraci√≥n
        document.getElementById("enviar-valoracion").addEventListener("click", async () => {
            const comentario = document.getElementById("comentario").value || "";
            const mensaje = document.getElementById("mensaje-valoracion");
            if (!puntuacionSeleccionada) {
                mensaje.innerText = "Por favor, selecciona una puntuaci√≥n (de 1 a 5 estrellas).";
                mensaje.style.color = "red";
                return;
            }
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const vinoId = urlParams.get("vino_id");
                await fetch("https://n8n-production-cb18.up.railway.app/webhook/comentar-vino", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        vino_id: vinoId,
                        puntuacion: puntuacionSeleccionada,
                        comentario: comentario,
                        user_id: localStorage.getItem("user_id") || "user_" + Math.random().toString(36).substring(2, 10),
                        ciudad: window._datosUsuario?.ciudad || "Desconocida",
                        pais: window._datosUsuario?.pais || "Desconocido",
                        idioma: window._datosUsuario?.idioma || "es"
                    })
                });
                mensaje.innerText = "¬°Gracias por tu valoraci√≥n!";
                mensaje.style.color = "green";
            } catch (err) {
                mensaje.innerText = "Error al enviar tu valoraci√≥n.";
                mensaje.style.color = "red";
            }
        });
    });

    // Comentarios: animar/desplegar
    function toggleComentarios() {
        const listaComentariosEl = document.getElementById("lista-comentarios");
        if (listaComentariosEl.style.maxHeight === "0px" || !listaComentariosEl.style.maxHeight) {
            listaComentariosEl.style.maxHeight = listaComentariosEl.scrollHeight + "px";
        } else {
            listaComentariosEl.style.maxHeight = "0px";
        }
    }
    </script>
</body>
</html>
