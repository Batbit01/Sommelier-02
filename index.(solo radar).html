<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
  <title id="vinoTitle">Ficha del Vino</title>
  <style>
    body { font-family: sans-serif; padding: 2rem; background-color: #fefefe; color: #222; max-width: 700px; margin: auto; }
    .vino-ficha img { width: 100%; max-height: 300px; object-fit: contain; border-radius: 1rem; }
    .vino-dato { margin-bottom: 1rem; }
    .vino-dato strong { display: inline-block; width: 100px; }
    #respuesta { margin-top: 2rem; font-style: italic; background: #f1f1f1; padding: 1rem; border-radius: 0.5rem; }
    #hablar { display: inline-block; margin-top: 2rem; padding: 0.75rem 1.5rem; background: #800000; color: white; border: none; border-radius: 1rem; cursor: pointer; transition: background .2s; font-weight: bold;}
    #hablar[disabled] { background: #a09797; color: #fff; cursor: not-allowed; }
    #modulo-compartir {
      margin: 2rem 0 0.5rem 0;
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
    }
    #btn-compartir {
      background: #fff;
      color: #800000;
      border: 2px solid #800000;
      border-radius: 2rem;
      padding: 0.5rem 1.25rem 0.5rem 0.75rem;
      font-weight: 600;
      font-size: 1.07rem;
      display: flex;
      align-items: center;
      gap: 0.55rem;
      cursor: pointer;
      transition: background 0.2s, box-shadow 0.2s;
      box-shadow: 0 2px 6px #80000011;
    }
    #btn-compartir:hover {
      background: #f8eaea;
      box-shadow: 0 4px 12px #8000001a;
    }
    #btn-compartir svg { flex-shrink: 0; }
    #menu-compartir {
      display: none;
      position: absolute;
      top: 110%;
      left: 0;
      background: #fff;
      border: 1.5px solid #e5dede;
      border-radius: 1.3rem;
      box-shadow: 0 6px 28px #80000012;
      min-width: 240px;
      padding: 0.5rem 0;
      z-index: 40;
      animation: fadeInCompartir 0.32s;
      transition: opacity 0.22s, transform 0.2s;
    }
    @keyframes fadeInCompartir {
      from { opacity: 0; transform: translateY(12px);}
      to { opacity: 1; transform: translateY(0);}
    }
    #menu-compartir.open { display: block; }
    .menu-item-compartir {
      display: flex;
      align-items: center;
      gap: 0.7rem;
      padding: 0.62rem 1.1rem;
      cursor: pointer;
      color: #700d18;
      font-size: 1.02rem;
      background: none;
      border: none;
      width: 100%;
      transition: background 0.17s, color 0.17s;
    }
    .menu-item-compartir:hover, .menu-item-compartir:focus {
      background: #f8eaea;
      color: #c9003f;
      outline: none;
    }
    .menu-item-compartir svg {
      width: 1.35em; height: 1.35em; display: block;
    }
    .menu-item-compartir.copiado {
      color: #218838;
      font-weight: 600;
    }
    #radar-svg-container {
      width: 100%;
      max-width: 520px;
      margin: 0 auto 2.5rem auto;
      background: #f8f4f2;
      border-radius: 22px;
      box-shadow: 0 2px 24px #0001;
      padding: 2.5rem 0 2.5rem 0;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .switch-buttons {
      display: flex;
      justify-content: center;
      gap: 0.7rem;
      margin-bottom: 1.6rem;
    }
    .switch-buttons button {
      background-color: #a97c7c;
      color: white;
      border: 2px solid #800000;
      padding: 0.65rem 1.25rem;
      border-radius: 20px;
      cursor: pointer;
      transition: all 0.3s;
      font-weight: bold;
    }
    .switch-buttons button:hover {
      background-color: #800000;
    }
    .switch-buttons button.active {
      background-color: #800000;
      box-shadow: 0 0 10px rgba(128,0,0,0.5 );
    }
    #radarSVG {
      background: none;
      display: block;
      margin: 0 auto;
    }
    .radar-label {
      font-size: 1rem;
      font-weight: bold;
      fill: #800000;
      text-anchor: middle;
      alignment-baseline: middle;
      pointer-events: none;
    }
    #score-container, #valoracion-container { margin-top: 3rem; }
    #score-bar { width: 100%; height: 20px; background-color: #ddd; border-radius: 10px; overflow: hidden; }
    #score-fill { height: 100%; background-color: #800000; text-align: center; line-height: 20px; color: white; font-size: 0.9rem; }
    #estrellas .estrella { font-size: 2rem; color: #ccc; cursor: pointer; }
    #estrellas .estrella.seleccionada { color: #800000; }
    #estrellas-nota { color: #800000; font-size: 1.8rem; vertical-align: middle; }
    #lista-comentarios .comentario { margin-bottom: 1rem; padding: 0.75rem; border: 1px solid #ddd; border-radius: 0.5rem; background-color: #fafafa; text-align: left; }
    /* Módulo sommelier candado */
    #modulo-sommelier { margin-bottom: 2.3rem; }
    #modulo-sommelier #sommelier-aviso {
      margin-top:0.7rem; color:#7b7171; background:#f7f3f0; padding:1rem 1.2rem;
      border-radius:1.1rem; font-size:1.07rem; display:flex; align-items:center; gap:0.7rem;
    }
    /* Redes sociales minimalistas */
    .redes-sociales {
      display: flex;
      gap: 1rem;
      margin-top: 0.35rem;
      justify-content: flex-start;
      align-items: center;
      overflow-x: auto;
      padding-bottom: 0.05rem;
      -webkit-overflow-scrolling: touch;
    }
    .red-social-icon {
      width: 2.3em;
      height: 2.3em;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      background: #f9f9fb;
      box-shadow: 0 1px 8px #0001;
      transition: transform .23s cubic-bezier(.56,0,.45,1.5), background 0.18s;
      cursor: pointer;
      border: none;
      outline: none;
      will-change: transform;
      font-size: 1em;
      flex-shrink: 0;
      position: relative;
    }
    .red-social-icon:active, .red-social-icon:hover {
      transform: scale(1.13) rotate(-18deg);
      background: #ededf2;
    }
    .red-social-icon svg {
      width: 1.32em;
      height: 1.32em;
      display: block;
      stroke: #111;
      stroke-width: 1.55;
    }
    .red-social-tooltip {
      visibility: hidden;
      background: #212121e0;
      color: #fff;
      border-radius: 0.7em;
      font-size: 0.99em;
      padding: 0.29em 0.68em;
      position: absolute;
      bottom: -2.25em;
      left: 50%;
      transform: translateX(-50%);
      opacity: 0;
      pointer-events: none;
      z-index: 12;
      transition: opacity 0.17s, visibility 0.17s;
      white-space: nowrap;
    }
    .red-social-icon:focus .red-social-tooltip,
    .red-social-icon:hover .red-social-tooltip {
      visibility: visible;
      opacity: 1;
    }
    @media (hover: hover) {
      .red-social-icon:hover svg {
        stroke: #800000;
      }
    }
  </style>
</head>
<body>
  <h1 id="vinoTitulo">Ficha del Vino</h1>
  <div class="vino-ficha">
    <img alt="Imagen del vino" id="vinoImagen" src=""/>
    <div class="vino-dato"><strong>Tipo:</strong> <span id="vinoTipo">-</span></div>
    <div class="vino-dato"><strong>Origen:</strong> <span id="vinoOrigen">-</span></div>
    <div class="vino-dato"><strong>Variedad:</strong> <span id="vinoUva">-</span></div>
    <div class="vino-dato"><strong>Bodega:</strong> <span id="bodegaNombre">-</span></div>
    <div class="vino-dato">
      <div class="redes-sociales" id="bodega-redes"></div>
    </div>
  </div>
  
  <div id="modulo-compartir">
    <button id="btn-compartir">
      <svg viewBox="0 0 24 24" width="20" height="20" style="margin-right:0.5em;"><path d="M14 4V2h-4v2h4zM7 10.53l-1.42-1.42C2.64 12.16 4.52 18.64 9.9 19.75c.55.11 1.11.17 1.67.17 4.91 0 8.43-5.07 7.04-9.72l-1.42 1.42C17.35 15.17 14.49 17 12 17s-5.35-1.83-5-4.47z" fill="#800000"/></svg>
      Compartir ficha
    </button>
    <div id="menu-compartir" class="">
      <!-- Opciones se renderizan por JS -->
    </div>
  </div>

  <div id="radar-svg-container">
    <h3>Perfil organoléptico</h3>
    <div class="switch-buttons">
      <button id="btn-aromatico" class="active" onclick="renderRadar('aromatico')">Aromático</button>
      <button id="btn-gustativo" onclick="renderRadar('gustativo')">Gustativo</button>
      <button id="btn-sensorial" onclick="renderRadar('sensorial')">Sensorial</button>
    </div>
    <svg id="radarSVG" width="320" height="320" viewBox="0 0 320 320"></svg>
  </div>

  <div id="modulo-sommelier">
    <button id="hablar">Hablar con el sommelier</button>
    <div id="sommelier-aviso" style="display:none;">
      <svg width="28" height="28" viewBox="0 0 24 24" fill="none"><circle cx="12" cy="12" r="10" fill="#bbb"/><path d="M12 7v4m0 4h.01" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
      Para vivir la experiencia completa con el sommelier, escanea el QR en la botella.
    </div>
  </div>
  <div id="respuesta">Cargando descripción del vino...</div>
  
  <div id="score-container">
    <h3>Puntuación Total</h3>
    <div id="score-bar"><div id="score-fill" style="width: 0%">0</div></div>
    <div id="rating-summary" style="display: flex; align-items: center; gap: 0.5rem; margin-top: 1rem;">
      <span id="media-nota" style="font-size:2rem; font-weight:bold;">-</span>
      <span id="estrellas-nota" style="font-size:1.5rem; color: #800000;"></span>
      <span id="total-valoraciones" style="font-size:1rem; color:#555;"></span>
    </div>
  </div>
  <div id="valoracion-container">
    <h3>Valora este vino</h3>
    <div id="estrellas">
      <span class="estrella" data-value="1">★</span><span class="estrella" data-value="2">★</span><span class="estrella" data-value="3">★</span><span class="estrella" data-value="4">★</span><span class="estrella" data-value="5">★</span>
    </div>
    <textarea id="comentario" placeholder="Deja un comentario sobre el vino..." rows="4" style="width:100%; margin-top: 1rem; padding: 0.5rem;"></textarea>
    <button id="enviar-valoracion" style="margin-top: 1rem; background:#800000; color:white; border:none; padding:0.5rem 1rem; border-radius:0.5rem; cursor:pointer;">Enviar valoración</button>
    <p id="mensaje-valoracion" style="margin-top:1rem; color: green;"></p>
  </div>
  <div id="comentarios-container" style="margin-top: 3rem;">
    <h3 style="cursor:pointer; color:#800000;" onclick="toggleComentarios()">▼ Comentarios de otros usuarios</h3>
    <div id="lista-comentarios" style="max-height: 0; overflow: hidden; transition: max-height 0.5s ease-out;">
      <p style="padding: 1rem 0;">Cargando comentarios...</p>
    </div>
  </div>
<script>
/* --- ICONOS OUTLINE MINIMALISTAS (Apple-style) --- */
const iconosRedes = {
  web: `<svg viewBox="0 0 24 24" fill="none"><circle cx="12" cy="12" r="9" stroke="currentColor"/><ellipse cx="12" cy="12" rx="6.5" ry="9" stroke="currentColor"/><line x1="3" y1="12" x2="21" y2="12" stroke="currentColor"/></svg>`,
  facebook: `<svg viewBox="0 0 24 24" fill="none"><circle cx="12" cy="12" r="9" stroke="currentColor"/><path d="M13.8 18v-6h2.1l.3-2.2H13.8V8.2c0-.7.2-1.1 1.1-1.1H16V5.2A21 21 0 0 0 14.5 5c-2 0-3 1-3 2.8v2H9.2v2.2h2.3V18h2.3z" stroke="currentColor" fill="none"/></svg>`,
  instagram: `<svg viewBox="0 0 24 24" fill="none"><rect x="5" y="5" width="14" height="14" rx="5" stroke="currentColor"/><circle cx="12" cy="12" r="4.2" stroke="currentColor"/><circle cx="16.2" cy="7.8" r="1.1" fill="currentColor"/></svg>`,
  twitter: `<svg viewBox="0 0 24 24" fill="none"><circle cx="12" cy="12" r="9" stroke="currentColor"/><path d="M7.5 16.5c7 0 10.9-5.8 10.9-10.9 0-.2 0-.3 0-.5A7.8 7.8 0 0 0 21 3.5a7.7 7.7 0 0 1-2.2.6A3.8 3.8 0 0 0 20.4 2a7.5 7.5 0 0 1-2.4.9A3.8 3.8 0 0 0 12 6.6a10.7 10.7 0 0 1-7.8-4 3.8 3.8 0 0 0 1.2 5.1A3.8 3.8 0 0 1 3 7.3v.1a3.8 3.8 0 0 0 3 3.7 3.8 3.8 0 0 1-1.7.1 3.8 3.8 0 0 0 3.5 2.7A7.7 7.7 0 0 1 3 15.6a10.8 10.8 0 0 0 5.5 1.6" stroke="currentColor" fill="none"/></svg>`,
  youtube: `<svg viewBox="0 0 24 24" fill="none"><rect x="4" y="8" width="16" height="8" rx="3" stroke="currentColor"/><polygon points="11,10 16,12 11,14" fill="currentColor"/></svg>`,
  tiktok: `<svg viewBox="0 0 24 24" fill="none"><circle cx="12" cy="12" r="9" stroke="currentColor"/><path d="M15 8v6.6a2.4 2.4 0 1 1-2-2.3V8a4 4 0 0 0 2 0z" stroke="currentColor" fill="none"/><circle cx="15.7" cy="7.2" r="0.5" fill="currentColor"/></svg>`,
  linkedin: `<svg viewBox="0 0 24 24" fill="none"><rect x="4" y="4" width="16" height="16" rx="4" stroke="currentColor"/><rect x="7" y="10" width="2.3" height="6" rx="1" fill="currentColor"/><rect x="11" y="10" width="2.3" height="6" rx="1" fill="currentColor"/><circle cx="8.3" cy="8.3" r="1" fill="currentColor"/></svg>`,
  pinterest: `<svg viewBox="0 0 24 24" fill="none"><circle cx="12" cy="12" r="9" stroke="currentColor"/><path d="M12 8a4 4 0 0 1 1 7.9c-.14-.13-.15-.35-.1-.5.1-.3.7-2.4.7-2.8 0-.4-.2-.7-.7-.7-.6 0-1.1.7-1.1 1.6 0 .6.2 1 .2 1 .1.2 0 .3-.1.3-.2 0-.9-.4-.9-1.5 0-1.2.8-2 2-2s1.6.7 1.6 1.5c0 .7-.3 1.2-.8 1.2-.2 0-.4-.2-.4-.5 0-.1 0-.2 0-.3 0-.1.2-.3.3-.6.1-.2.2-.5.2-.8 0-1.1-.9-2-2-2z" stroke="currentColor" fill="none"/></svg>`
};

/* --- Función para redes sociales con tooltip --- */
function renderRedesSociales(bodega) {
  const nombres = {
    web: "Web oficial", facebook: "Facebook", instagram: "Instagram", twitter: "Twitter/X",
    youtube: "YouTube", tiktok: "TikTok", linkedin: "LinkedIn", pinterest: "Pinterest"
  };
  const redes = [];
  for(const [key, svg] of Object.entries(iconosRedes)) {
    if(bodega[key]) {
      redes.push(`
        <a class="red-social-icon" href="${bodega[key]}" target="_blank" rel="noopener noreferrer" aria-label="${nombres[key]||key}">
          ${svg}
          <span class="red-social-tooltip">${nombres[key]||key}</span>
        </a>`);
    }
  }
  return redes.join('');
}

/* --- Resto de JS de la ficha, radar, comentarios, compartir, etc --- */
document.addEventListener("DOMContentLoaded", () => {
  let organo = {};
  let puntuacionSeleccionada = 0;
  const urlParams = new URLSearchParams(window.location.search);
  const vinoId = urlParams.get("vino_id");
  const esQR = urlParams.get("qr") === "1";

  // Compartir
  const iconosCompartir = {
    whatsapp: `<svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="12" fill="#25d366"/><path d="M6.6 17.6l.8-3a7 7 0 1 1 2.2 2.2l-3 .8zm5.4-13.6a9 9 0 1 0 0 18 8.97 8.97 0 0 0 4.6-1.3l.3.1 1.6.4-.4-1.5c.2-.3.3-.6.5-.9A9 9 0 0 0 12 4zm0 16a7.96 7.96 0 0 1-4-1.1l-.3-.2-2.4.6.6-2.3-.2-.3A8 8 0 1 1 20 12a8 8 0 0 1-8 8zm4.7-6.2l-.5-.2a8.9 8.9 0 0 1-2.4-.7c-.5-.2-.9-.3-1.3-.5-.4-.2-.8-.4-1.2-.7l-.1-.1a5.5 5.5 0 0 1-1.5-1.7c-.2-.4-.4-.8-.5-1.2 0-.2.1-.4.2-.5l.3-.3c.1-.1.2-.2.3-.1l.3.1c.1.1.2.1.3.2.2.1.4.2.6.3.2.1.3.2.4.3.2.2.4.5.7.8.3.4.6.7.9.9.2.2.5.3.7.4.2.1.4.2.6.2.1 0 .2 0 .3-.1l.3-.2c.1-.1.2-.3.1-.4l-.1-.3a2.9 2.9 0 0 0-.5-1.2 6 6 0 0 0-1.2-1.2c-.1-.1-.3-.2-.4-.3a2.9 2.9 0 0 0-1.3-.4l-.3-.1c-.2 0-.4.1-.5.2l-.3.3a.6.6 0 0 0-.2.5c0 .2.1.4.2.5l.1.2a9.3 9.3 0 0 0 1.7 2.2c.4.4.8.7 1.3 1 .4.2.8.4 1.2.5.5.2 1 .3 1.4.5.3.1.6.2.9.2h.2c.1 0 .2 0 .2-.1l.3-.2c.1-.1.2-.2.1-.4z" fill="#fff"/></svg>`,
    telegram: `<svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="12" fill="#0088cc"/><path d="M18 7l-2.5 10.1c-.1.4-.6.6-1 .5-.2 0-.3-.1-.5-.2L11 16.3l-1.8.6a.75.75 0 0 1-.9-.3.7.7 0 0 1-.1-.7l2.5-10.1c.1-.4.6-.6 1-.5.2 0 .3.1.5.2l5.7 2.2c.4.1.6.6.5 1z" fill="#fff"/></svg>`,
    instagram: iconosRedes.instagram,
    gmail: `<svg viewBox="0 0 24 24"><rect x="2" y="5" width="20" height="14" rx="2" fill="#fff" stroke="#c53a23" stroke-width="1.4"/><path d="M3 6l9 7 9-7" fill="none" stroke="#c53a23" stroke-width="1.2"/></svg>`,
    pocket: `<svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="12" fill="#fff"/><path d="M18 7v6.1a6 6 0 0 1-12 0V7" stroke="#EF3F56" stroke-width="2" fill="none"/><path d="M8 12l4 4 4-4" stroke="#EF3F56" stroke-width="2" fill="none"/></svg>`,
    beeper: `<svg viewBox="0 0 24 24"><rect width="24" height="24" rx="5" fill="#181A20"/><path d="M16.5 8.6a.8.8 0 0 0-1.13 0l-2.4 2.4-2.4-2.4a.8.8 0 0 0-1.13 1.13l2.4 2.4-2.4 2.4a.8.8 0 1 0 1.13 1.13l2.4-2.4 2.4 2.4a.8.8 0 1 0 1.13-1.13l-2.4-2.4 2.4-2.4a.8.8 0 0 0 0-1.13z" fill="#fff"/></svg>`,
    facebook: iconosRedes.facebook,
    twitter: iconosRedes.twitter,
    youtube: iconosRedes.youtube,
    tiktok: iconosRedes.tiktok,
    linkedin: iconosRedes.linkedin,
    pinterest: iconosRedes.pinterest,
    copiar: `<svg viewBox="0 0 24 24"><rect x="7" y="7" width="13" height="13" rx="2" fill="#bfa1a1"/><rect x="3" y="3" width="13" height="13" rx="2" fill="#800000"/></svg>`
  };
  const opcionesCompartir = [
    { id: 'whatsapp', label: 'WhatsApp', url: link => `https://wa.me/?text=${encodeURIComponent(link)}` },
    { id: 'telegram', label: 'Telegram', url: link => `https://t.me/share/url?url=${encodeURIComponent(link)}` },
    { id: 'instagram', label: 'Instagram', url: link => `https://www.instagram.com/?url=${encodeURIComponent(link)}` },
    { id: 'gmail', label: 'Gmail', url: link => `mailto:?body=${encodeURIComponent(link)}&subject=¡Descubre este vino!` },
    { id: 'pocket', label: 'Pocket', url: link => `https://getpocket.com/save?url=${encodeURIComponent(link)}` },
    { id: 'beeper', label: 'Beeper', url: link => `https://beeper.com/share?url=${encodeURIComponent(link)}` },
    { id: 'facebook', label: 'Facebook', url: link => `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(link)}` },
    { id: 'twitter', label: 'X (Twitter)', url: link => `https://twitter.com/intent/tweet?url=${encodeURIComponent(link)}&text=¡Descubre este vino en SommelierLab!` },
    { id: 'youtube', label: 'YouTube', url: link => `https://www.youtube.com/share?url=${encodeURIComponent(link)}` },
    { id: 'tiktok', label: 'TikTok', url: link => `https://www.tiktok.com/share?url=${encodeURIComponent(link)}` },
    { id: 'linkedin', label: 'LinkedIn', url: link => `https://www.linkedin.com/shareArticle?mini=true&url=${encodeURIComponent(link)}` },
    { id: 'pinterest', label: 'Pinterest', url: link => `https://pinterest.com/pin/create/button/?url=${encodeURIComponent(link)}` },
    { id: 'copiar', label: 'Copiar enlace', url: link => null }
  ];
  const btnCompartir = document.getElementById('btn-compartir');
  const menuCompartir = document.getElementById('menu-compartir');
  function crearOpcion(opc) {
    const el = document.createElement('button');
    el.className = 'menu-item-compartir';
    el.innerHTML = `${iconosCompartir[opc.id] || ""}<span>${opc.label}</span>`;
    el.tabIndex = 0;
    el.onclick = (e) => {
      e.preventDefault(); e.stopPropagation();
      // Siempre quitamos qr=1 para que lo compartido nunca sea PRO
      const urlActual = window.location.href.replace(/[?#].*$/, '') + window.location.search.replace(/[&?]qr=1/gi, '').replace(/([?&])$/, '');
      if(opc.id === 'copiar') {
        navigator.clipboard.writeText(urlActual);
        el.classList.add("copiado");
        el.innerHTML = iconosCompartir.copiar + "<span>¡Enlace copiado!</span>";
        setTimeout(() => {
          el.classList.remove("copiado");
          el.innerHTML = iconosCompartir.copiar + "<span>Copiar enlace</span>";
          menuCompartir.classList.remove("open");
        }, 1200);
      } else {
        window.open(opc.url(urlActual), '_blank');
        menuCompartir.classList.remove("open");
      }
    };
    return el;
  }
  function renderizarMenuCompartir() {
    menuCompartir.innerHTML = '';
    opcionesCompartir.forEach(opc => {
      menuCompartir.appendChild(crearOpcion(opc));
    });
  }
  btnCompartir.onclick = function(e) {
    e.stopPropagation();
    if(menuCompartir.classList.contains('open')) {
      menuCompartir.classList.remove('open');
    } else {
      renderizarMenuCompartir();
      menuCompartir.classList.add('open');
    }
  };
  document.addEventListener('click', function(e){
    if(menuCompartir.classList.contains('open')) {
      menuCompartir.classList.remove('open');
    }
  });
  document.addEventListener('keydown', function(e){
    if(e.key==="Escape") menuCompartir.classList.remove('open');
  });

  // Radar SVG
  const radarSVG = document.getElementById("radarSVG");
  const perfiles = {
    aromatico: { labels: ["Fruta", "Floral", "Especiado", "Tostado", "Herbáceo"], lados: 5 },
    gustativo: { labels: ["Cuerpo", "Acidez", "Dulzor", "Taninos", "Frescura", "Mineralidad"], lados: 6 },
    sensorial: { labels: ["Persistencia", "Complejidad", "Astringencia", "Alcohol", "Armonía"], lados: 5 }
  };
  let radarActivo = "aromatico";
  window.renderRadar = function(tipo) {
    radarActivo = tipo;
    document.querySelectorAll('.switch-buttons button').forEach(btn => btn.classList.remove('active'));
    document.getElementById(`btn-${tipo}`).classList.add('active');
    renderRadarSVG(tipo);
  }
  function renderRadarSVG(tipo) {
    const datos = organo;
    const { labels, lados } = perfiles[tipo];
    const valores = labels.map(lab => (organo[toKey(lab)] ?? 0));
    // SVG clean
    radarSVG.innerHTML = '';
    const size = 320, radio = 110, centro = size / 2, niveles = 5;
    // Círculos de fondo
    for(let lvl=1; lvl<=niveles; lvl++){
      const r = radio * lvl/ niveles;
      radarSVG.innerHTML += `<circle cx="${centro}" cy="${centro}" r="${r}" fill="none" stroke="#d7b6b6" stroke-width="1"/>`;
    }
    // Ejes y labels
    for(let i=0; i<lados; i++){
      const ang = (Math.PI*2/lados)*i - Math.PI/2;
      const x = centro + radio*Math.cos(ang);
      const y = centro + radio*Math.sin(ang);
      radarSVG.innerHTML += `<line x1="${centro}" y1="${centro}" x2="${x}" y2="${y}" stroke="#e9dada" stroke-width="1"/>`;
      // Label
      const lx = centro + (radio+24)*Math.cos(ang);
      const ly = centro + (radio+24)*Math.sin(ang)+6;
      radarSVG.innerHTML += `<text class="radar-label" x="${lx}" y="${ly}">${labels[i]}</text>`;
    }
    // Polígono
    let points = "";
    for(let i=0; i<lados; i++){
      const val = Math.max(0,Math.min(10,parseFloat(valores[i]||0)));
      const ang = (Math.PI*2/lados)*i - Math.PI/2;
      const rVal = radio * (val/10);
      const px = centro + rVal * Math.cos(ang);
      const py = centro + rVal * Math.sin(ang);
      points += `${px},${py} `;
    }
    radarSVG.innerHTML += `<polygon points="${points.trim()}" fill="rgba(128,0,0,0.21)" stroke="#800000" stroke-width="2"/>`;
    // Punto central
    radarSVG.innerHTML += `<circle cx="${centro}" cy="${centro}" r="4.8" fill="#800000"/>`;
  }
  function toKey(str){
    return str.toLowerCase().replace(/á/g,"a").replace(/é/g,"e").replace(/í/g,"i").replace(/ó/g,"o").replace(/ú/g,"u").replace(/ñ/g,"n").replace(/\s/g,"_");
  }

  function calcularPuntuacionTotal() {
    let total = 0;
    for (const key in organo) total += parseInt(organo[key]) || 0;
    const maxScore = Object.keys(organo).length * 10;
    const porcentaje = maxScore > 0 ? Math.round((total / maxScore) * 100) : 0;
    const fill = document.getElementById("score-fill");
    fill.style.width = porcentaje + "%";
    fill.innerText = porcentaje + " / 100";
  }
  function renderEstrellas(nota) {
    const contenedor = document.getElementById("estrellas-nota");
    contenedor.innerHTML = "";
    const estrellas = Math.floor(nota);
    const media = nota - estrellas;
    for (let i = 1; i <= 5; i++) {
      if (i <= estrellas) contenedor.innerHTML += "★";
      else if (i === estrellas + 1 && media >= 0.25 && media < 0.75) contenedor.innerHTML += "⯪";
      else contenedor.innerHTML += "☆";
    }
  }

  async function cargarFichaVino() {
    try {
      const fichaData = await (await fetch(`https://sommelierlab-api-production.up.railway.app/api/vino/${vinoId}` )).json();
      document.getElementById("vinoImagen").src = fichaData.imagen?.[0]?.url || "";
      document.title = document.getElementById("vinoTitulo").innerText = fichaData.nombre || "Ficha del Vino";
      document.getElementById("vinoTipo").innerText = fichaData.tipo;
      document.getElementById("vinoUva").innerText = fichaData.variedad;
      document.getElementById("vinoOrigen").innerText = fichaData.origen;
      document.getElementById("bodegaNombre").innerText = fichaData.bodega?.nombre || "";
      document.getElementById("bodega-redes").innerHTML = renderRedesSociales(fichaData.bodega || {});
    } catch (error) { console.error("❌ Error cargando la ficha del vino:", error); }
  }

  async function cargarPerfilOrganoleptico() {
    try {
      organo = await (await fetch(`https://sommelierlab-api-production.up.railway.app/api/organoleptica/${vinoId}` )).json();
      renderRadar(radarActivo);
      calcularPuntuacionTotal();
    } catch (error) { console.error("❌ Error cargando el perfil organoléptico:", error); }
  }

  async function cargarNarrativaVino() {
    try {
      const dataCerebro = await (await fetch(`https://n8n-production-cb18.up.railway.app/webhook/consultar-vino?vino_id=${vinoId}` )).json();
      document.getElementById("respuesta").innerText = dataCerebro.narrativa || "No se pudo generar la narrativa del vino.";
    } catch (error) { console.error("❌ Error cargando la narrativa del vino:", error); }
  }

  async function cargarResumenValoraciones() {
    try {
      const data = await (await fetch(`https://n8n-production-cb18.up.railway.app/webhook/consultar-valoraciones?vino_id=${vinoId}` )).json();
      if (data.total_valoraciones > 0) {
        document.getElementById("rating-summary").style.display = "flex";
        document.getElementById("media-nota").innerText = data.nota_media.toFixed(1);
        renderEstrellas(data.nota_media);
        document.getElementById("total-valoraciones").innerText = `(${data.total_valoraciones} valoraciones)`;
      }
    } catch (error) { console.error("Error al cargar resumen de valoraciones:", error); }
  }

  // --- COMENTARIOS ---
  const listaComentariosEl = document.getElementById("lista-comentarios");
  window.toggleComentarios = function() {
    if (listaComentariosEl.style.maxHeight === "0px" || !listaComentariosEl.style.maxHeight) {
      listaComentariosEl.style.maxHeight = listaComentariosEl.scrollHeight + "px";
    } else {
      listaComentariosEl.style.maxHeight = "0px";
    }
  }
  function formatearFecha(fechaStr) {
    return new Date(fechaStr).toLocaleDateString("es-ES", { year: "numeric", month: "long", day: "numeric" });
  }
  async function cargarComentarios() {
    try {
      const data = await (await fetch(`https://n8n-production-cb18.up.railway.app/webhook/consultar-comentarios?vino_id=${vinoId}` )).json();
      const comentarios = Array.isArray(data.comentarios) ? data.comentarios : Array.isArray(data) ? data : [];
      listaComentariosEl.innerHTML = "";
      if (comentarios.length === 0) {
        listaComentariosEl.innerHTML = '<p style="padding: 1rem 0;">No hay comentarios aún. ¡Sé el primero en opinar!</p>';
      } else {
        comentarios.slice(0, 10).forEach(c => {
          const div = document.createElement("div");
          div.className = "comentario";
          div.innerHTML = `<strong style="color:#800000;">${c.ciudad || "Usuario anónimo"}</strong> · <span style="color: #666;">${formatearFecha(c.fecha)}</span>  
<em>“${c.comentario}”</em>`;
          listaComentariosEl.appendChild(div);
        });
      }
      if (listaComentariosEl.style.maxHeight !== "0px" && listaComentariosEl.style.maxHeight !== "") {
        listaComentariosEl.style.maxHeight = listaComentariosEl.scrollHeight + "px";
      }
    } catch (error) {
      console.error("Error al cargar o procesar comentarios:", error);
      listaComentariosEl.innerHTML = "<p>No se pudieron cargar los comentarios.</p>";
    }
  }

  // --- INICIALIZACIÓN Y EVENTOS ---
  if (!vinoId) {
    document.getElementById("respuesta").innerText = "No se especificó ningún vino.";
    return;
  }

  fetch("https://ipapi.co/json/")
    .then(response => response.json())
    .then(data => {
      window._datosUsuario = { ciudad: data.city, pais: data.country_name, idioma: navigator.language };
    })
    .catch(error => {
      console.warn("No se pudo obtener geolocalización:", error);
      window._datosUsuario = {};
    })
    .finally(() => {
      document.querySelectorAll(".estrella").forEach(e => {
        e.addEventListener("click", () => {
          puntuacionSeleccionada = parseInt(e.dataset.value);
          document.querySelectorAll(".estrella").forEach(star => {
            star.classList.toggle("seleccionada", parseInt(star.dataset.value) <= puntuacionSeleccionada);
          });
        });
      });
      document.getElementById("enviar-valoracion").addEventListener("click", async () => {
        const comentario = document.getElementById("comentario").value || "";
        const mensaje = document.getElementById("mensaje-valoracion");
        if (!puntuacionSeleccionada) {
          mensaje.innerText = "Por favor, selecciona una puntuación (de 1 a 5 estrellas).";
          mensaje.style.color = "red";
          return;
        }
        try {
          await fetch("https://n8n-production-cb18.up.railway.app/webhook/comentar-vino", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              vino_id: vinoId,
              puntuacion: puntuacionSeleccionada,
              comentario: comentario,
              user_id: localStorage.getItem("user_id" ) || "user_" + Math.random().toString(36).substring(2, 10),
              ciudad: window._datosUsuario?.ciudad || "Desconocida",
              pais: window._datosUsuario?.pais || "Desconocido",
              idioma: window._datosUsuario?.idioma || "es"
            })
          });
          mensaje.innerText = "¡Gracias por tu valoración!";
          mensaje.style.color = "green";
        } catch (err) {
          mensaje.innerText = "Error al enviar tu valoración.";
          mensaje.style.color = "red";
        }
      });

      // SOMMELIER ACCESO PRO O BLOQUEADO SEGÚN QR
      const btnHablar = document.getElementById("hablar");
      const avisoSommelier = document.getElementById("sommelier-aviso");
      if (esQR) {
        btnHablar.disabled = false;
        btnHablar.style.opacity = 1;
        btnHablar.style.pointerEvents = "auto";
        avisoSommelier.style.display = "none";
      } else {
        btnHablar.disabled = true;
        btnHablar.style.opacity = 0.6;
        btnHablar.style.pointerEvents = "none";
        avisoSommelier.style.display = "flex";
      }

      // --- CARGA DE DATOS DE LA PÁGINA ---
      cargarFichaVino();
      cargarPerfilOrganoleptico();
      cargarNarrativaVino();
      cargarResumenValoraciones();
      cargarComentarios();
    });
});
</script>
</body>
</html>
