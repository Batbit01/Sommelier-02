<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title id="vinoTitle">Ficha del Vino</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: sans-serif; padding: 2rem; background-color: #fefefe; color: #222; max-width: 600px; margin: auto; }
        .vino-ficha img { width: 100%; max-height: 300px; object-fit: contain; border-radius: 1rem; }
        .vino-dato { margin-bottom: 1rem; }
        .vino-dato strong { display: inline-block; width: 100px; }
        #respuesta { margin-top: 2rem; font-style: italic; background: #f1f1f1; padding: 1rem; border-radius: 0.5rem; }
        #hablar { display: inline-block; margin-top: 2rem; padding: 0.75rem 1.5rem; background: #800000; color: white; border: none; border-radius: 1rem; cursor: pointer; }
        .redes a { margin-right: 1rem; text-decoration: none; color: #800000; }
        .switch-buttons button { margin-right: 1rem; padding: 0.5rem 1rem; background: #eee; border: 1px solid #ccc; border-radius: 0.5rem; cursor: pointer; }
        #radar-container, #score-container, #valoracion-container { margin-top: 3rem; }
        #score-bar { width: 100%; height: 20px; background-color: #ddd; border-radius: 10px; overflow: hidden; }
        #score-fill { height: 100%; background-color: #800000; text-align: center; line-height: 20px; color: white; font-size: 0.9rem; }
        #estrellas .estrella { font-size: 2rem; color: #ccc; cursor: pointer; }
        #estrellas .estrella.seleccionada { color: #800000; }
        #estrellas-nota { color: #800000; font-size: 1.8rem; vertical-align: middle; }
        #lista-comentarios .comentario { margin-bottom: 1rem; padding: 0.75rem; border: 1px solid #ddd; border-radius: 0.5rem; background-color: #fafafa; }
    </style>
</head>
<body>
    <!-- ESTRUCTURA HTML -->
    <h1 id="vinoTitulo">Ficha del Vino</h1>
    <div class="vino-ficha">
        <img alt="Imagen del vino" id="vinoImagen" src=""/>
        <div class="vino-dato"><strong>Tipo:</strong> <span id="vinoTipo">-</span></div>
        <div class="vino-dato"><strong>Origen:</strong> <span id="vinoOrigen">-</span></div>
        <div class="vino-dato"><strong>Variedad:</strong> <span id="vinoUva">-</span></div>
        <div class="vino-dato"><strong>Bodega:</strong> <span id="bodegaNombre">-</span></div>
        <div class="vino-dato redes" id="bodega-redes"></div>
       </div>
       <div id="respuesta">Cargando descripción del vino...</div>
    <button id="hablar">Hablar con el sommelier</button>

    <div id="radar-container">
        <h3>Perfil organoléptico</h3>
        <div class="switch-buttons">
            <button onclick="renderRadar('aromatico')">Aromático</button>
            <button onclick="renderRadar('gustativo' )">Gustativo</button>
            <button onclick="renderRadar('sensorial')">Sensorial</button>
        </div>
        <canvas height="400" id="radarChart" width="400"></canvas>
    </div>
    <div id="score-container">
        <h3>Puntuación Total</h3>
        <div id="score-bar"><div id="score-fill" style="width: 0%">0</div></div>
        <hr style="margin: 2rem 0;">
        <div style="display: flex; align-items: center; gap: 0.5rem;">
       <span id="media-nota" style="font-size:2rem; font-weight:bold;"></span>
       <span id="estrellas-nota" style="font-size:1.5rem; color: #990000;"></span>
       <span id="total-valoraciones" style="font-size:1rem; color:#555;"></span>
    </div>
    </div>
    <div id="valoracion-container">
        <h3>Valora este vino</h3>
        <div id="estrellas">
            <span class="estrella" data-value="1">★</span><span class="estrella" data-value="2">★</span><span class="estrella" data-value="3">★</span><span class="estrella" data-value="4">★</span><span class="estrella" data-value="5">★</span>
        </div>
        <textarea id="comentario" placeholder="Deja un comentario sobre el vino..." rows="4" style="width:100%; margin-top: 1rem; padding: 0.5rem;"></textarea>
        <button id="enviar-valoracion" style="margin-top: 1rem; background:#800000; color:white; border:none; padding:0.5rem 1rem; border-radius:0.5rem; cursor:pointer;">Enviar valoración</button>
        <p id="mensaje-valoracion" style="margin-top:1rem; color: green;"></p>
    </div>
          <!-- Elementos ocultos para almacenar datos de geolocalización -->
    <div style="display:none;">
        <span id="debug-ciudad"></span>
        <span id="debug-pais"></span>
        <span id="debug-idioma"></span>
     </div>


    <div id="comentarios-container" style="margin-top: 3rem;">
        <h3 style="cursor:pointer; color:#800000;" onclick="toggleComentarios()">▼ Comentarios de otros usuarios</h3>
        <div id="lista-comentarios" style="max-height: 0; overflow: hidden; transition: max-height 0.5s ease-out;">
            <p style="padding: 1rem 0;">Cargando comentarios...</p>
        </div>
    </div>

    <!-- =============================================================== -->
    <!-- ============= UN ÚNICO SCRIPT PARA TODA LA LÓGICA ============= -->
    <!-- =============================================================== -->
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            // --- VARIABLES GLOBALES Y CONFIGURACIÓN ---
            let radarChart;
            let organo = {};
            let puntuacionSeleccionada = 0;
            const urlParams = new URLSearchParams(window.location.search);
            const vinoId = urlParams.get("vino_id");

            // --- FUNCIONES DE RENDERIZADO ---
            
window.renderRadar = function(tipo) {
    if (!organo || Object.keys(organo).length === 0) return;
    const ctx = document.getElementById('radarChart').getContext('2d');
    if (radarChart) radarChart.destroy();

    let labels = [], data = [];

    if (tipo === 'gustativo') {
        labels = ["Cuerpo", "Acidez", "Dulzor", "Taninos", "Frescura", "Mineralidad"];
        data = [organo.cuerpo, organo.acidez, organo.dulzor, organo.taninos, organo.frescura, organo.mineralidad];
    } else if (tipo === 'aromatico') {
        labels = ["Fruta", "Floral", "Especiado", "Tostado", "Herbáceo"];
        data = [organo.fruta, organo.floral, organo.especiado, organo.tostado, organo.herbaceo];
    } else if (tipo === 'sensorial') {
        labels = ["Persistencia", "Complejidad", "Astringencia", "Alcohol percibido", "Armonía"];
        data = [organo.persistencia, organo.complejidad, organo.astringencia, organo.alcohol_percibido, organo.armonia];
    }

    radarChart = new Chart(ctx, {
        type: 'radar',
        data: {
            labels,
            datasets: [{
                label: `Perfil ${tipo}`,
                data: data.map(x => parseInt(x) || 0),
                fill: true,
                backgroundColor: "rgba(128,0,0,0.2)",
                borderColor: "rgba(128,0,0,1)",
                pointBackgroundColor: "rgba(128,0,0,1)"
            }]
        },
        options: {
            responsive: true,
            scales: {
                r: {
                    min: 0,
                    max: 10,
                    ticks: {
                        stepSize: 2,
                        color: '#666',
                        font: { size: 12 }
                    },
                    pointLabels: {
                        font: { size: 14 },
                        color: '#444'
                    },
                    grid: { color: '#ddd' },
                    angleLines: { color: '#ccc' }
                }
            },
            plugins: {
                legend: { display: false }
            }
        }
    });
};

                    document.getElementById("debug-ciudad").innerText = data.city || "No detectado";
                    document.getElementById("debug-pais").innerText = data.country_name || "No detectado";
                    document.getElementById("debug-idioma").innerText = navigator.language;
                })
                .catch(error => {
                    console.warn("No se pudo obtener geolocalización:", error);
                    window._datosUsuario = {}; // Asegurarse de que exista el objeto aunque falle
                })
                .finally(() => {
                    // 2. Una vez TERMINADA la geolocalización, configurar los listeners y cargar el resto
                    
                    document.querySelectorAll(".estrella").forEach(e => {
                        e.addEventListener("click", () => {
                            puntuacionSeleccionada = parseInt(e.dataset.value);
                            document.querySelectorAll(".estrella").forEach(star => {
                                star.classList.toggle("seleccionada", parseInt(star.dataset.value) <= puntuacionSeleccionada);
                            });
                        });
                    });

                    document.getElementById("enviar-valoracion").addEventListener("click", async () => {
                        const comentario = document.getElementById("comentario").value || "";
                        const mensaje = document.getElementById("mensaje-valoracion");
                        if (!puntuacionSeleccionada) {
                            mensaje.innerText = "Por favor, selecciona una puntuación (de 1 a 5 estrellas).";
                            mensaje.style.color = "red";
                            return;
                        }
                        try {
                            await fetch("https://n8n-production-cb18.up.railway.app/webhook/comentar-vino", {
                                method: "POST",
                                headers: { "Content-Type": "application/json" },
                                body: JSON.stringify({
                                    vino_id: vinoId,
                                    puntuacion: puntuacionSeleccionada,
                                    comentario: comentario,
                                    user_id: localStorage.getItem("user_id" ) || "user_" + Math.random().toString(36).substring(2, 10),
                                    ciudad: window._datosUsuario?.ciudad || "Desconocida",
                                    pais: window._datosUsuario?.pais || "Desconocido",
                                    idioma: window._datosUsuario?.idioma || "es"
                                })
                            });
                            mensaje.innerText = "¡Gracias por tu valoración!";
                            mensaje.style.color = "green";
                        } catch (err) {
                            mensaje.innerText = "Error al enviar tu valoración.";
                            mensaje.style.color = "red";
                        }
                    });

                    // 3. Cargar todos los datos del vino en paralelo
                    cargarFichaVino();
                    cargarPerfilOrganoleptico();
                    cargarNarrativaVino();
                    cargarResumenValoraciones();
                    cargarComentarios();
                });
        });
    </script>
    <script>
document.addEventListener("DOMContentLoaded", async () => {
  const urlParams = new URLSearchParams(window.location.search);
  const vinoId = urlParams.get("vino_id");

  if (!vinoId) return;

  try {
    const response = await fetch(`https://n8n-production-cb18.up.railway.app/webhook/consultar-valoraciones?vino_id=${vinoId}`);
    const data = await response.json();

    const notaMedia = data.nota_media || 0;
    const total = data.total_valoraciones || 0;

    // Mostrar nota media numérica
    document.getElementById("media-nota").innerText = notaMedia.toFixed(1);

    // Mostrar estrellas
    const estrellasLlenas = '★'.repeat(Math.round(notaMedia));
    const estrellasVacias = '☆'.repeat(5 - Math.round(notaMedia));
    document.getElementById("estrellas-nota").innerText = estrellasLlenas + estrellasVacias;

    // Mostrar total de valoraciones
    document.getElementById("total-valoraciones").innerText = `(${total} valoración${total === 1 ? '' : 'es'})`;

  } catch (error) {
    console.error("Error al obtener valoraciones:", error);
  }
});
</script>

</body>
</html>```
