<!DOCTYPE html>

<html lang="es">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Ficha del Vino - SommelierLabs</title>
<style>
    body {
      font-family: 'Georgia', serif;
      background-color: #f5f5f5;
      margin: 0;
      padding: 2rem;
      text-align: center;
    }
    h1 {
      color: #8B0000;
    }
    .vino-info {
      margin-top: 2rem;
    }
    button {
      background-color: #8B0000;
      color: white;
      font-size: 1.2rem;
      padding: 1rem 2rem;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      margin-top: 2rem;
    }
    button:hover {
      background-color: #a01717;
    }
  </style>
</head>
<body>
<img alt="SommelierLab" src="logo-avatar-granate.png" width="120"/>
<h1>Bienvenido a SommelierLab</h1>
<div class="vino-info">
<p id="vinoNombre">Est치s consultando la ficha de un vino especial...</p>
<div id="respuesta" style="margin-top:1em; margin-bottom:2em; font-style:italic;"></div>
<button id="hablarBtn">Hablar con el sommelier</button>
</div>
<!-- Retell Script de carga -->
<div id="ficha-vino" style="margin-top: 2em; border: 1px solid #ccc; padding: 1em; border-radius: 10px; max-width: 600px;">
<img alt="Imagen del vino" id="vino-img" src="" style="width: 100%; max-height: 300px; object-fit: cover; border-radius: 8px;"/>
<h2 id="vino-nombre" style="margin: 1em 0 0.5em;"></h2>
<p><strong>Tipo:</strong> <span id="vino-tipo"></span></p>
<p><strong>A침ada:</strong> <span id="vino-anada"></span></p>
<p><strong>Origen / DO:</strong> <span id="vino-do"></span></p>
<p><strong>Variedad de uva:</strong> <span id="vino-uva"></span></p>
<div style="margin-top: 1em;">
<a href="#" id="web-bodega" style="margin-right: 1em;" target="_blank">游깷 Web de la Bodega</a>
<span id="redes-sociales"></span>
</div>
<button id="compartir" style="margin-top: 1em;">游닋 Compartir</button>
</div>
<script src="https://cdn.retellai.com/web-sdk.js"></script>
<script>
document.addEventListener("DOMContentLoaded", () => {
  const params = new URLSearchParams(window.location.search);
  const vinoId = params.get("vino_id") || "V001";
  const webhookBase = "https://n8n-production-cb18.up.railway.app/webhook/consultar-vino";

  console.log("Vino ID detectado:", vinoId);

  // 1. Cargar narrativa + ficha al entrar
  fetch(`${webhookBase}?vino_id=${vinoId}`)
    .then(response => {
      if (!response.ok) throw new Error("No se pudo cargar el vino");
      return response.json();
    })
    .then(data => {
      console.log("Datos recibidos:", data);

      const respuestaElem = document.getElementById("respuesta");
      if (respuestaElem && data.narrativa) {
        respuestaElem.innerHTML = data.narrativa;
      }

      if (typeof actualizarFichaVino === "function") {
        actualizarFichaVino(data);
      }
    })
    .catch(err => {
      console.error("Error cargando el vino:", err);
      const respuestaElem = document.getElementById("respuesta");
      if (respuestaElem) {
        respuestaElem.innerHTML = "<em>Error cargando el vino.</em>";
      }
    });

  // 2. Activar Retell SOLO cuando el usuario hace clic en el bot칩n
  const hablarBtn = document.getElementById("hablar");
  if (hablarBtn) {
    hablarBtn.addEventListener("click", () => {
      fetch(`${webhookBase}?vino_id=${vinoId}&accion=retell`)
        .then(res => res.json())
        .then(data => {
          if (data.call_id) {
            RetellWebSDK.init({ callId: data.call_id });
          } else {
            alert("No se recibi칩 call_id desde n8n");
          }
        })
        .catch(err => {
          console.error("Error al activar Retell:", err);
        });
    });
  }
});
</script>
<script>
function actualizarFichaVino(data) {
  document.getElementById("vino-img").src = data.imagen_url || "";
  document.getElementById("vino-nombre").textContent = data.nombre || "Sin nombre";
  document.getElementById("vino-tipo").textContent = data.tipo || "";
  document.getElementById("vino-anada").textContent = data.anada || "";
  document.getElementById("vino-do").textContent = data.origen || "";
  document.getElementById("vino-uva").textContent = data.variedad || "";
  document.getElementById("web-bodega").href = data.web_bodega || "#";

  const redes = [];
  if (data.instagram) redes.push(`<a href="${data.instagram}" target="_blank">Instagram</a>`);
  if (data.facebook) redes.push(`<a href="${data.facebook}" target="_blank">Facebook</a>`);
  if (data.twitter) redes.push(`<a href="${data.twitter}" target="_blank">X</a>`);
  document.getElementById("redes-sociales").innerHTML = redes.join(" | ");
}
</script>
<script>
function actualizarFichaVino(data) {
  if (data.imagen_url) {
    const img = document.getElementById("vino-img");
    if (img) img.src = data.imagen_url;
  }

  const mappings = {
    "vino-nombre": data.nombre,
    "vino-tipo": data.tipo,
    "vino-anada": data.anada,
    "vino-origen": data.origen,
    "vino-variedad": data.variedad
  };

  Object.entries(mappings).forEach(([id, value]) => {
    const el = document.getElementById(id);
    if (el) el.textContent = value || "-";
  });

  // Actualizar enlaces de redes y web
  if (data.web_bodega) {
    const webBtn = document.getElementById("web-bodega");
    if (webBtn) webBtn.href = data.web_bodega;
  }

  const redes = ["instagram", "facebook", "twitter"];
  redes.forEach(red => {
    const link = document.getElementById(`red-${red}`);
    if (link && data[red]) {
      link.href = data[red];
      link.style.display = "inline-block";
    } else if (link) {
      link.style.display = "none";
    }
  });
}
</script></body>
</html>
