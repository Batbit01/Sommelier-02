<script>
// ---- Global vinoId desde query (?vino_id) ----
const vinoId = new URLSearchParams(window.location.search).get('vino_id') || "";

// --- Normaliza vinoId cuando llega como ruta "qr2/V002/2024/es/index.html" → "V002-2024"
(function normalizeVinoId(){
  const q  = new URLSearchParams(location.search);
  let vp   = q.get('vino_id') || location.pathname;
  const qp = vp.indexOf('?'); if (qp !== -1) vp = vp.slice(0, qp);
  const segs = vp.replace(/^\/+/, '').split('/').filter(Boolean);
  const i    = Math.max(0, segs.findIndex(s => s.toLowerCase()==='qr2'));
  const vino = segs[i+1] || '';
  const anyo = segs[i+2] || '';
  if (!window.vinoId || /(^|\/)qr2\//i.test(String(window.vinoId))) {
    if (vino && anyo) {
      window.vinoId = `${vino}-${anyo}`;
      console.log('[SommelierLab] vinoId normalizado →', window.vinoId);
    }
  }
})();

// --- Helpers para cargar ficha.json desde Backblaze (según path o ?vino_id=&anyada=&lang=)
function __parseFromPathOrQuery(){
  const q  = new URLSearchParams(location.search);
  let vp   = q.get('vino_id') || location.pathname;
  const qp = vp.indexOf('?'); if (qp !== -1) vp = vp.slice(0, qp);
  const segs = vp.replace(/^\/+/, '').split('/').filter(Boolean);
  const i    = Math.max(0, segs.findIndex(s => s.toLowerCase()==='qr2'));
  return {
    vino: segs[i+1]||'',
    anyo: segs[i+2]||'',
    lang: (q.get('lang') || segs[i+3] || (navigator.language||'es').slice(0,2)).slice(0,2).toLowerCase()
  };
}
function __currentFichaUrl(){
  const { vino, anyo, lang } = __parseFromPathOrQuery();
  if (!vino || !anyo || !lang) return null;
  return `https://f005.backblazeb2.com/file/SommelierLab-media/qr2/${vino}/${anyo}/${lang}/ficha.json`;
}
function __loadFichaJSON(){
  const url = __currentFichaUrl(); if (!url) return Promise.resolve(null);
  console.log('[SommelierLab] Intentando ficha.json →', url);
  return fetch(url, { cache:'no-store' })
    .then(r => r.ok ? r.json() : null)
    .catch(() => null);
}

// ---- Narrativa + audio (webhook + prefill desde JSON) ----
async function cargarNarrativaVino() {
  const respuestaEl = document.getElementById("respuesta");
  const bloqueAudio = document.getElementById("bloque-audio-narrativa");
  const playerEl    = document.getElementById("player");

  // Prefill rápido con ficha.json (no bloquea)
  __loadFichaJSON()
    .then(function(_f){
      if (!_f) return;
      if (_f.content && _f.content.narrative_text && !respuestaEl.textContent.trim()) {
        respuestaEl.textContent = _f.content.narrative_text;
        document.getElementById("bloque-audio-narrativa").style.display = "block";
      }
      var au = _f.assets && _f.assets.audio_url;
      if (au) {
        try { if (playerEl._plyr) playerEl._plyr.destroy(); } catch(e){}
        playerEl.innerHTML = '';
        var s = document.createElement('source'); s.src = au; s.type = 'audio/mpeg';
        playerEl.appendChild(s); playerEl.load();
        try { playerEl._plyr = new Plyr(playerEl, { speed:{selected:1, options:[0.75,1,1.25,1.5,2]} }); } catch(e){}
        bloqueAudio.style.display = 'block';
      }
    })
    .catch(function(){});

  // --- Tu webhook original (lo dejamos igual, puede sobrescribir narrativa/audio) ---
  try {
    // (si necesitas contexto extra, aquí puedes agregarlo)
    const baseConsultar = "https://n8n-production-cb18.up.railway.app/webhook/Consultar-vino-7dbyxa8kql19qw";
    const url = `${baseConsultar}?vino_id=${encodeURIComponent(vinoId)}&secret=${encodeURIComponent("midulcesommelier")}`;
    const res = await fetch(url, { cache: "no-store" });
    const raw = await res.text();
    if (!res.ok) throw new Error(`HTTP ${res.status} :: ${raw.slice(0,120)}`);
    let data = {};
    try { data = raw ? JSON.parse(raw) : {}; } catch { data = {}; }

    if (!data.audio_url && data.fields) {
      data.audio_url = data.fields["Audio URL"] || "";
      data.narrativa = data.narrativa || data.fields["narrativa"] || "";
      data.vino_id   = data.vino_id   || data.fields["ID Vino"]  || "";
    }

    respuestaEl.innerText = data.narrativa || respuestaEl.innerText;

    let audioUrl = (data.audio_url || "").trim();
    if (audioUrl.startsWith("http://")) audioUrl = audioUrl.replace(/^http:\/\//i, "https://");

    if (audioUrl) {
      if (playerEl._plyr) { try { playerEl._plyr.destroy(); } catch(_) {} playerEl._plyr = null; }
      playerEl.innerHTML = "";
      const src = document.createElement("source"); src.src = audioUrl; src.type = "audio/mpeg";
      playerEl.appendChild(src);
      playerEl.load();
      const inst = new Plyr(playerEl, { speed: { selected: 1, options: [0.75, 1, 1.25, 1.5, 2] } });
      playerEl._plyr = inst;
      bloqueAudio.style.display = "block";
    }
  } catch (err) {
    console.error("❌ Narrativa/Audio:", err);
  }
}
</script>
<script>
// ---- Global vinoId desde query (?vino_id) ----
const vinoId = new URLSearchParams(window.location.search).get('vino_id') || "";

// --- Normaliza vinoId cuando llega como ruta "qr2/V002/2024/es/index.html" → "V002-2024"
(function normalizeVinoId(){
  const q  = new URLSearchParams(location.search);
  let vp   = q.get('vino_id') || location.pathname;
  const qp = vp.indexOf('?'); if (qp !== -1) vp = vp.slice(0, qp);
  const segs = vp.replace(/^\/+/, '').split('/').filter(Boolean);
  const i    = Math.max(0, segs.findIndex(s => s.toLowerCase()==='qr2'));
  const vino = segs[i+1] || '';
  const anyo = segs[i+2] || '';
  if (!window.vinoId || /(^|\/)qr2\//i.test(String(window.vinoId))) {
    if (vino && anyo) {
      window.vinoId = `${vino}-${anyo}`;
      console.log('[SommelierLab] vinoId normalizado →', window.vinoId);
    }
  }
})();

// --- Helpers para cargar ficha.json desde Backblaze (según path o ?vino_id=&anyada=&lang=)
function __parseFromPathOrQuery(){
  const q  = new URLSearchParams(location.search);
  let vp   = q.get('vino_id') || location.pathname;
  const qp = vp.indexOf('?'); if (qp !== -1) vp = vp.slice(0, qp);
  const segs = vp.replace(/^\/+/, '').split('/').filter(Boolean);
  const i    = Math.max(0, segs.findIndex(s => s.toLowerCase()==='qr2'));
  return {
    vino: segs[i+1]||'',
    anyo: segs[i+2]||'',
    lang: (q.get('lang') || segs[i+3] || (navigator.language||'es').slice(0,2)).slice(0,2).toLowerCase()
  };
}
function __currentFichaUrl(){
  const { vino, anyo, lang } = __parseFromPathOrQuery();
  if (!vino || !anyo || !lang) return null;
  return `https://f005.backblazeb2.com/file/SommelierLab-media/qr2/${vino}/${anyo}/${lang}/ficha.json`;
}
function __loadFichaJSON(){
  const url = __currentFichaUrl(); if (!url) return Promise.resolve(null);
  console.log('[SommelierLab] Intentando ficha.json →', url);
  return fetch(url, { cache:'no-store' })
    .then(r => r.ok ? r.json() : null)
    .catch(() => null);
}

// ---- Narrativa + audio (webhook + prefill desde JSON) ----
async function cargarNarrativaVino() {
  const respuestaEl = document.getElementById("respuesta");
  const bloqueAudio = document.getElementById("bloque-audio-narrativa");
  const playerEl    = document.getElementById("player");

  // Prefill rápido con ficha.json (no bloquea)
  __loadFichaJSON()
    .then(function(_f){
      if (!_f) return;
      if (_f.content && _f.content.narrative_text && !respuestaEl.textContent.trim()) {
        respuestaEl.textContent = _f.content.narrative_text;
        document.getElementById("bloque-audio-narrativa").style.display = "block";
      }
      var au = _f.assets && _f.assets.audio_url;
      if (au) {
        try { if (playerEl._plyr) playerEl._plyr.destroy(); } catch(e){}
        playerEl.innerHTML = '';
        var s = document.createElement('source'); s.src = au; s.type = 'audio/mpeg';
        playerEl.appendChild(s); playerEl.load();
        try { playerEl._plyr = new Plyr(playerEl, { speed:{selected:1, options:[0.75,1,1.25,1.5,2]} }); } catch(e){}
        bloqueAudio.style.display = 'block';
      }
    })
    .catch(function(){});

  // --- Tu webhook original (lo dejamos igual, puede sobrescribir narrativa/audio) ---
  try {
    // (si necesitas contexto extra, aquí puedes agregarlo)
    const baseConsultar = "https://n8n-production-cb18.up.railway.app/webhook/Consultar-vino-7dbyxa8kql19qw";
    const url = `${baseConsultar}?vino_id=${encodeURIComponent(vinoId)}&secret=${encodeURIComponent("midulcesommelier")}`;
    const res = await fetch(url, { cache: "no-store" });
    const raw = await res.text();
    if (!res.ok) throw new Error(`HTTP ${res.status} :: ${raw.slice(0,120)}`);
    let data = {};
    try { data = raw ? JSON.parse(raw) : {}; } catch { data = {}; }

    if (!data.audio_url && data.fields) {
      data.audio_url = data.fields["Audio URL"] || "";
      data.narrativa = data.narrativa || data.fields["narrativa"] || "";
      data.vino_id   = data.vino_id   || data.fields["ID Vino"]  || "";
    }

    respuestaEl.innerText = data.narrativa || respuestaEl.innerText;

    let audioUrl = (data.audio_url || "").trim();
    if (audioUrl.startsWith("http://")) audioUrl = audioUrl.replace(/^http:\/\//i, "https://");

    if (audioUrl) {
      if (playerEl._plyr) { try { playerEl._plyr.destroy(); } catch(_) {} playerEl._plyr = null; }
      playerEl.innerHTML = "";
      const src = document.createElement("source"); src.src = audioUrl; src.type = "audio/mpeg";
      playerEl.appendChild(src);
      playerEl.load();
      const inst = new Plyr(playerEl, { speed: { selected: 1, options: [0.75, 1, 1.25, 1.5, 2] } });
      playerEl._plyr = inst;
      bloqueAudio.style.display = "block";
    }
  } catch (err) {
    console.error("❌ Narrativa/Audio:", err);
  }
}
</script>
<script>
// ------ Radar + módulos legacy + compartir + boot ------
document.addEventListener("DOMContentLoaded", async function() {
  const API_BASE = "https://sommelierlab-api-production.up.railway.app";

  // Radar
  const perfilesConfig = {
    gustativo: { labels:["Cuerpo","Acidez","Dulzor","Taninos","Frescura","Mineralidad"], fields:["cuerpo","acidez","dulzor","taninos","frescura","mineralidad"] },
    aromatico: { labels:["Fruta","Floral","Especiado","Tostado","Herbáceo"], fields:["fruta","floral","especiado","tostado","herbaceo"] },
    sensorial: { labels:["Persistencia","Complejidad","Astringencia","Alcohol","Armonía"], fields:["persistencia","complejidad","astringencia","alcohol_percibido","armonia"] },
  };
  let radarType = "aromatico";
  let organo = {};
  function setRadarType(tipo){ radarType = tipo; document.querySelectorAll('.switch-buttons button').forEach(b=>b.classList.remove('active')); document.getElementById(`btn-${tipo}`).classList.add('active'); renderRadarSVG(); }
  window.setRadarType = setRadarType;
  function polarToCartesian(cx,cy,r,ang){ return [ cx + r*Math.cos(ang), cy + r*Math.sin(ang) ]; }
  function renderRadarSVG(){
    const svg = document.getElementById("radarSVG"); svg.innerHTML = `<rect x="0" y="0" width="430" height="430" fill="#f8f4f2"/>`;
    const cfg = perfilesConfig[radarType]; const N = cfg.labels.length; const R=155, cx=215, cy=215, min=0,max=10;
    const values = cfg.fields.map(f => parseInt(organo[f])||0);
    for(let c=1;c<=5;c++){ let r=(R*c)/5,mesh=[]; for(let i=0;i<N;i++){ let a=-Math.PI/2 + (2*Math.PI*i)/N; mesh.push(polarToCartesian(cx,cy,r,a)); } svg.innerHTML += `<polygon points="${mesh.map(p=>p.join(',')).join(' ')}" fill="none" stroke="#d7bebe" stroke-width="1"/>`; }
    for(let i=0;i<N;i++){ let a=-Math.PI/2 + (2*Math.PI*i)/N; let [x2,y2]=polarToCartesian(cx,cy,R,a); svg.innerHTML += `<line x1="${cx}" y1="${cy}" x2="${x2}" y2="${y2}" stroke="#bfa1a1" stroke-width="1"/>`; let [lx,ly]=polarToCartesian(cx,cy,R+30,a); svg.innerHTML += `<text x="${lx}" y="${ly}" class="radar-label">${cfg.labels[i]}</text>`; }
    let poly=[]; for(let i=0;i<N;i++){ let v=values[i]; let r=(v-min)/(max-min)*R; let a=-Math.PI/2 + (2*Math.PI*i)/N; poly.push(polarToCartesian(cx,cy,r,a)); }
    svg.innerHTML += `<polygon points="${poly.map(p=>p.join(',')).join(' ')}" fill="rgba(128,0,0,.17)" stroke="#800000" stroke-width="3"/>`;
    for(let i=0;i<N;i++){ let v=values[i]; let r=(v-min)/(max-min)*R; let a=-Math.PI/2 + (2*Math.PI*i)/N; let [px,py]=polarToCartesian(cx,cy,r,a); svg.innerHTML += `<circle cx="${px}" cy="${py}" r="8" fill="#800000" stroke="#fff" stroke-width="2"/>`; }
  }

  // Pintado rápido desde ficha.json (si existe) — no bloquea la API
  try {
    const _f = await __loadFichaJSON();
    if (_f) {
      document.title = document.getElementById("vinoTitulo").innerText = _f.title || _f?.ficha?.title || "Ficha del Vino";
      const img = _f?.assets?.image_url || _f.image;
      if (img) document.getElementById("vinoImagen").src = img;
      const tipo = _f.tipo || _f?.details?.tipo || '';
      const uva  = _f.variedad || _f?.details?.variedad || '';
      const orig = _f.do || _f.region || _f?.details?.origen || '';
      if (tipo) document.getElementById("vinoTipo").innerText = tipo;
      if (uva)  document.getElementById("vinoUva").innerText  = uva;
      if (orig) document.getElementById("vinoOrigen").innerText = orig;
    }
  } catch(_){}

  // Cargar ficha desde tu API (completa o sobrescribe)
  async function cargarFichaVino(){
    try{
      const r = await fetch(`${API_BASE}/api/vino/${vinoId}`);
      const fichaData = await r.json();
      if (fichaData.imagen?.[0]?.url) document.getElementById("vinoImagen").src = fichaData.imagen[0].url;
      document.title = document.getElementById("vinoTitulo").innerText = fichaData.nombre || document.getElementById("vinoTitulo").innerText;
      if (fichaData.tipo)     document.getElementById("vinoTipo").innerText   = fichaData.tipo;
      if (fichaData.variedad) document.getElementById("vinoUva").innerText    = fichaData.variedad;
      if (fichaData.origen)   document.getElementById("vinoOrigen").innerText = fichaData.origen;
      document.getElementById("bodegaNombre").innerText = fichaData.bodega?.nombre || "";
      const redesHtml=[];
      if (fichaData.bodega?.web)       redesHtml.push(`<a href="${fichaData.bodega.web}" target="_blank">🌐 Web</a>`);
      if (fichaData.bodega?.facebook)  redesHtml.push(`<a href="${fichaData.bodega.facebook}" target="_blank">📘 Facebook</a>`);
      if (fichaData.bodega?.instagram) redesHtml.push(`<a href="${fichaData.bodega.instagram}" target="_blank">📸 Instagram</a>`);
      if (fichaData.bodega?.twitter)   redesHtml.push(`<a href="${fichaData.bodega.twitter}" target="_blank">🐦 Twitter</a>`);
      document.getElementById("bodega-redes").innerHTML = redesHtml.join(" · ");
    } catch(e){ console.error("❌ Error ficha API", e); }
  }

  async function cargarPerfilOrganoleptico(){
    try{
      const r = await fetch(`${API_BASE}/api/organoleptica/${vinoId}`);
      organo = await r.json();
      setRadarType(radarType);
    } catch(e){ console.warn("Organoléptico no disponible", e); }
  }

  // Valoraciones / Comentarios (n8n)
  async function cargarValoraciones(){
    try{
      const res = await fetch(`https://n8n-production-cb18.up.railway.app/webhook/consultar-valoraciones?vino_id=${encodeURIComponent(vinoId)}`);
      const data = await res.json();
      document.getElementById("media-nota").innerText = data.nota_media !== undefined ? data.nota_media.toFixed(1) : "-";
      const cont = document.getElementById("estrellas-nota"); cont.innerHTML="";
      const nota = data.nota_media || 0; const estrellas = Math.floor(nota); const media = nota - estrellas;
      for(let i=1;i<=5;i++){ if(i<=estrellas) cont.innerHTML+="★"; else if(i===estrellas+1 && media>=.25 && media<.75) cont.innerHTML+="⯪"; else cont.innerHTML+="☆"; }
      document.getElementById("total-valoraciones").innerText = data.total_valoraciones ? `(${data.total_valoraciones} valoraciones)` : "";
      const fill = document.getElementById("score-fill"); const pct = data.nota_media ? Math.round((data.nota_media/5)*100) : 0;
      fill.style.width = pct + "%"; fill.textContent = data.nota_media ? `${data.nota_media.toFixed(1)} / 5` : "0 / 5";
    } catch(e){ console.warn("Ratings GET", e); }
  }
  async function cargarComentarios(){
    try{
      const res = await fetch(`https://n8n-production-cb18.up.railway.app/webhook/consultar-comentarios?vino_id=${encodeURIComponent(vinoId)}`);
      const data = await res.json();
      const lista = document.getElementById("lista-comentarios"); lista.innerHTML="";
      const comentarios = Array.isArray(data.comentarios) ? data.comentarios : Array.isArray(data) ? data : [];
      if (!comentarios.length){ lista.innerHTML = '<p style="padding:.6rem 0;">No hay comentarios aún.</p>'; }
      else comentarios.slice(0,10).forEach(c=>{
        const div = document.createElement("div"); div.className="comentario";
        div.innerHTML = `<strong style="color:#800000;">${c.ciudad||"Anónimo"}</strong> · <span style="color:#666">${(c.fecha||"").slice(0,10)}</span><br/><em>${c.comentario||""}</em>`;
        lista.appendChild(div);
      });
      if (lista.style.maxHeight && lista.style.maxHeight!=="0px") lista.style.maxHeight = lista.scrollHeight + "px";
    } catch(e){ console.warn("Comentarios GET", e); }
  }
  window.toggleComentarios = function(){
    const el = document.getElementById("lista-comentarios");
    if (el.style.maxHeight === "0px" || !el.style.maxHeight) el.style.maxHeight = el.scrollHeight + "px";
    else el.style.maxHeight = "0px";
  };

  // Enviar valoración/comentario
  let puntuacionSeleccionada = 0;
  document.querySelectorAll(".estrella").forEach(e=>{
    e.addEventListener("click",()=>{
      puntuacionSeleccionada = parseInt(e.dataset.value);
      document.querySelectorAll(".estrella").forEach(star=>star.classList.toggle("seleccionada", parseInt(star.dataset.value)<=puntuacionSeleccionada));
    });
  });
  document.getElementById("enviar-valoracion").addEventListener("click", async ()=>{
    const comentario = document.getElementById("comentario").value || "";
    const mensaje = document.getElementById("mensaje-valoracion");
    if (!puntuacionSeleccionada){ mensaje.textContent="Selecciona una puntuación (1–5)."; mensaje.style.color="red"; return; }
    try{
      await fetch("https://n8n-production-cb18.up.railway.app/webhook/comentar-vino",{
        method:"POST", headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({
          vino_id: vinoId, puntuacion: puntuacionSeleccionada, comentario,
          user_id: localStorage.getItem("user_id") || "user_"+Math.random().toString(36).slice(2,10),
          ciudad: "", pais:"", idioma: (navigator.language||"es").slice(0,2),
          dispositivo: (/Mobi|Android.+Mobile|iPhone/i.test(navigator.userAgent) ? "mobile" : "desktop"),
          ua: navigator.userAgent||""
        })
      });
      mensaje.textContent="¡Gracias por tu valoración!"; mensaje.style.color="green";
      puntuacionSeleccionada=0; document.querySelectorAll(".estrella").forEach(s=>s.classList.remove("seleccionada"));
      document.getElementById("comentario").value=""; cargarValoraciones(); cargarComentarios();
    }catch{ mensaje.textContent="Error al enviar la valoración."; mensaje.style.color="red"; }
  });

  // Candado del sommelier (mismo comportamiento)
  const esQR = (new URLSearchParams(window.location.search)).get("qr") === "1";
  const btnHablar = document.getElementById("hablar");
  const avisoSommelier = document.getElementById("sommelier-aviso");
  if (esQR){ btnHablar.disabled=false; avisoSommelier.style.display="none"; } else { btnHablar.disabled=true; avisoSommelier.style.display="flex"; }

  // Cargas principales
  if (!vinoId){ document.getElementById("respuesta").innerText = "No se especificó ningún vino."; return; }
  await cargarFichaVino();
  await cargarNarrativaVino();
  await cargarPerfilOrganoleptico();
  await cargarValoraciones();
  await cargarComentarios();

  // Compartir (simple)
  const btnCompartir = document.getElementById('btn-compartir');
  const menuCompartir = document.getElementById('menu-compartir');
  const opcionesCompartir = [
    { id:'whatsapp', label:'WhatsApp', url: l => `https://wa.me/?text=${encodeURIComponent(l)}` },
    { id:'twitter',  label:'X (Twitter)', url: l => `https://twitter.com/intent/tweet?url=${encodeURIComponent(l)}` },
    { id:'facebook', label:'Facebook', url: l => `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(l)}` },
    { id:'copiar',   label:'Copiar enlace', url: l => null }
  ];
  function crearOpcion(opc){
    const el=document.createElement('button'); el.className='menu-item-compartir'; el.textContent = opc.label;
    el.onclick=(e)=>{ e.preventDefault(); const urlActual = window.location.href.replace(/[&?]qr=1/gi,''); if(opc.id==='copiar'){ navigator.clipboard.writeText(urlActual); menuCompartir.classList.remove('open'); } else { window.open(opc.url(urlActual), '_blank'); menuCompartir.classList.remove('open'); } };
    return el;
  }
  function renderizarMenu(){ menuCompartir.innerHTML=""; opcionesCompartir.forEach(opc=>menuCompartir.appendChild(crearOpcion(opc))); }
  btnCompartir.onclick=(e)=>{ e.stopPropagation(); if(menuCompartir.classList.contains('open')) menuCompartir.classList.remove('open'); else{ renderizarMenu(); menuCompartir.classList.add('open'); } };
  document.addEventListener('click',()=>menuCompartir.classList.remove('open'));
});
</script>
</body>
</html>
