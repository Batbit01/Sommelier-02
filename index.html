<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SommelierLab ¬∑ Ficha</title>
  <style>
    :root { --fg:#111; --muted:#666; --bg:#fff; --border:#e6e6e6; }
    * { box-sizing: border-box }
    body { margin:0; background:var(--bg); color:var(--fg); font: 16px/1.45 system-ui, Segoe UI, Roboto, Arial, sans-serif }
    .wrap { max-width:840px; margin:0 auto; padding:20px }
    header { display:flex; align-items:center; justify-content:space-between; gap:12px; margin: 6px 0 14px }
    h1 { font-size:1.8rem; margin: 6px 0 0 }
    .muted { color:var(--muted) }
    .hero { border-radius:16px; overflow:hidden; border:1px solid var(--border); background:#fafafa }
    .hero img { display:block; width:100%; height:auto }
    .buttons { display:flex; flex-wrap:wrap; gap:10px; margin:16px 0 6px }
    .btn { padding:12px 16px; border-radius:12px; border:1px solid var(--border); background:#f7f7f7; text-decoration:none; color:inherit; cursor:pointer }
    .btn[disabled] { opacity:.45; cursor:not-allowed }
    .btn-primary { background:#111; color:#fff; border-color:#111 }
    .btn-secondary { background:#f0f0f0 }
    section.card { border:1px solid var(--border); border-radius:16px; padding:16px; margin:16px 0; background:#fff }
    .grid-2 { display:grid; grid-template-columns:1fr; gap:16px }
    @media (min-width: 720px) { .grid-2 { grid-template-columns:1fr 1fr } }
    ul.clean { margin:8px 0 0 18px }
    #foot { font-size:.85rem; margin:28px 0 8px }
    .chip { display:inline-block; font-size:.85rem; padding:4px 8px; background:#f4f4f4; border:1px solid var(--border); border-radius:999px; margin-right:6px }
    .sr-only { position:absolute; left:-9999px }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <div id="do" class="chip" style="display:none"></div>
        <div id="variedad" class="chip" style="display:none"></div>
        <h1 id="title">Cargando‚Ä¶</h1>
        <div id="subtitle" class="muted"></div>
      </div>
      <div id="share" style="display:none">
        <!-- reservado: m√≥dulo compartir -->
      </div>
    </header>

    <div id="hero" class="hero" style="display:none">
      <img id="heroImg" alt="">
    </div>

    <div class="buttons">
      <button id="btnComprar"  class="btn btn-primary" disabled>üõí Comprar ahora</button>
      <button id="btnReservar" class="btn btn-secondary" disabled>üéüÔ∏è Reservar visita</button>
      <!-- Activa si en futuro quieres lead sin URL de reserva -->
      <!-- <button id="btnSolicitar" class="btn">üì© Solicitar visita</button> -->
    </div>

    <section id="narrativa" class="card" style="display:none">
      <h2 style="margin-top:0">Historia &amp; narrativa</h2>
      <p id="narrativeText"></p>
      <div id="audioWrap" style="margin-top:12px"></div>
    </section>

    <section id="organoleptico" class="card" style="display:none">
      <h2 style="margin-top:0">Perfil organol√©ptico</h2>
      <div class="grid-2">
        <div>
          <h3>Visual</h3>
          <ul id="org-visual" class="clean"></ul>
          <h3>Aroma</h3>
          <ul id="org-aroma" class="clean"></ul>
        </div>
        <div>
          <h3>Boca</h3>
          <ul id="org-boca" class="clean"></ul>
          <h3>Maridaje</h3>
          <ul id="org-maridaje" class="clean"></ul>
        </div>
      </div>
    </section>

    <section id="curiosidad" class="card" style="display:none">
      <h2 style="margin-top:0">Curiosidad</h2>
      <p id="curioText"></p>
    </section>

    <!-- Reservado: m√≥dulos Sommelier Conversacional / Ratings & Comentarios -->
    <section id="otros" style="display:none"></section>

    <p id="foot" class="muted"></p>
  </div>

<script>
(function(){
  // ---------- CONFIG ----------
  const N8N = {
    SCAN: "https://n8n-production-cb18.up.railway.app/webhook/qr/scan",
    CTA:  "https://n8n-production-cb18.up.railway.app/webhook/qr/cta",
    LEAD: "https://n8n-production-cb18.up.railway.app/webhook/qr/lead",
  };
  const CDN_BASE = "https://f005.backblazeb2.com/file/SommelierLab-media/qr2";
  const SRC_VALUES = ["botella","mostrador","sala","carta","web","feria"];
  const LANGS = ["es","en"]; // a√±ade si publicas m√°s

  const UTM = ({src}) => `utm_source=qr&utm_medium=${encodeURIComponent(src)}&utm_campaign=qr2`;
  const withUtm = (url, src) => {
    if (!url) return null;
    return url.includes("?") ? `${url}&${UTM({src})}` : `${url}?${UTM({src})}`;
  };

  // ---------- URL PARTS ----------
  const parts = location.pathname.split("/").filter(Boolean);
  // Esperado: /qr2/{VINO}/{A√ëO}/{LANG}/index.html
  const i = Math.max(0, parts.length - 5);
  const VINO_ID = parts[i+1] || "";   // {VINO}
  const ANYADA  = parts[i+2] || "";   // {A√ëO}
  const LANG_IN_URL = parts[i+3] || ""; // {LANG}
  const srcParam = new URLSearchParams(location.search).get("src");
  const SRC = SRC_VALUES.includes((srcParam||"").toLowerCase()) ? srcParam.toLowerCase() : "botella";

  // ---------- LANG ----------
  const preferred = (navigator.language || "es").slice(0,2).toLowerCase();
  const LANG = LANGS.includes(LANG_IN_URL) ? LANG_IN_URL
              : (LANGS.includes(preferred) ? preferred : "es");

  // ---------- HELPERS ----------
  const $ = sel => document.querySelector(sel);
  const setText = (sel, val, show=true) => {
    const el = $(sel);
    if (!el) return;
    if (val) { el.textContent = val; if (show) el.parentElement?.style && (el.parentElement.style.display = ""); }
    else { if (show) el.parentElement?.style && (el.parentElement.style.display = "none"); }
  };
  const show = (id, on=true) => { const el = $(id); if (el) el.style.display = on ? "" : "none"; };
  const fillList = (ulSel, arr) => {
    const ul = $(ulSel); if (!ul) return;
    ul.innerHTML = "";
    (arr||[]).forEach(x => {
      const li = document.createElement("li");
      li.textContent = (typeof x === "string") ? x : (x?.label || JSON.stringify(x));
      ul.appendChild(li);
    });
  };

  // ---------- BUILD JSON URL ----------
  async function fetchFicha(langTry){
    const url = `${CDN_BASE}/${VINO_ID}/${ANYADA}/${langTry}/ficha.json`;
    const res = await fetch(url, { cache: "no-store" });
    if (!res.ok) throw new Error(`No ficha for ${langTry}`);
    return res.json();
  }

  async function loadFicha(){
    let ficha = null;
    try { ficha = await fetchFicha(LANG); }
    catch {
      if (LANG !== "es") {
        try { ficha = await fetchFicha("es"); }
        catch (e) { console.error(e); }
      }
    }
    return ficha;
  }

  // ---------- WEBHOOKS ----------
  function beacon(url, payload){
    try {
      const blob = new Blob([JSON.stringify(payload)], { type: "application/json" });
      navigator.sendBeacon(url, blob);
    } catch(e) { /* noop */ }
  }

  function logScan(ids){
    beacon(N8N.SCAN, { ...ids, Ubicacion: SRC });
  }
  function logCTA(ids, cta){
    beacon(N8N.CTA, { ...ids, Ubicacion: SRC, CTA: cta });
  }
  function postLead(ids, data){
    return fetch(N8N.LEAD, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ ...ids, ...data })
    });
  }

  // ---------- RENDER ----------
  function renderFicha(f){
    const title = f.title || f?.content?.title || "Vino";
    $("#title").textContent = title;

    const subtitle = f.subtitle || f?.content?.subtitle || "";
    $("#subtitle").textContent = subtitle;

    const doText = f.do || f.region || "";
    if (doText) { $("#do").style.display="inline-block"; $("#do").textContent = doText; }

    const variedad = f.variedad || f.grape || "";
    if (variedad) { $("#variedad").style.display="inline-block"; $("#variedad").textContent = variedad; }

    const img = f?.assets?.image_url || f.image;
    if (img) { $("#heroImg").src = img; $("#heroImg").alt = title; show("#hero", true); }

    const nar = f?.content?.narrative_text || f?.narrative || "";
    if (nar) { $("#narrativeText").textContent = nar; show("#narrativa", true); }

    const audio = f?.assets?.audio_url;
    if (audio) {
      $("#audioWrap").innerHTML = `<audio controls preload="none" style="width:100%"><source src="${audio}" type="audio/mpeg"></audio>`;
      show("#narrativa", true);
    }

    // Organol√©ptico (listas)
    const org = f?.modules?.organoleptico || {};
    const visual = org?.visual || [];
    const aroma  = org?.aroma  || [];
    const boca   = org?.boca   || [];
    const mar    = f?.modules?.maridaje || f?.maridaje || [];
    const anyOrg = (visual.length+aroma.length+boca.length+mar.length) > 0;
    if (anyOrg) {
      fillList("#org-visual", visual);
      fillList("#org-aroma", aroma);
      fillList("#org-boca", boca);
      fillList("#org-maridaje", mar);
      show("#organoleptico", true);
    }

    const curio = f?.modules?.curiosidad || f?.curiosidad || "";
    if (curio) { $("#curioText").textContent = curio; show("#curiosidad", true); }

    // CTAs (deshabilitar si no hay URL)
    const compraUrl  = f?.cta?.compra?.url || f.buy_url || null;
    const reservaUrl = f?.cta?.reserva?.url || f.book_url || null;

    const compraFinal  = withUtm(compraUrl, SRC);
    const reservaFinal = withUtm(reservaUrl, SRC);

    const btnComprar  = $("#btnComprar");
    const btnReservar = $("#btnReservar");

    if (compraFinal) { btnComprar.disabled = false; btnComprar.dataset.href = compraFinal; }
    if (reservaFinal){ btnReservar.disabled = false; btnReservar.dataset.href = reservaFinal; }

    // Footer debug simple
    $("#foot").textContent = `ID: ${VINO_ID}/${ANYADA} ¬∑ lang=${LANG} ¬∑ src=${SRC}`;
  }

  // ---------- BOOT ----------
  (async function boot(){
    if (!VINO_ID || !ANYADA) {
      $("#title").textContent = "Ruta inv√°lida";
      return;
    }

    const ficha = await loadFicha();
    if (!ficha) {
      $("#title").textContent = "Ficha no disponible";
      return;
    }

    renderFicha(ficha);

    // IDs para anal√≠tica (Bodega_ID opcional; si lo tienes en ficha.ids, √∫salo)
    const Bodega_ID = ficha?.ids?.Bodega_ID || null;
    const ids = { Bodega_ID, ID_Vino: VINO_ID, ID_A√±ada: `${VINO_ID}-${ANYADA}` };

    // Scan al cargar (no bloquea)
    logScan(ids);

    // CTA handlers
    $("#btnComprar").addEventListener("click", (e)=>{
      const url = e.currentTarget.dataset.href || null;
      logCTA(ids, "comprar");
      if (url) setTimeout(()=>location.href=url, 40);
    });

    $("#btnReservar").addEventListener("click", (e)=>{
      const url = e.currentTarget.dataset.href || null;
      logCTA(ids, "reservar");
      if (url) setTimeout(()=>location.href=url, 40);
    });

    // Si activas el bot√≥n de lead en el HTML:
    // document.getElementById("btnSolicitar").addEventListener("click", async ()=>{
    //   const Nombre = prompt("Tu nombre"); if(!Nombre) return;
    //   const contacto = prompt("Email o WhatsApp"); if(!contacto) return;
    //   const Email = /@/.test(contacto) ? contacto : null;
    //   const WhatsApp = Email ? null : contacto;
    //   const FechaPreferida = prompt("Fecha preferida (YYYY-MM-DD)") || null;
    //   const Personas = parseInt(prompt("Personas")||"2",10);
    //   await postLead(ids, { Nombre, Email, WhatsApp, FechaPreferida, Personas, Estado: "Nuevo", Notas: "" });
    //   alert("Solicitud enviada ‚úÖ");
    // });
  })();
})();
</script>
</body>
</html>
