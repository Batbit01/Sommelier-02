<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>SommelierLab ¬∑ Ficha del vino</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{ --accent-color:#c79a5a; }
    body{ background:#0f0a0a; color:#fff; }
    .fade-in{ animation:fadeIn .35s ease-out both }
    @keyframes fadeIn{ from{opacity:0;transform:translateY(4px)} to{opacity:1;transform:none} }
  </style>
</head>
<body class="min-h-screen">
  <div id="app" class="max-w-[1100px] mx-auto px-4 sm:px-6 pb-24"></div>

  <script>
  const CDN_BASE  = "https://f005.backblazeb2.com/file/SommelierLab-media";
  const CDN_QR2   = CDN_BASE + "/qr2";
  const AUDIO_BASE = CDN_BASE + "/qr2/audio";

  const UI = {
    es:{share:"Compartir",gallery:"Galer√≠a",social:"Redes y contacto",sommelier:"Hablar con el sommelier",legal:"Bebe con responsabilidad",org_title:"Perfil sensorial",tech_title:"Ficha t√©cnica"},
    en:{share:"Share",gallery:"Gallery",social:"Social & contact",sommelier:"Talk to sommelier",legal:"Drink responsibly",org_title:"Sensory profile",tech_title:"Technical sheet"},
    fr:{share:"Partager",gallery:"Galerie",social:"R√©seaux et contact",sommelier:"Parler au sommelier",legal:"Buvez avec mod√©ration",org_title:"Profil sensoriel",tech_title:"Fiche technique"}
  };

  const state = { query:{}, data:null, t:UI.es };

  function getQuery(){
    const p=new URLSearchParams(location.search);
    return {
      vino_id: p.get("vino_id")||"",
      anyada:  p.get("anyada")||"",
      lang:   (p.get("lang")||"es").slice(0,2).toLowerCase(),
      context: p.get("context")||""
    };
  }

  async function fetchCDN(vino_id,anyada,lang){
    const tries = [
      `${CDN_QR2}/${vino_id}/${anyada}/${lang}/ficha.json`,
      `${CDN_QR2}/${vino_id}/${anyada}/es/ficha.json`,
      `${CDN_QR2}/${vino_id}/${anyada}/en/ficha.json`,
    ];
    let last=null;
    for(const url of tries){
      try{
        const res = await fetch(url,{cache:'no-cache'});
        if(res.ok){
          const json = await res.json();
          json.__cdn_url = url;
          json.__cdn_lang = url.split("/").slice(-2)[0];
          return json;
        } else last = res.status;
      }catch(e){ last = e; }
    }
    throw new Error("No se pudo cargar la ficha desde CDN ("+last+")");
  }

  // tu ruta correcta de audio
  async function fetchAudioUrl(vino_id,anyada,lang){
    const routes = [
      `${AUDIO_BASE}/${vino_id}/${anyada}/${lang}/base.mp3`,  // la que t√∫ dices
      `${AUDIO_BASE}/${vino_id}/${anyada}/${lang}/audio.mp3`,
      `${AUDIO_BASE}/${vino_id}/${lang}/base.mp3`,
      `${AUDIO_BASE}/${vino_id}/${lang}/audio.mp3`,
    ];
    for(const u of routes){
      try{
        const head = await fetch(u,{method:"HEAD"});
        if(head.ok) return u;
      }catch(e){}
    }
    return null;
  }

  // normalizaci√≥n m√≠nima: si ya viene "ficha" la dejamos
  function normalize(raw, q){
    // solo a√±ado lo que falta
    if(!raw.lang) raw.lang = q.lang;
    if(!raw.ficha) raw.ficha = {};
    if(!raw.ficha.context) raw.ficha.context = q.context || "";
    return raw;
  }

  function renderHeader(d){
    const f = d.ficha||{};
    const langs = [d.lang || d.__cdn_lang || state.query.lang || "es"];
    return `
      <header class="py-4 flex items-center justify-between gap-3">
        <div>
          <div class="text-sm text-neutral-200">${f.bodega||''}</div>
          <div class="text-3xl font-semibold leading-tight">${f.title || f.nombre || (f.vino && f.vino["Nombre del vino"]) || ''}</div>
          <div class="mt-2 flex gap-2">
            ${ (f.do || (f.vino && f.vino["Origen/DO"])) ? `<span class="px-3 py-1 rounded-full bg-neutral-900 border border-neutral-700 text-sm">${f.do || (f.vino && f.vino["Origen/DO"])}</span>` : '' }
            ${ (f.variedad || (f.vino && f.vino["Variedad de uva"])) ? `<span class="px-3 py-1 rounded-full bg-neutral-900 border border-neutral-700 text-sm">${f.variedad || (f.vino && f.vino["Variedad de uva"])}</span>` : '' }
          </div>
          <div class="text-[10px] text-neutral-500 mt-1">CDN: ${d.__cdn_url||'‚Äì'} (${d.__cdn_lang||'?'})</div>
        </div>
        <div class="flex items-center gap-3">
          <select id="langSel" class="bg-neutral-900 border border-neutral-700 rounded-lg px-2 py-1 text-sm">
            ${langs.map(l=>`<option value="${l}" ${l===(d.lang||'es')?'selected':''}>${l.toUpperCase()}</option>`).join('')}
          </select>
          <button id="shareBtn" class="text-amber-400 underline">${state.t.share}</button>
        </div>
      </header>
      <hr class="border-neutral-800 mb-4">
    `;
  }

  function renderHero(d){
    // en tu json la imagen est√° en varios sitios
    const f = d.ficha||{};
    const img =
      (f.vino && Array.isArray(f.vino.Imagen) && f.vino.Imagen[0] && f.vino.Imagen[0].url) ||
      f.imagen ||
      (d.assets && d.assets.image_url) ||
      (d.for_front && d.for_front.header && d.for_front.header.imagen) ||
      "";
    if(!img) return "";
    return `
      <section class="mb-6">
        <img src="${img}" alt="bottle" class="w-40 h-64 object-contain border border-neutral-800 rounded-xl bg-neutral-900 mx-auto shadow-lg">
      </section>
      <hr class="border-neutral-800 mb-4">
    `;
  }

  function renderNarrativa(d){
    const f = d.ficha||{};
    let texto = "";
    // caso 1: string directa
    if (typeof f.narrativa === "string") {
      texto = f.narrativa;
    }
    // caso 2: objeto
    else if (f.narrativa && typeof f.narrativa.texto === "string") {
      texto = f.narrativa.texto;
    }
    // caso 3: for_front
    else if (d.for_front && typeof d.for_front.narrativa_es === "string") {
      texto = d.for_front.narrativa_es;
    }
    if(!texto && !f.narrativa?.audio_url) return "";
    return `
      <section class="mb-6">
        <h2 class="text-xl font-semibold mb-3">${state.t.sommelier}</h2>
        ${ texto ? `<p class="text-neutral-100 leading-relaxed mb-3">${texto.replace(/\n/g,"<br>")}</p>` : '' }
        ${ f.narrativa && f.narrativa.audio_url
            ? `<audio controls class="w-full"><source src="${f.narrativa.audio_url}" type="audio/mpeg"></audio>`
            : `<p class="text-xs text-neutral-500">Audio no disponible.</p>` }
      </section>
      <hr class="border-neutral-800 mb-4">
    `;
  }

  function renderOrganoleptico(d){
    // puede venir en d.ficha.organoleptico o en d.organoleptico (ra√≠z)
    const o = (d.ficha && d.ficha.organoleptico) ? d.ficha.organoleptico : (d.organoleptico || {});
    const texto = o.texto || "";
    const temp  = (o.servicio && o.servicio.temperatura) ? o.servicio.temperatura : "";
    if (!texto && !temp) return "";
    return `
      <section class="mb-6">
        <h2 class="text-lg font-semibold mb-3">${state.t.org_title}</h2>
        ${ texto ? `<p class="text-sm text-neutral-200 leading-relaxed mb-2">${texto.replace(/\n/g,"<br>")}</p>` : '' }
        ${ temp ? `<p class="text-xs text-neutral-400">Temperatura de servicio: ${temp}</p>` : '' }
      </section>
      <hr class="border-neutral-800 mb-4">
    `;
  }

  function renderTech(d){
    const f = d.ficha || {};
    const v = f.vino || {};
    const blocks = [];

    if (f.Elaboraci√≥n) blocks.push({title:"Elaboraci√≥n", body:f.Elaboraci√≥n});
    if (f["Proceso de crianza"]) blocks.push({title:"Proceso de crianza", body:f["Proceso de crianza"]});
    if (v["Proceso de crianza"]) blocks.push({title:"Proceso de crianza", body:v["Proceso de crianza"]});
    if (v["Notas de cata"]) blocks.push({title:"Notas de cata", body:v["Notas de cata"]});
    if (!blocks.length) return "";

    return `
      <section class="mb-6">
        <h2 class="text-lg font-semibold mb-3">${state.t.tech_title}</h2>
        <div class="space-y-3">
          ${blocks.map(b=>`
            <details class="bg-neutral-900/30 border border-neutral-800 rounded-xl p-3">
              <summary class="cursor-pointer text-sm font-medium text-neutral-50">${b.title}</summary>
              <div class="mt-2 text-sm text-neutral-200">${String(b.body).replace(/\n/g,"<br>")}</div>
            </details>
          `).join("")}
        </div>
      </section>
      <hr class="border-neutral-800 mb-4">
    `;
  }

  function renderSocial(d){
    const s = d.social || {};
    const b = d.bodega_info || {};
    const web = s.web || b["Web URL"];
    const email = s.email || b["Email de contacto"];
    if (!web && !email) return "";
    return `
      <section class="mb-10">
        <h2 class="text-lg font-semibold mb-3">${state.t.social}</h2>
        <div class="flex gap-4">
          ${ web ? `<a href="${web}" target="_blank" class="underline text-amber-400">Web</a>` : '' }
          ${ email ? `<a href="mailto:${email}" class="underline text-amber-400">Email</a>` : '' }
        </div>
      </section>
    `;
  }

  function renderFooter(){
    return `
      <footer class="py-10 text-center text-neutral-500 text-sm">
        ${UI.es.legal}
      </footer>
    `;
  }

  function attachEvents(d){
    const sel = document.querySelector('#langSel');
    if(sel){
      sel.addEventListener('change',()=>{
        const url = new URL(location.href);
        url.searchParams.set('lang', sel.value);
        location.href = url.toString();
      });
    }
    const sb = document.querySelector('#shareBtn');
    if(sb){
      sb.addEventListener('click', async ()=>{
        try{
          if(navigator.share){
            await navigator.share({title:document.title,url:location.href});
          }else{
            await navigator.clipboard.writeText(location.href);
            sb.textContent = "Copiado";
            setTimeout(()=>sb.textContent=state.t.share,1000);
          }
        }catch(e){}
      });
    }
  }

  async function boot(){
    state.query = getQuery();
    if(!state.query.vino_id || !state.query.anyada){
      document.querySelector('#app').innerHTML = '<div class="p-4 text-red-400">Faltan ?vino_id y ?anyada</div>';
      return;
    }
    try{
      let raw = await fetchCDN(state.query.vino_id, state.query.anyada, state.query.lang);
      // intentar audio con la ruta que t√∫ has definido
      const audioUrl = await fetchAudioUrl(state.query.vino_id, state.query.anyada, (raw.lang||state.query.lang));
      if (audioUrl) {
        if (!raw.ficha) raw.ficha = {};
        if (typeof raw.ficha.narrativa === "string") {
          raw.ficha.narrativa = { texto: raw.ficha.narrativa, audio_url: audioUrl };
        } else {
          if (!raw.ficha.narrativa) raw.ficha.narrativa = {};
          raw.ficha.narrativa.audio_url = audioUrl;
        }
      }
      const data = normalize(raw, state.query);
      state.data = data;
      state.t = UI[(data.lang||state.query.lang)||'es'] || UI.es;

      const html = [
        renderHeader(data),
        renderHero(data),
        renderNarrativa(data),
        renderOrganoleptico(data),
        renderTech(data),
        renderSocial(data),
        renderFooter()
      ].join("");

      document.querySelector('#app').innerHTML = html;
      attachEvents(data);
    }catch(e){
      document.querySelector('#app').innerHTML = '<div class="p-4 text-red-400">Error cargando ficha: '+e.message+'</div>';
    }
  }

  boot();
  </script>

  <!-- flotante sommelier -->
  <style>
    #sommelier-float{position:fixed;right:16px;bottom:90px;z-index:50;background:linear-gradient(120deg,#fbbf24,#d97706);padding:10px 18px;border-radius:9999px;display:flex;gap:10px;align-items:center;box-shadow:0 0 26px rgba(0,0,0,.35);cursor:pointer}
  </style>
  <div id="sommelier-float">üéô <span>Preguntar al sommelier</span></div>
</body>
</html>
