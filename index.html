<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
  <title id="vinoTitle">Ficha del Vino</title>

  <style>
    body { font-family: sans-serif; padding: 2rem; background-color: #fefefe; color: #222; max-width: 700px; margin: auto; }
    .vino-ficha img { width: 100%; max-height: 300px; object-fit: contain; border-radius: 1rem; }
    .vino-dato { margin-bottom: 1rem; }
    .vino-dato strong { display: inline-block; width: 100px; }
    #respuesta { margin-top: 2rem; font-style: italic; background: #f1f1f1; padding: 1rem; border-radius: 0.5rem; }
    #hablar { display: inline-block; margin-top: 2rem; padding: 0.75rem 1.5rem; background: #800000; color: white; border: none; border-radius: 1rem; cursor: pointer; transition: background .2s; font-weight: bold;}
    #hablar[disabled] { background: #a09797; color: #fff; cursor: not-allowed; }
    .redes a { margin-right: 1rem; text-decoration: none; color: #800000; }

    /* Compartir */
    #modulo-compartir { margin: 2rem 0 0.5rem 0; position: relative; display: flex; flex-direction: column; align-items: flex-start; }
    #btn-compartir {
      background: #fff; color: #800000; border: 2px solid #800000; border-radius: 2rem;
      padding: 0.5rem 1.25rem 0.5rem 0.75rem; font-weight: 600; font-size: 1.07rem;
      display: flex; align-items: center; gap: 0.55rem; cursor: pointer;
      transition: background 0.2s, box-shadow 0.2s; box-shadow: 0 2px 6px #80000011;
    }
    #btn-compartir:hover { background: #f8eaea; box-shadow: 0 4px 12px #8000001a; }
    #btn-compartir svg { flex-shrink: 0; }
    #menu-compartir {
      display: none; position: absolute; top: 110%; left: 0; background: #fff; border: 1.5px solid #e5dede;
      border-radius: 1.3rem; box-shadow: 0 6px 28px #80000012; min-width: 240px; padding: 0.5rem 0; z-index: 40;
      animation: fadeInCompartir 0.32s; transition: opacity 0.22s, transform 0.2s;
    }
    @keyframes fadeInCompartir { from { opacity: 0; transform: translateY(12px);} to { opacity: 1; transform: translateY(0);} }
    #menu-compartir.open { display: block; }
    .menu-item-compartir {
      display: flex; align-items: center; gap: 0.7rem; padding: 0.62rem 1.1rem; cursor: pointer;
      color: #700d18; font-size: 1.02rem; background: none; border: none; width: 100%;
      transition: background 0.17s, color 0.17s;
    }
    .menu-item-compartir:hover, .menu-item-compartir:focus { background: #f8eaea; color: #c9003f; outline: none; }
    .menu-item-compartir svg { width: 1.35em; height: 1.35em; display: block; }
    .menu-item-compartir.copiado { color: #218838; font-weight: 600; }

    /* Radar */
    #radar-svg-container {
      width: 100%; max-width: 520px; margin: 0 auto 2.5rem auto; background: #f8f4f2;
      border-radius: 22px; box-shadow: 0 2px 24px #0001; padding: 2.5rem 0; display: flex; flex-direction: column; align-items: center;
    }
    .switch-buttons { display: flex; justify-content: center; gap: 0.7rem; margin-bottom: 1.6rem; }
    .switch-buttons button {
      background-color: #a97c7c; color: white; border: 2px solid #800000; padding: 0.65rem 1.25rem;
      border-radius: 20px; cursor: pointer; transition: all 0.3s; font-weight: bold;
    }
    .switch-buttons button:hover { background-color: #800000; }
    .switch-buttons button.active { background-color: #800000; box-shadow: 0 0 10px rgba(128,0,0,0.5 ); }
    #radarSVG { background: none; display: block; margin: 0 auto; }
    .radar-label { font-size: 1rem; font-weight: bold; fill: #800000; text-anchor: middle; alignment-baseline: middle; pointer-events: none; }

    /* Valoraciones */
    #score-container, #valoracion-container { margin-top: 3rem; }
    #score-bar { width: 100%; height: 20px; background-color: #ddd; border-radius: 10px; overflow: hidden; }
    #score-fill { height: 100%; background-color: #800000; text-align: center; line-height: 20px; color: white; font-size: 0.9rem; }
    #estrellas .estrella { font-size: 2rem; color: #ccc; cursor: pointer; }
    #estrellas .estrella.seleccionada { color: #800000; }
    #estrellas-nota { color: #800000; font-size: 1.8rem; vertical-align: middle; }
    #lista-comentarios .comentario { margin-bottom: 1rem; padding: 0.75rem; border: 1px solid #ddd; border-radius: 0.5rem; background-color: #fafafa; text-align: left; }

    /* Sommelier (candado QR) */
    #modulo-sommelier { margin-bottom: 2.3rem; }
    #modulo-sommelier #sommelier-aviso {
      margin-top:0.7rem; color:#7b7171; background:#f7f3f0; padding:1rem 1.2rem;
      border-radius:1.1rem; font-size:1.07rem; display:flex; align-items:center; gap:0.7rem;
    }
  </style>

  <!-- Plyr.io CSS -->
  <link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" />
  <style>
    /* Personalización Plyr */
    .plyr--audio .plyr__controls { background: #f1f1f1; border-radius: 2rem; box-shadow: 0 2px 12px #80000012; }
    .plyr__control.plyr__control--overlaid, .plyr__control { background: #800000; color: #fff; }
    .plyr__control[aria-pressed="true"], .plyr__control:hover { background: #a97c7c; color: #fff; }
    .plyr__progress--played, .plyr__volume--display { color: #800000; background: #a97c7c; }
    .plyr__progress input[type=range]::-webkit-slider-thumb { background: #800000; }
    .plyr__menu__container, .plyr__menu__container label { color: #800000; }
  </style>
</head>

<body>
  <h1 id="vinoTitulo">Ficha del Vino</h1>
  <div class="vino-ficha">
    <img alt="Imagen del vino" id="vinoImagen" src=""/>
    <div class="vino-dato"><strong>Tipo:</strong> <span id="vinoTipo">-</span></div>
    <div class="vino-dato"><strong>Origen:</strong> <span id="vinoOrigen">-</span></div>
    <div class="vino-dato"><strong>Variedad:</strong> <span id="vinoUva">-</span></div>
    <div class="vino-dato"><strong>Bodega:</strong> <span id="bodegaNombre">-</span></div>
    <div class="vino-dato redes" id="bodega-redes"></div>
  </div>

  <!-- MÓDULO COMPARTIR -->
  <div id="modulo-compartir">
    <button id="btn-compartir" aria-label="Compartir ficha" title="Compartir ficha">
      <svg width="28" height="28" viewBox="0 0 24 24" fill="none"><path d="M13.2 5.9l2.4-2.4a1.5 1.5 0 1 1 2.1 2.1l-2.5 2.5M16.8 8.6a7 7 0 1 1-2.6-2.6" stroke="#800000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
      Compartir
    </button>
    <div id="menu-compartir"></div>
  </div>
  
  <!-- Botón Sommelier (aparece solo si el módulo está activo) -->
  <button id="btnSommelier" hidden aria-controls="somm-modal">
  Hablar con el sommelier
  </button>

  <!-- MÓDULO SOMMELIER VIRTUAL -->
  <div id="modulo-sommelier">
    <button id="hablar" disabled style="opacity:0.6;pointer-events:none;">
      <svg width="23" height="23" style="vertical-align:middle; margin-right:7px;" viewBox="0 0 20 20" fill="none"><circle cx="10" cy="10" r="8.5" stroke="#888" stroke-width="1.6"/><path d="M10 6.5v4.2M10 14h.01" stroke="#888" stroke-width="1.5" stroke-linecap="round"/></svg>
      Hablar con el sommelier
    </button>
    <div id="sommelier-aviso">
      <svg width="23" height="23" viewBox="0 0 20 20" fill="none"><circle cx="10" cy="10" r="8.5" stroke="#888" stroke-width="1.6"/><path d="M10 6.5v4.2M10 14h.01" stroke="#888" stroke-width="1.5" stroke-linecap="round"/></svg>
      Para vivir la experiencia del Sommelier Virtual, escanea el QR en la botella.
    </div>
  </div>

  <!-- NARRATIVA -->
  <div id="respuesta">Cargando descripción del vino...</div>
  <div id="bloque-audio-narrativa" style="margin:2.5rem 0; display:none;">
    <h3 style="margin-bottom:0.7rem; color: #800000;">Narrativa del sommelier</h3>
    <audio id="player" controls>
      Tu navegador no soporta audio HTML5.
    </audio>
  </div>

  <!-- RADAR -->
  <div id="radar-svg-container">
    <h3 style="margin-bottom:1.7rem;">Perfil organoléptico</h3>
    <div class="switch-buttons">
      <button id="btn-aromatico" onclick="setRadarType('aromatico')">Aromático</button>
      <button id="btn-gustativo" onclick="setRadarType('gustativo')">Gustativo</button>
      <button id="btn-sensorial" onclick="setRadarType('sensorial')">Sensorial</button>
    </div>
    <svg id="radarSVG" width="430" height="430"></svg>
  </div>

  <!-- VALORACIONES -->
  <div id="score-container">
    <h3>Puntuación Total</h3>
    <div id="score-bar"><div id="score-fill" style="width: 0%">0</div></div>
    <div id="rating-summary" style="display: flex; align-items: center; gap: 0.5rem; margin-top: 1rem;">
      <span id="media-nota" style="font-size:2rem; font-weight:bold;">-</span>
      <span id="estrellas-nota" style="font-size:1.5rem; color: #800000;"></span>
      <span id="total-valoraciones" style="font-size:1rem; color:#555;"></span>
    </div>
  </div>

  <div id="valoracion-container">
    <h3>Valora este vino</h3>
    <div id="estrellas">
      <span class="estrella" data-value="1">★</span><span class="estrella" data-value="2">★</span><span class="estrella" data-value="3">★</span><span class="estrella" data-value="4">★</span><span class="estrella" data-value="5">★</span>
    </div>
    <textarea id="comentario" placeholder="Deja un comentario sobre el vino..." rows="4" style="width:100%; margin-top: 1rem; padding: 0.5rem;"></textarea>
    <button id="enviar-valoracion" style="margin-top: 1rem; background:#800000; color:white; border:none; padding:0.5rem 1rem; border-radius:0.5rem; cursor:pointer;">Enviar valoración</button>
    <p id="mensaje-valoracion" style="margin-top:1rem; color: green;"></p>
  </div>

  <div id="comentarios-container" style="margin-top: 3rem;">
    <h3 style="cursor:pointer; color:#800000;" onclick="toggleComentarios()">▼ Comentarios de otros usuarios</h3>
    <div id="lista-comentarios" style="max-height: 0; overflow: hidden; transition: max-height 0.5s ease-out;">
      <p style="padding: 1rem 0;">Cargando comentarios...</p>
    </div>
  </div>

  <!-- JS LIB Plyr -->
  <script src="https://cdn.plyr.io/3.7.8/plyr.polyfilled.js"></script>
<script>
/* ========= SOLO CDN: leer ficha.json y pintar ========= */

/* --- Contexto e URL --- */
function parseFromPath(){const s=location.pathname.split('/').filter(Boolean),i=s.findIndex(t=>t.toLowerCase()==='qr2');if(i>=0&&s.length>=i+4)return{vino_id:s[i+1],anyada:s[i+2],lang:s[i+3]};return{vino_id:null,anyada:null,lang:null}}
function parseFromQuery(){const q=new URLSearchParams(location.search);let vino=(q.get('vino_id')||"").trim(),any=(q.get('anyada')||"").trim(),lang=(q.get('lang')||"").trim().slice(0,2).toLowerCase();if(vino&&/(^|\/)qr2\//i.test(vino)){const s=vino.replace(/^\/+/,'').split('/').filter(Boolean),i=Math.max(0,s.findIndex(t=>t.toLowerCase()==='qr2'));vino=s[i+1]||vino;any=s[i+2]||any;lang=(s[i+3]||lang||navigator.language||'es').slice(0,2).toLowerCase()}return{vino_id:vino||null,anyada:any||null,lang:lang||null}}
function resolveCtx(){const p=parseFromPath(),q=parseFromQuery();return{vino_id:q.vino_id||p.vino_id||"",anyada:q.anyada||p.anyada||"",lang:(q.lang||p.lang||(navigator.language||'es')).slice(0,2).toLowerCase()}}
function currentFichaUrl(ctx){
  if(ctx.vino_id&&ctx.anyada&&ctx.lang){
    const CDN="https://f005.backblazeb2.com/file/SommelierLab-media";
    return `${CDN}/qr2/${ctx.vino_id}/${ctx.anyada}/${ctx.lang}/ficha.json`;
  }
  const s=location.pathname.split('/').filter(Boolean),i=s.findIndex(t=>t.toLowerCase()==='qr2');
  if(i>=0&&s.length>=i+4) return new URL('./ficha.json',location.href).href;
  return null;
}

/* --- Fetch JSON --- */
async function loadFicha(url){
  if(!url) throw new Error("No se pudo construir la URL de ficha.json");
  const res=await fetch(url,{cache:'no-store'});
  const ct=(res.headers.get('content-type')||'').toLowerCase();
  console.log('[ficha.json]', url, res.status, ct);
  if(!res.ok) throw new Error(`HTTP ${res.status} en ${url}`);
  if(!ct.includes('application/json')) throw new Error(`MIME inesperado: ${ct}`);
  return await res.json();
}

/* --- Pintado básicos (con tus claves) --- */
function paintBasics(d){
  const title=d?.title||d?.ficha?.title||"Ficha del Vino";
  const img  =d?.assets?.image_url||d?.ficha?.assets?.image_url||"";
  document.title=document.getElementById("vinoTitulo").innerText=title;
  if(img) document.getElementById("vinoImagen").src=img;

  document.getElementById("vinoTipo").innerText   = d?.tipo||d?.ficha?.tipo||"-";
  document.getElementById("vinoUva").innerText    = d?.variedad||d?.ficha?.variedad||"-";
  document.getElementById("vinoOrigen").innerText = d?.do||d?.ficha?.do||"-";
  document.getElementById("bodegaNombre").innerText = d?.bodega||d?.ficha?.bodega||"-";
}

/* --- Narrativa + audio robusto --- */
function guessMime(url){
  const u=(url||"").toLowerCase();
  if(u.endsWith('.mp3')) return 'audio/mpeg';
  if(u.endsWith('.m4a')||u.endsWith('.mp4')) return 'audio/mp4';
  if(u.endsWith('.ogg')||u.endsWith('.oga')) return 'audio/ogg';
  if(u.endsWith('.wav')) return 'audio/wav';
  return 'audio/mpeg';
}
function paintNarrativa(d){
  const texto = d?.narrative_text || d?.ficha?.narrativa?.texto || "";
  let   audio = d?.assets?.audio_url || d?.ficha?.narrativa?.audio_url || "";
  const respuestaEl=document.getElementById("respuesta");
  const bloqueAudio=document.getElementById("bloque-audio-narrativa");
  const player=document.getElementById("player");

  respuestaEl.innerText = texto || "—";

  if(audio && /^http:\/\//i.test(audio)) audio = audio.replace(/^http:\/\//i,'https://');
  if(audio){
    player.setAttribute('crossorigin','anonymous'); // ayuda con CORS media
    player.setAttribute('preload','metadata');
    player.innerHTML="";
    const src=document.createElement('source');
    src.src=audio;
    src.type=guessMime(audio);
    player.appendChild(src);
    player.load();
    player.oncanplay = ()=>{ /* OK */ };
    player.onerror = (e)=>{
      console.error('Audio error', {src:audio, type:src.type, code:player.error?.code, mediaError:player.error});
      console.warn('Revisa CORS y MIME en Backblaze para el audio: Access-Control-Allow-Origin y Content-Type correctos.');
    };
    try{ if(player._plyr) player._plyr.destroy(); }catch{}
    player._plyr=new Plyr(player,{speed:{selected:1,options:[0.75,1,1.25,1.5,2]}});
    bloqueAudio.style.display="block";
  }else{
    bloqueAudio.style.display="none";
  }
}

/* --- Organoléptico: soporta números (radar) o arrays de texto (chips) --- */
const perfilesRadar={
  aromatico:{labels:["Fruta","Floral","Cítrico","Herbáceo","Especiado","Tostado"],keys:["fruta","floral","citrico","herbaceo","especiado","tostado"]},
  gustativo:{labels:["Cuerpo","Acidez","Dulzor","Taninos","Persistencia","Equilibrio"],keys:["cuerpo","acidez","dulzor","taninos","persistencia","equilibrio"]},
  sensorial:{labels:["Frescura","Mineralidad","Alcohol","Complejidad","Armonía","Intensidad"],keys:["frescura","mineralidad","alcohol_percibido","complejidad","armonia","intensidad"]}
};
let radarType="aromatico";
window.setRadarType=function(t){
  radarType=t;
  document.querySelectorAll('.switch-buttons button').forEach(b=>b.classList.remove('active'));
  document.getElementById(`btn-${t}`)?.classList.add('active');
  renderOrgano(window.__ORGANO__||{});
};

function ensureChipsBox(){
  let el=document.getElementById('organo-chips');
  if(!el){
    el=document.createElement('div');
    el.id='organo-chips';
    Object.assign(el.style,{margin:'0.8rem auto 0',display:'flex',flexWrap:'wrap',gap:'0.5rem',maxWidth:'520px'});
    document.getElementById('radar-svg-container').insertBefore(el, document.getElementById('radarSVG'));
  }
  return el;
}
function paintChips(arr){
  const box=ensureChipsBox();
  box.innerHTML="";
  (arr||[]).forEach(t=>{
    const s=document.createElement('span');
    s.textContent=String(t);
    Object.assign(s.style,{padding:'0.35rem 0.7rem',border:'1px solid #e0c9c9',borderRadius:'999px',background:'#fff',color:'#800000',fontSize:'0.95rem',boxShadow:'0 2px 8px #80000014'});
    box.appendChild(s);
  });
}

function polarToCartesian(cx,cy,r,a){return[cx+r*Math.cos(a),cy+r*Math.sin(a)]}
function drawRadar(values,cfg){
  const svg=document.getElementById("radarSVG");
  svg.innerHTML=`<rect x="0" y="0" width="430" height="430" fill="#f8f4f2"/>`;
  const N=cfg.labels.length,R=155,cx=215,cy=215,min=0,max=10;
  for(let c=1;c<=5;c++){const r=(R*c)/5,mesh=[];for(let i=0;i<N;i++){const ang=-Math.PI/2+(2*Math.PI*i)/N;mesh.push(polarToCartesian(cx,cy,r,ang))}svg.innerHTML+=`<polygon points="${mesh.map(p=>p.join(',')).join(' ')}" fill="none" stroke="#d7bebe" stroke-width="1"/>`}
  for(let i=0;i<N;i++){const ang=-Math.PI/2+(2*Math.PI*i)/N;const[x2,y2]=polarToCartesian(cx,cy,R,ang);svg.innerHTML+=`<line x1="${cx}" y1="${cy}" x2="${x2}" y2="${y2}" stroke="#bfa1a1" stroke-width="1"/>`;const[lx,ly]=polarToCartesian(cx,cy,R+30,ang);svg.innerHTML+=`<text x="${lx}" y="${ly}" class="radar-label">${cfg.labels[i]}</text>`}
  const poly=[];for(let i=0;i<N;i++){const v=Number(values[i]??0),r=(v-min)/(max-min)*R,ang=-Math.PI/2+(2*Math.PI*i)/N;poly.push(polarToCartesian(cx,cy,r,ang))}
  svg.innerHTML+=`<polygon points="${poly.map(p=>p.join(',')).join(' ')}" fill="rgba(128,0,0,0.17)" stroke="#800000" stroke-width="3"/>`;
  for(let i=0;i<N;i++){const v=Number(values[i]??0),r=(v-min)/(max-min)*R,ang=-Math.PI/2+(2*Math.PI*i)/N;const[px,py]=polarToCartesian(cx,cy,r,ang);svg.innerHTML+=`<circle cx="${px}" cy="${py}" r="8" fill="#800000" stroke="white" stroke-width="2"/>`}
}

function renderOrgano(organo){
  // aceptar cualquiera de estas rutas
  const o = organo?.ficha?.organoleptico || organo?.modules?.organoleptico || organo?.organoleptico || {};
  const block = o?.[radarType];

  const svg=document.getElementById('radarSVG');
  const chipsBox=ensureChipsBox();

  if(Array.isArray(block) && block.length && typeof block[0]==='string'){
    svg.style.display='none'; chipsBox.style.display='flex'; paintChips(block); return;
  }
  const cfg=perfilesRadar[radarType];
  const values=cfg.keys.map(k=>Number((block||{})[k] ?? o[k] ?? 0));
  const hasNums=values.some(v=>!isNaN(v)&&v>0);
  if(hasNums){ chipsBox.style.display='none'; svg.style.display='block'; drawRadar(values,cfg); }
  else { svg.style.display='none'; chipsBox.style.display='none'; }
}

/* --- BOOT --- */
document.addEventListener("DOMContentLoaded", async function(){
  try{
    const CTX=resolveCtx();
    const params=new URLSearchParams(location.search);
    if(!params.has('lang')){ params.set('lang', CTX.lang); history.replaceState({},'',`${location.pathname}?${params.toString()}`); }

    const fichaUrl=currentFichaUrl(CTX);
    const data=await loadFicha(fichaUrl);
    window.__FICHA_DATA__=data;

    paintBasics(data);
    paintNarrativa(data);

    // Guardamos el organoléptico en las tres formas posibles
    window.__ORGANO__={ ficha:{organoleptico:data?.ficha?.organoleptico}, modules:{organoleptico:data?.modules?.organoleptico}, organoleptico:data?.organoleptico };
    document.getElementById('btn-aromatico')?.classList.add('active');
    renderOrgano(window.__ORGANO__);

    console.log('[lang]', CTX.lang, '[url]', fichaUrl);
  }catch(err){
    console.error("Error cargando ficha.json:", err);
    const r=document.getElementById("respuesta"); if(r) r.innerText="No se pudo cargar la ficha publicada de este vino.";
  }
});
</script>

 
</body>
</html>
