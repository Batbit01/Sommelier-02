<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Radar Sensorial SVG PRO</title>
    <style>
        body { font-family: sans-serif; background: #fefefe; color: #222; max-width: 600px; margin: 0 auto; padding: 2rem; }
        #radar-svg-container { display: flex; flex-direction: column; align-items: center; margin-top: 2rem; }
        .switch-buttons {
            display: flex;
            justify-content: center;
            gap: 0.7rem;
            margin-bottom: 1.2rem;
        }
        .switch-buttons button {
            background-color: #a97c7c;
            color: white;
            border: 2px solid #800000;
            padding: 0.55rem 1.15rem;
            border-radius: 18px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
            font-size: 1.05rem;
        }
        .switch-buttons button.active {
            background-color: #800000;
            box-shadow: 0 0 8px rgba(128,0,0,0.25);
        }
        #radarSVG {
            background: #f8f4f2;
            border-radius: 50%;
            box-shadow: 0 2px 16px #0001;
        }
        .radar-label {
            font-size: 1rem;
            font-weight: bold;
            fill: #800000;
            text-anchor: middle;
            alignment-baseline: middle;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <h1>Radar Sensorial SVG PRO</h1>
    <div id="radar-svg-container">
        <div class="switch-buttons">
            <button id="btn-aromatico" onclick="setRadarType('aromatico')">Aromático</button>
            <button id="btn-gustativo" onclick="setRadarType('gustativo')">Gustativo</button>
            <button id="btn-sensorial" onclick="setRadarType('sensorial')">Sensorial</button>
        </div>
        <svg id="radarSVG" width="360" height="360"></svg>
    </div>
<script>
// --- Mapeo de labels para cada perfil ---
const perfilesConfig = {
    gustativo: {
        labels: ["Cuerpo", "Acidez", "Dulzor", "Taninos", "Frescura", "Mineralidad"],
        fields: ["cuerpo", "acidez", "dulzor", "taninos", "frescura", "mineralidad"]
    },
    aromatico: {
        labels: ["Fruta", "Floral", "Especiado", "Tostado", "Herbáceo"],
        fields: ["fruta", "floral", "especiado", "tostado", "herbaceo"]
    },
    sensorial: {
        labels: ["Persistencia", "Complejidad", "Astringencia", "Alcohol", "Armonía"],
        fields: ["persistencia", "complejidad", "astringencia", "alcohol_percibido", "armonia"]
    }
};
let radarType = "aromatico";
let organo = {}; // aquí guardamos la respuesta de la API

function setRadarType(tipo) {
    radarType = tipo;
    document.querySelectorAll('.switch-buttons button').forEach(btn => btn.classList.remove('active'));
    document.getElementById(`btn-${tipo}`).classList.add('active');
    renderRadarSVG();
}

function polarToCartesian(cx, cy, r, angleRad) {
    return [
        cx + r * Math.cos(angleRad),
        cy + r * Math.sin(angleRad)
    ];
}

function renderRadarSVG() {
    const svg = document.getElementById("radarSVG");
    svg.innerHTML = "";

    const config = perfilesConfig[radarType];
    const N = config.labels.length;
    const R = 135;
    const cx = 180, cy = 180;
    const min = 0, max = 10;

    // Saca los valores reales del objeto organo:
    let values = config.fields.map(f => parseInt(organo[f]) || 0);

    // 1. Malla
    for (let c = 1; c <= 5; c++) {
        let r = (R * c) / 5;
        let mesh = [];
        for (let i = 0; i < N; i++) {
            let angle = -Math.PI / 2 + (2 * Math.PI * i) / N;
            mesh.push(polarToCartesian(cx, cy, r, angle));
        }
        svg.innerHTML += `<polygon points="${mesh.map(p=>p.join(',')).join(' ')}" fill="none" stroke="#d7bebe" stroke-width="1"/>`;
    }
    // 2. Líneas y labels
    for (let i = 0; i < N; i++) {
        let angle = -Math.PI / 2 + (2 * Math.PI * i) / N;
        let [x2, y2] = polarToCartesian(cx, cy, R, angle);
        svg.innerHTML += `<line x1="${cx}" y1="${cy}" x2="${x2}" y2="${y2}" stroke="#bfa1a1" stroke-width="1"/>`;
        let [lx, ly] = polarToCartesian(cx, cy, R+24, angle);
        svg.innerHTML += `<text x="${lx}" y="${ly}" class="radar-label">${config.labels[i]}</text>`;
    }
    // 3. Polígono real
    let poly = [];
    for (let i = 0; i < N; i++) {
        let v = values[i];
        let r = (v-min)/(max-min)*R;
        let angle = -Math.PI / 2 + (2 * Math.PI * i) / N;
        poly.push(polarToCartesian(cx, cy, r, angle));
    }
    svg.innerHTML += `<polygon points="${poly.map(p=>p.join(',')).join(' ')}" fill="rgba(128,0,0,0.17)" stroke="#800000" stroke-width="3"/>`;

    // 4. Puntos destacados
    for (let i = 0; i < N; i++) {
        let v = values[i];
        let r = (v-min)/(max-min)*R;
        let angle = -Math.PI / 2 + (2 * Math.PI * i) / N;
        let [px, py] = polarToCartesian(cx, cy, r, angle);
        svg.innerHTML += `<circle cx="${px}" cy="${py}" r="7" fill="#800000" stroke="white" stroke-width="2"/>`;
    }
}

// --- Cargar datos desde tu API ---
async function cargarPerfilOrganoleptico() {
    // Saca el vino_id de la URL (?vino_id=V001)
    const urlParams = new URLSearchParams(window.location.search);
    const vinoId = urlParams.get("vino_id");
    if (!vinoId) {
        alert("No se ha especificado el vino");
        return;
    }
    try {
        const response = await fetch(`https://sommelierlab-api-production.up.railway.app/api/organoleptica/${vinoId}`);
        organo = await response.json();
        // inicia con tipo aromático activo
        setRadarType(radarType);
    } catch (err) {
        alert("No se pudo cargar el perfil organoléptico");
    }
}

// --- Inicializa todo al cargar la página ---
document.addEventListener("DOMContentLoaded", cargarPerfilOrganoleptico);
</script>
    <div id="score-container">
        <h3>Puntuación Total</h3>
        <div id="score-bar"><div id="score-fill" style="width: 0%">0</div></div>
        <div id="rating-summary" style="display: flex; align-items: center; gap: 0.5rem; margin-top: 1rem;">
           <span id="media-nota" style="font-size:2rem; font-weight:bold;">-</span>
           <span id="estrellas-nota" style="font-size:1.5rem; color: #800000;"></span>
           <span id="total-valoraciones" style="font-size:1rem; color:#555;"></span>
        </div>
    </div>

    <div id="valoracion-container">
        <h3>Valora este vino</h3>
        <div id="estrellas">
            <span class="estrella" data-value="1">★</span><span class="estrella" data-value="2">★</span><span class="estrella" data-value="3">★</span><span class="estrella" data-value="4">★</span><span class="estrella" data-value="5">★</span>
        </div>
        <textarea id="comentario" placeholder="Deja un comentario sobre el vino..." rows="4" style="width:100%; margin-top: 1rem; padding: 0.5rem;"></textarea>
        <button id="enviar-valoracion" style="margin-top: 1rem; background:#800000; color:white; border:none; padding:0.5rem 1rem; border-radius:0.5rem; cursor:pointer;">Enviar valoración</button>
        <p id="mensaje-valoracion" style="margin-top:1rem; color: green;"></p>
    </div>
    
    <div id="comentarios-container" style="margin-top: 3rem;">
        <h3 style="cursor:pointer; color:#800000;" onclick="toggleComentarios()">▼ Comentarios de otros usuarios</h3>
        <div id="lista-comentarios" style="max-height: 0; overflow: hidden; transition: max-height 0.5s ease-out;">
            <p style="padding: 1rem 0;">Cargando comentarios...</p>
        </div>
    </div>

    <script>
    // --- Lógica de puntuación, comentarios, valoración (igual que antes) ---

    let puntuacionSeleccionada = 0;
    // Puedes integrar aquí el fetch de puntuación/media/valoraciones igual que en tu anterior code.
    // Por ahora, esto es el bloque interactivo mínimo:

    document.addEventListener("DOMContentLoaded", () => {
        document.querySelectorAll(".estrella").forEach(e => {
            e.addEventListener("click", () => {
                puntuacionSeleccionada = parseInt(e.dataset.value);
                document.querySelectorAll(".estrella").forEach(star => {
                    star.classList.toggle("seleccionada", parseInt(star.dataset.value) <= puntuacionSeleccionada);
                });
            });
        });

        document.getElementById("enviar-valoracion").addEventListener("click", async () => {
            const comentario = document.getElementById("comentario").value || "";
            const mensaje = document.getElementById("mensaje-valoracion");
            if (!puntuacionSeleccionada) {
                mensaje.innerText = "Por favor, selecciona una puntuación (de 1 a 5 estrellas).";
                mensaje.style.color = "red";
                return;
            }
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const vinoId = urlParams.get("vino_id");
                await fetch("https://n8n-production-cb18.up.railway.app/webhook/comentar-vino", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        vino_id: vinoId,
                        puntuacion: puntuacionSeleccionada,
                        comentario: comentario,
                        user_id: localStorage.getItem("user_id") || "user_" + Math.random().toString(36).substring(2, 10),
                        ciudad: window._datosUsuario?.ciudad || "Desconocida",
                        pais: window._datosUsuario?.pais || "Desconocido",
                        idioma: window._datosUsuario?.idioma || "es"
                    })
                });
                mensaje.innerText = "¡Gracias por tu valoración!";
                mensaje.style.color = "green";
            } catch (err) {
                mensaje.innerText = "Error al enviar tu valoración.";
                mensaje.style.color = "red";
            }
        });
    });

    // Toggle para comentarios (igual que antes)
    function toggleComentarios() {
        const listaComentariosEl = document.getElementById("lista-comentarios");
        if (listaComentariosEl.style.maxHeight === "0px" || !listaComentariosEl.style.maxHeight) {
            listaComentariosEl.style.maxHeight = listaComentariosEl.scrollHeight + "px";
        } else {
            listaComentariosEl.style.maxHeight = "0px";
        }
    }
    </script>
</body>
</html>

