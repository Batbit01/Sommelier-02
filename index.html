<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <title>SommelierLab ¬∑ Ficha</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Tailwind para MVP. En prod: compilar. -->
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
      :root {
        --accent-color: #c79a5a;
      }
      body {
        background: #0f0a0a;
        color: #fff;
      }
      .sl-card {
        background: rgba(15, 15, 15, 0.38);
        border: 1px solid rgba(255, 255, 255, 0.025);
        border-radius: 1.25rem;
      }
      .fade-in {
        animation: fadeIn 0.35s ease-out both;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(4px);
        }
        to {
          opacity: 1;
          transform: none;
        }
      }
      .section-title {
        font-size: 1rem;
        font-weight: 600;
        margin-bottom: 0.85rem;
      }
      /* debug panel */
      #debug {
        max-height: 280px;
      }
      /* mobile CTA */
      #cta-sticky-bar {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        z-index: 50;
        background: rgba(12, 12, 12, 0.82);
        backdrop-filter: blur(6px);
        border-top: 1px solid rgba(255, 255, 255, 0.04);
      }
    </style>
  </head>
  <body class="min-h-screen">
    <!-- PANEL DEBUG -->
    <pre
      id="debug"
      class="hidden bg-red-900/25 text-[10px] leading-snug p-3 overflow-auto"
    ></pre>

    <!-- APP -->
    <div id="app" class="max-w-[1130px] mx-auto px-4 sm:px-6 pb-32"></div>

    <!-- SCRIPT PRINCIPAL -->
    <script>
      /* ===========================================================
         1. CONSTANTES B√ÅSICAS
         =========================================================== */
      const CDN_BASE =
        "https://f005.backblazeb2.com/file/SommelierLab-media";

      const UI = {
        es: {
          share: "Compartir",
          sommelier: "Presentaci√≥n del sommelier",
          gallery: "Galer√≠a",
          social: "Redes y contacto",
          legal: "Bebe con responsabilidad",
          enoturismo: "Enoturismo y visitas",
          data_origin: "Origen de datos",
          cta_buy: "Comprar",
          cta_visit: "Visitar bodega",
          cta_contact: "Contactar",
          org_title: "Perfil sensorial",
          tech_title: "Ficha t√©cnica",
          actions_title: "Acciones r√°pidas",
        },
        en: {
          share: "Share",
          sommelier: "Sommelier presentation",
          gallery: "Gallery",
          social: "Social & contact",
          legal: "Drink responsibly",
          enoturismo: "Wine tourism",
          data_origin: "Data source",
          cta_buy: "Buy",
          cta_visit: "Visit winery",
          cta_contact: "Contact",
          org_title: "Sensory profile",
          tech_title: "Technical sheet",
          actions_title: "Quick actions",
        },
        fr: {
          share: "Partager",
          sommelier: "Pr√©sentation du sommelier",
          gallery: "Galerie",
          social: "R√©seaux et contact",
          legal: "Buvez avec mod√©ration",
          enoturismo: "Oenotourisme",
          data_origin: "Source des donn√©es",
          cta_buy: "Acheter",
          cta_visit: "Visiter le domaine",
          cta_contact: "Contacter",
          org_title: "Profil sensoriel",
          tech_title: "Fiche technique",
          actions_title: "Actions rapides",
        },
      };

      const state = {
        query: {},
        ficha: null,
        t: UI.es,
      };

      /* ===========================================================
         2. HELPERS
         =========================================================== */
      const $ = (sel, sc = document) => sc.querySelector(sel);

      function getQuery() {
        const p = new URLSearchParams(location.search);
        return {
          vino_id: p.get("vino_id") || "",
          anyada: p.get("anyada") || "",
          lang: (p.get("lang") || "es").slice(0, 2).toLowerCase(),
          context: p.get("context") || "",
        };
      }

      function showDebug(obj) {
        const d = $("#debug");
        if (!d) return;
        d.classList.remove("hidden");
        d.textContent = JSON.stringify(obj, null, 2).slice(0, 2400);
      }

      function pickImage(v) {
        if (!v) return "";
        if (typeof v === "string") return v;
        if (Array.isArray(v) && v.length) {
          if (typeof v[0] === "string") return v[0];
          if (v[0] && v[0].url) return v[0].url;
        }
        if (v.url) return v.url;
        return "";
      }

      /* ===========================================================
         3. FETCH DESDE CDN, CON FALLBACK DE IDIOMA
         =========================================================== */
      async function fetchCDN(vino_id, anyada, lang) {
        const langsToTry = Array.from(
          new Set(
            [lang, lang && lang.toLowerCase(), lang && lang.toUpperCase()].filter(
              Boolean
            )
          )
        );

        // 1) probar idioma
        for (const L of langsToTry) {
          const url = \`\${CDN_BASE}/qr2/\${vino_id}/\${anyada}/\${L}/ficha.json\`;
          try {
            const res = await fetch(url, { cache: "no-store" });
            if (res.ok) {
              const json = await res.json();
              json.__cdn_url = url;
              json.__cdn_lang = L.toLowerCase();
              return json;
            }
          } catch (e) {
            console.warn("[CDN]", L, e);
          }
        }

        // 2) fallback espa√±ol
        const urlEs = \`\${CDN_BASE}/qr2/\${vino_id}/\${anyada}/es/ficha.json\`;
        const resEs = await fetch(urlEs, { cache: "no-store" });
        if (!resEs.ok) {
          throw new Error("No existe ficha en CDN en ning√∫n idioma");
        }
        const jsonEs = await resEs.json();
        jsonEs.__cdn_url = urlEs;
        jsonEs.__cdn_lang = "es";
        return jsonEs;
      }

      /* ===========================================================
         4. NORMALIZACI√ìN ESPEC√çFICA PARA TU JSON
         =========================================================== */
      function normalize(raw, q) {
        // tu JSON ya viene tal cual lo has pegado
        // ra√≠z: schema_version, vino_id, anyada, lang, ficha:{...}, bodega_info, organoleptico, for_front, theme, social...

        const langFinal = (raw.lang || q.lang || "es").toLowerCase();

        // 4.1. nombre del vino
        const baseFicha = raw.ficha || {};
        const nombre =
          baseFicha.nombre ||
          baseFicha.title ||
          (baseFicha.vino &&
            (baseFicha.vino["Nombre del vino"] || baseFicha.vino["Nombre"])) ||
          "";

        // 4.2. imagen
        const imgFromVino =
          baseFicha.vino && pickImage(baseFicha.vino.Imagen)
            ? pickImage(baseFicha.vino.Imagen)
            : "";
        const imgFromAssets = raw.assets && raw.assets.image_url
          ? raw.assets.image_url
          : "";
        const finalImg =
          imgFromVino ||
          baseFicha.imagen ||
          imgFromAssets ||
          (raw.for_front &&
            raw.for_front.header &&
            raw.for_front.header.imagen) ||
          "";

        // 4.3. narrativa: en tu JSON viene como string
        let narrativaTxt = "";
        if (typeof baseFicha.narrativa === "string") {
          narrativaTxt = baseFicha.narrativa;
        } else if (
          baseFicha.narrativa &&
          typeof baseFicha.narrativa.texto === "string"
        ) {
          narrativaTxt = baseFicha.narrativa.texto;
        } else if (raw.for_front && typeof raw.for_front.narrativa_es === "string") {
          narrativaTxt = raw.for_front.narrativa_es;
        } else if (
          baseFicha.vino &&
          typeof baseFicha.vino["Notas de cata"] === "string"
        ) {
          narrativaTxt = baseFicha.vino["Notas de cata"];
        }

        // 4.4. organol√©ptico
        // hay dos sitios: raw.organoleptico y raw.for_front.organoleptico
        const orgFront = raw.for_front && raw.for_front.organoleptico
          ? raw.for_front.organoleptico
          : null;
        const orgRoot = raw.organoleptico || null;

        const organoTexto =
          (orgFront && orgFront.texto) ||
          (orgRoot && orgRoot.texto) ||
          "";

        const organoServicio =
          (orgFront && orgFront.servicio) ||
          (orgRoot && orgRoot.servicio) ||
          null;

        // 4.5. bodega / enoturismo
        const bodegaName =
          baseFicha.bodega ||
          (raw.bodega_info && raw.bodega_info["Bodega"]) ||
          "";
        const enot =
          (raw.for_front && raw.for_front.enoturismo) ||
          (raw.bodega_info && {
            ofrece: raw.bodega_info["Enoturismo"] === "S√≠",
            reserva_url: raw.bodega_info["Reservas_URL_Base"] || "",
          }) ||
          null;

        // 4.6. CTA
        const visitaUrl =
          (enot && enot.reserva_url) ||
          (raw.bodega_info && raw.bodega_info["Reservas_URL_Base"]) ||
          "";

        const contactoUrl =
          (raw.social && raw.social.email && \`mailto:\${raw.social.email}\`) ||
          (raw.bodega_info &&
            raw.bodega_info["Email de contacto"] &&
            \`mailto:\${raw.bodega_info["Email de contacto"]}\`) ||
          "";

        // 4.7. tech info
        const tech = {
          Elaboraci√≥n: baseFicha.Elaboraci√≥n
            ? [String(baseFicha.Elaboraci√≥n)]
            : [],
          "Proceso de crianza": baseFicha["Proceso de crianza"]
            ? [String(baseFicha["Proceso de crianza"])]
            : [],
          Vinificaci√≥n: baseFicha.Vinificaci√≥n
            ? [String(baseFicha.Vinificaci√≥n)]
            : [],
          Curiosidad: baseFicha.Curiosidad
            ? [String(baseFicha.Curiosidad)]
            : [],
        };

        return {
          schema_version: "qr2-ficha-1",
          vino_id: q.vino_id,
          anyada: q.anyada,
          lang_requested: q.lang,
          lang_final: langFinal,
          available_langs: [langFinal],
          theme:
            raw.theme || {
              background_mode: "dark",
              primary_color: "#0f0a0a",
              accent_color: "#c79a5a",
            },
          ficha: {
            bodega: bodegaName,
            nombre: nombre,
            year:
              baseFicha.anyada ||
              (raw.for_front &&
                raw.for_front.header &&
                raw.for_front.header.anyada) ||
              q.anyada ||
              "",
            do:
              baseFicha.do ||
              (raw.for_front &&
                raw.for_front.header &&
                raw.for_front.header.do) ||
              (raw.bodega_info && raw.bodega_info["Origen/DO"]) ||
              "",
            variedad:
              baseFicha.variedad ||
              (raw.for_front &&
                raw.for_front.header &&
                raw.for_front.header.variedad) ||
              (baseFicha.vino && baseFicha.vino["Variedad de uva"]) ||
              "",
            context: q.context || "",
            bottle_media: {
              image_url: finalImg,
              video_url: "",
            },
            narrativa: {
              texto: narrativaTxt,
              audio_url: "", // lo a√±adiremos en flujo 3
            },
            organoleptico: {
              texto: organoTexto,
              servicio: organoServicio,
              barras: {},
            },
            tech_info: tech,
            cta: {
              visita_url: visitaUrl,
              comprar_url: "",
              contacto_url: contactoUrl,
            },
          },
          social:
            raw.social || {
              email:
                (raw.bodega_info && raw.bodega_info["Email de contacto"]) || "",
              web: (raw.bodega_info && raw.bodega_info["Web URL"]) || "",
            },
          bodega_info: raw.bodega_info || null,
          for_front: raw.for_front || null,
          modules:
            raw.modules || {
              narrativa: true,
              organoleptico: true,
              tech: true,
              cta: true,
              actions: true,
              social: true,
            },
          __cdn_url: raw.__cdn_url || raw.ficha_path || "",
          __cdn_lang: raw.__cdn_lang || langFinal,
        };
      }

      /* ===========================================================
         5. RENDERERS
         =========================================================== */

      function renderHeader(d) {
        const f = d.ficha || {};
        const langs =
          d.available_langs && d.available_langs.length
            ? d.available_langs
            : ["es"];
        const lang = d.lang_final || "es";
        return (
          \`
      <header class="pt-6 pb-2 flex items-start justify-between gap-4">
        <div>
          <div class="text-xs uppercase tracking-wide text-neutral-400 mb-1">\${
            f.bodega || ""
          }</div>
          <h1 class="text-2xl font-semibold leading-tight">\${
            f.nombre || ""
          }</h1>
          <div class="flex flex-wrap gap-2 text-sm text-neutral-400 mt-1">
            \${
              f.year
                ? \`<span>\${f.year}</span>\`
                : ""
            }
            \${
              f.do
                ? \`<span>¬∑</span><span>\${f.do}</span>\`
                : ""
            }
          </div>
          <div class="text-[10px] text-neutral-500 mt-1">CDN: \${
            d.__cdn_url || "‚Äì"
          } (\${d.__cdn_lang || "?"})</div>
        </div>
        <div class="flex gap-2 items-center">
          <select id="langSel" class="bg-neutral-900 border border-neutral-700 rounded-lg px-2 py-1 text-sm">
            \${
              langs
                .map(
                  (l) =>
                    \`<option value="\${l}" \${
                      l === lang ? "selected" : ""
                    }>\${l.toUpperCase()}</option>\`
                )
                .join("")
            }
          </select>
          <button id="shareBtn" class="hidden sm:inline-flex text-sm text-neutral-200/80 hover:text-white">\${
            (UI[lang] || UI.es).share
          }</button>
        </div>
      </header>
      <hr class="border-neutral-800 mb-3">
    \`
        );
      }

      function renderHero(d) {
        const img = d.ficha?.bottle_media?.image_url;
        return \`
      <section class="py-3">
        \${
          img
            ? \`<img src="\${img}" alt="bottle" class="w-40 h-64 mx-auto object-contain rounded-xl border border-neutral-700 bg-neutral-900 shadow-xl">\`
            : ""
        }
      </section>
      <hr class="border-neutral-800 mb-3">
    \`;
      }

      function renderNarrativa(d) {
        const lang = d.lang_final || "es";
        const txt = d.ficha?.narrativa?.texto || "";
        const au = d.ficha?.narrativa?.audio_url || "";
        if (!txt && !au) return "";
        return \`
      <section class="py-4">
        <h2 class="text-lg font-semibold mb-2">\${
          (UI[lang] || UI.es).sommelier
        }</h2>
        \${
          txt
            ? \`<p class="text-neutral-200 leading-relaxed mb-3">\${txt.replace(
                /\\n/g,
                "<br>"
              )}</p>\`
            : ""
        }
        \${
          au
            ? \`<audio controls class="w-full"><source src="\${au}" type="audio/mpeg"></audio>\`
            : \`<p class="text-xs text-neutral-500">Audio no disponible.</p>\`
        }
      </section>
      <hr class="border-neutral-800 mb-3">
    \`;
      }

      function renderOrganoleptico(d) {
        const lang = d.lang_final || "es";
        const o = d.ficha?.organoleptico || {};
        if (!o.texto && !o.servicio?.temperatura) return "";
        return \`
      <section class="py-4 sl-card px-4">
        <h2 class="text-lg font-semibold mb-3">\${
          (UI[lang] || UI.es).org_title
        }</h2>
        \${
          o.texto
            ? \`<p class="text-sm leading-relaxed mb-3">\${o.texto.replace(
                /\\n/g,
                "<br>"
              )}</p>\`
            : ""
        }
        \${
          o.servicio?.temperatura
            ? \`<p class="text-xs text-neutral-400">Temperatura de servicio: \${o.servicio.temperatura}</p>\`
            : ""
        }
      </section>
      <hr class="border-neutral-800 mb-3">
    \`;
      }

      function renderTech(d) {
        const lang = d.lang_final || "es";
        const ti = d.ficha?.tech_info || {};
        const entries = Object.entries(ti).filter(
          ([, v]) => Array.isArray(v) && v.length
        );
        if (!entries.length) return "";
        return \`
      <section class="py-4">
        <h2 class="text-lg font-semibold mb-3">\${
          (UI[lang] || UI.es).tech_title
        }</h2>
        <div class="space-y-3">
          \${
            entries
              .map(
                ([k, arr]) => \`
              <details class="bg-neutral-900/30 border border-neutral-800 rounded-xl p-3">
                <summary class="cursor-pointer text-sm font-medium text-neutral-100">\${k}</summary>
                <div class="mt-2 text-sm text-neutral-200">\${arr
                  .map((p) => \`<p class="mb-2">\${p}</p>\`)
                  .join("")}</div>
              </details>
            \`
              )
              .join("")
          }
        </div>
      </section>
      <hr class="border-neutral-800 mb-3">
    \`;
      }

      function renderCTA(d) {
        const lang = d.lang_final || "es";
        const c = d.ficha?.cta || {};
        if (!c.comprar_url && !c.visita_url && !c.contacto_url) return "";
        return \`
      <section class="py-4 flex flex-wrap gap-3">
        \${
          c.comprar_url
            ? \`<a href="\${c.comprar_url}" class="bg-amber-500 text-neutral-900 rounded-xl px-4 py-2 text-sm font-medium">\${(
                UI[lang] || UI.es
              ).cta_buy}</a>\`
            : ""
        }
        \${
          c.visita_url
            ? \`<a href="\${c.visita_url}" class="bg-neutral-900/40 border border-neutral-700 rounded-xl px-4 py-2 text-sm font-medium">\${(
                UI[lang] || UI.es
              ).cta_visit}</a>\`
            : ""
        }
        \${
          c.contacto_url
            ? \`<a href="\${c.contacto_url}" class="underline text-amber-400 text-sm font-medium">\${(
                UI[lang] || UI.es
              ).cta_contact}</a>\`
            : ""
        }
      </section>
      <hr class="border-neutral-800 mb-3">
    \`;
      }

      function renderActions(d) {
        const lang = d.lang_final || "es";
        const actions = [
          { id: "curiosidad", label: "Curiosidad", icon: "‚ú®" },
          { id: "maridaje", label: "Sugerencia de maridaje", icon: "üçΩÔ∏è" },
          { id: "bodega", label: "M√°s sobre la bodega", icon: "üè°" },
          { id: "otro", label: "Ver otro vino", icon: "üç∑" },
        ];
        return \`
      <section class="py-4">
        <h2 class="text-lg font-semibold mb-4">\${(UI[lang] || UI.es)
          .actions_title}</h2>
        <div class="grid grid-cols-2 sm:grid-cols-4 gap-3">
          \${
            actions
              .map(
                (a) => \`
            <button data-action-id="\${a.id}" class="bg-neutral-900/30 border border-neutral-800 rounded-xl px-3 py-3 flex flex-col gap-1 items-start hover:border-amber-400 transition">
              <span class="text-lg">\${a.icon}</span>
              <span class="text-sm font-medium text-neutral-100">\${a.label}</span>
              <span class="text-[11px] text-neutral-500">Tap para ampliar</span>
            </button>
          \`
              )
              .join("")
          }
        </div>
      </section>
      <hr class="border-neutral-800 mb-3">
    \`;
      }

      function renderSocial(d) {
        const lang = d.lang_final || "es";
        const s = d.social || {};
        const web = s.web || s.website;
        const email = s.email;
        if (!web && !email) return "";
        return \`
      <section class="py-4">
        <h2 class="text-lg font-semibold mb-3">\${(UI[lang] || UI.es)
          .social}</h2>
        <div class="flex flex-wrap gap-3 text-sm">
          \${
            web
              ? \`<a href="\${web}" target="_blank" class="underline text-amber-400">Web</a>\`
              : ""
          }
          \${
            email
              ? \`<a href="mailto:\${email}" class="underline text-amber-400">Email</a>\`
              : ""
          }
        </div>
      </section>
      <hr class="border-neutral-800 mb-3">
    \`;
      }

      function renderFooter(d) {
        const lang = d.lang_final || "es";
        return \`
      <footer class="py-10 text-center text-neutral-400 text-sm">
        <p>\${(UI[lang] || UI.es).legal}</p>
        <p class="text-[10px] text-neutral-700 mt-2">CDN: \${d.__cdn_url ||
          "‚Äì"}</p>
      </footer>
    \`;
      }

      function renderStickyCTA(d) {
        const c = d.ficha?.cta || {};
        if (!c.visita_url && !c.comprar_url) return;
        const bar = document.createElement("div");
        bar.id = "cta-sticky-bar";
        bar.innerHTML = \`
        <div class="max-w-[1130px] mx-auto px-4 py-3 flex gap-3">
          \${
            c.comprar_url
              ? \`<button data-link="\${c.comprar_url}" class="flex-1 bg-amber-500 text-neutral-900 rounded-xl px-3 py-2 text-sm font-semibold">Comprar</button>\`
              : ""
          }
          \${
            c.visita_url
              ? \`<button data-link="\${c.visita_url}" class="flex-1 bg-neutral-900/70 border border-neutral-700 rounded-xl px-3 py-2 text-sm font-semibold">Visitar</button>\`
              : ""
          }
        </div>
      \`;
        document.body.appendChild(bar);
        bar.querySelectorAll("[data-link]").forEach((b) => {
          b.addEventListener("click", () => {
            location.href = b.getAttribute("data-link");
          });
        });
      }

      function renderApp(d) {
        state.t = UI[d.lang_final] || UI.es;
        const app = $("#app");
        app.innerHTML = [
          renderHeader(d),
          renderHero(d),
          renderNarrativa(d),
          renderOrganoleptico(d),
          renderTech(d),
          renderCTA(d),
          renderActions(d),
          renderSocial(d),
          renderFooter(d),
        ].join("");

        // wiring
        const sel = $("#langSel");
        if (sel) {
          sel.addEventListener("change", () => {
            const url = new URL(location.href);
            url.searchParams.set("lang", sel.value);
            location.href = url.toString();
          });
        }
        const sb = $("#shareBtn");
        if (sb) {
          sb.addEventListener("click", async () => {
            try {
              if (navigator.share) {
                await navigator.share({
                  title: document.title,
                  url: location.href,
                });
              } else {
                await navigator.clipboard.writeText(location.href);
                sb.textContent = "Copiado";
                setTimeout(
                  () => (sb.textContent = (state.t || UI.es).share),
                  1200
                );
              }
            } catch (e) {}
          });
        }

        document.querySelectorAll("[data-action-id]").forEach((btn) => {
          btn.addEventListener("click", () => {
            const actionId = btn.getAttribute("data-action-id");
            const ctx = {
              vino_id: state.query.vino_id,
              anyada: state.query.anyada,
              lang: state.ficha.lang_final,
              context: state.query.context || "botella",
            };
            console.log("[SommelierLab][action]", actionId, ctx);
            // aqu√≠ despu√©s conectamos a n8n con ?accion=...
          });
        });

        renderStickyCTA(d);
      }

      /* ===========================================================
         6. BOOT
         =========================================================== */
      (async function () {
        state.query = getQuery();
        if (!state.query.vino_id || !state.query.anyada) {
          $("#app").innerHTML =
            '<div class="p-4 text-red-300">Faltan par√°metros ?vino_id=...&anyada=...</div>';
          return;
        }
        try {
          const raw = await fetchCDN(
            state.query.vino_id,
            state.query.anyada,
            state.query.lang
          );
          showDebug(raw);
          const norm = normalize(raw, state.query);
          state.ficha = norm;
          renderApp(norm);
        } catch (e) {
          console.error(e);
          $("#app").innerHTML =
            '<div class="p-4 text-red-300">Error cargando ficha: ' +
            e.message +
            "</div>";
        }
      })();
    </script>
  </body>
</html>
