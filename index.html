<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SommelierLab ¬∑ Ficha</title>
  <meta name="color-scheme" content="light">
  <style>
    :root{--fg:#111;--muted:#666;--bg:#fff;--card:#fff;--b:#e6e6e6}
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.45 system-ui,Segoe UI,Roboto,Arial,sans-serif}
    .wrap{max-width:1000px;margin:0 auto;padding:18px}
    header{display:flex;flex-wrap:wrap;align-items:flex-start;gap:12px;margin:6px 0 10px}
    h1{font-size:1.9rem;margin:0}
    .muted{color:var(--muted)}
    .chip{display:inline-block;font-size:.85rem;padding:4px 8px;border:1px solid var(--b);border-radius:999px;background:#f7f7f7;margin-right:6px}
    .hero{border:1px solid var(--b);border-radius:16px;overflow:hidden;background:#fafafa}
    .hero img{display:block;width:100%;height:auto}
    .buttons{display:flex;flex-wrap:wrap;gap:10px;margin:14px 0 6px}
    .btn{padding:12px 16px;border-radius:12px;border:1px solid var(--b);background:#f7f7f7;text-decoration:none;color:inherit;cursor:pointer}
    .btn[disabled]{opacity:.45;cursor:not-allowed}
    .btn-primary{background:#111;color:#fff;border-color:#111}
    .btn-secondary{background:#f0f0f0}
    section.card{border:1px solid var(--b);border-radius:16px;padding:16px;margin:14px 0;background:var(--card)}
    .grid-2{display:grid;grid-template-columns:1fr;gap:16px}
    @media(min-width:800px){.grid-2{grid-template-columns:1fr 1fr}}
    ul.clean{margin:8px 0 0 18px}
    #foot{font-size:.85rem;margin:24px 0 8px}
    .sr-only{position:absolute;left:-9999px}
    .stars{display:inline-flex;gap:4px;vertical-align:middle}
    .star{font-size:1.2rem;color:#f5a623}
    .comment{border-top:1px solid var(--b);padding:10px 0}
  </style>
</head>
<body>
<div class="wrap">

  <header>
    <div>
      <div id="doChip" class="chip" style="display:none"></div>
      <div id="variedadChip" class="chip" style="display:none"></div>
      <h1 id="vinoTitulo">Cargando‚Ä¶</h1>
      <div id="subTitulo" class="muted"></div>
    </div>
    <div id="share" style="margin-left:auto;display:none">
      <!-- M√≥dulo compartir (se puede rellenar despu√©s) -->
    </div>
  </header>

  <div id="hero" class="hero" style="display:none">
    <img id="vinoImagen" alt="">
  </div>

  <div class="buttons" id="ctaButtons">
    <button id="btnComprar"  class="btn btn-primary" disabled>üõí Comprar ahora</button>
    <button id="btnReservar" class="btn btn-secondary" disabled>üéüÔ∏è Reservar visita</button>
    <!-- Si quieres activar LEAD como fallback, agrega:
    <button id="btnSolicitar" class="btn">üì© Solicitar visita</button> -->
  </div>

  <!-- Narrativa + audio -->
  <section id="bloque-narrativa" class="card" style="display:none">
    <h2 style="margin:0 0 8px">Historia &amp; narrativa</h2>
    <p id="respuesta" style="white-space:pre-wrap"></p>
    <div id="bloque-audio-narrativa" style="display:none;margin-top:12px">
      <audio id="player" controls preload="none" style="width:100%">
        <!-- <source src="‚Ä¶" type="audio/mpeg" /> -->
      </audio>
    </div>
  </section>

  <!-- Organol√©ptico -->
  <section id="bloque-organoleptico" class="card" style="display:none">
    <h2 style="margin:0 0 8px">Perfil organol√©ptico</h2>
    <div class="grid-2">
      <div>
        <h3>Visual</h3>
        <ul id="org-visual" class="clean"></ul>
        <h3>Aroma</h3>
        <ul id="org-aroma" class="clean"></ul>
      </div>
      <div>
        <h3>Boca</h3>
        <ul id="org-boca" class="clean"></ul>
        <h3>Maridaje</h3>
        <ul id="org-maridaje" class="clean"></ul>
      </div>
    </div>
  </section>

  <!-- Sommelier conversacional (placeholder opcional) -->
  <section id="bloque-sommelier" class="card" style="display:none">
    <h2 style="margin:0 0 8px">Sommelier virtual</h2>
    <p class="muted">Disponible cuando activemos el endpoint.</p>
  </section>

  <!-- Valoraciones -->
  <section id="bloque-valoraciones" class="card" style="display:none">
    <h2 style="margin:0 0 8px">Valoraciones</h2>
    <div id="scoreWrap" class="muted" style="margin-bottom:8px">
      <span id="avgScore">‚Äî</span> / 5
      <span id="countScore">(0 votos)</span>
      <span class="stars" id="avgStars"></span>
    </div>
    <form id="formRating" style="display:flex;gap:10px;align-items:center">
      <label for="ratingSelect">Tu puntuaci√≥n:</label>
      <select id="ratingSelect">
        <option value="5">5 ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</option>
        <option value="4">4 ‚≠ê‚≠ê‚≠ê‚≠ê</option>
        <option value="3">3 ‚≠ê‚≠ê‚≠ê</option>
        <option value="2">2 ‚≠ê‚≠ê</option>
        <option value="1">1 ‚≠ê</option>
      </select>
      <button class="btn" type="submit">Enviar</button>
    </form>
  </section>

  <!-- Comentarios -->
  <section id="bloque-comentarios" class="card" style="display:none">
    <h2 style="margin:0 0 8px">Comentarios</h2>
    <form id="formComentario" style="display:flex;flex-direction:column;gap:8px;margin-bottom:12px">
      <textarea id="comentarioTexto" rows="3" placeholder="Deja tu comentario‚Ä¶" style="resize:vertical"></textarea>
      <button class="btn" type="submit">Publicar</button>
    </form>
    <div id="listaComentarios"></div>
  </section>

  <p id="foot" class="muted"></p>
</div>
  <script>
/*** CONFIG ***/
const N8N = {
  SCAN: "https://n8n-production-cb18.up.railway.app/webhook/qr/scan",
  CTA:  "https://n8n-production-cb18.up.railway.app/webhook/qr/cta",
  LEAD: "https://n8n-production-cb18.up.railway.app/webhook/qr/lead", // solo si activas LEAD
};
const CDN_BASE  = "https://f005.backblazeb2.com/file/SommelierLab-media/qr2";
const SRC_ENUM  = ["botella","mostrador","sala","carta","web","feria"];
const LANGS     = ["es","en"]; // a√±ade si publicas m√°s idiomas

// Endpoints de tu API (fallbacks que ya usabas)
const API_BASE          = "https://sommelierlab-api-production.up.railway.app";
const API_VINO          = (vinoId) => `${API_BASE}/api/vino/${vinoId}`;
const API_ORGANOLEPTICA = (vinoId) => `${API_BASE}/api/organoleptica/${vinoId}`;

// Endpoints n8n ya existentes para valoraciones/comentarios (aj√∫stalos si var√≠an)
const N8N_RATINGS_GET   = "https://n8n-production-cb18.up.railway.app/webhook/consultar-valoraciones";
const N8N_RATINGS_POST  = "https://n8n-production-cb18.up.railway.app/webhook/valorar-vino";
const N8N_COMMS_GET     = "https://n8n-production-cb18.up.railway.app/webhook/consultar-comentarios";
const N8N_COMMS_POST    = "https://n8n-production-cb18.up.railway.app/webhook/comentar-vino";

/*** PARSING ‚Äî soporta ?vino_id=qr2/V002/2024/es/index.html&src=botella y tambi√©n /qr2/V002/2024/es/index.html ***/
const qs = new URLSearchParams(location.search);
let vinoPath = qs.get("vino_id") || location.pathname;
const qPos = vinoPath.indexOf("?");
if (qPos !== -1){
  const inner = new URLSearchParams(vinoPath.slice(qPos+1));
  if (!qs.get("src") && inner.get("src")) qs.set("src", inner.get("src"));
  vinoPath = vinoPath.slice(0, qPos);
}
const segs = vinoPath.replace(/^\/+/, "").split("/").filter(Boolean);
const idxQ = Math.max(0, segs.findIndex(s => s.toLowerCase() === "qr2"));
const VINO_ID = segs[idxQ+1] || "";     // V002
const ANYADA  = segs[idxQ+2] || "";     // 2024
const LANG_IN = segs[idxQ+3] || "";     // es
const SRC_RAW = (qs.get("src")||"").toLowerCase();
const SRC     = SRC_ENUM.includes(SRC_RAW) ? SRC_RAW : "botella";
const preferred = (navigator.language || "es").slice(0,2).toLowerCase();
const LANG    = LANGS.includes(LANG_IN) ? LANG_IN : (LANGS.includes(preferred) ? preferred : "es");

// Helpers
const $ = sel => document.querySelector(sel);
const show = (el, on=true) => { const n = (typeof el === "string") ? $(el) : el; if (n) n.style.display = on ? "" : "none"; };
function withUtm(url){ if(!url) return null; const utm=`utm_source=qr&utm_medium=${encodeURIComponent(SRC)}&utm_campaign=qr2`; return url.includes("?")?`${url}&${utm}`:`${url}?${utm}`; }
function fillList(sel, arr){ const ul=$(sel); if(!ul) return; ul.innerHTML=""; (arr||[]).forEach(x=>{ const li=document.createElement("li"); li.textContent=(typeof x==="string")?x:(x?.label||JSON.stringify(x)); ul.appendChild(li); }); }
function stars(n){ const s=Math.round(Number(n)||0); return "‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÜ‚òÜ‚òÜ‚òÜ‚òÜ".slice(5-s,10-s).split("").map((c,i)=>`<span class="star">‚òÖ</span>`).join(""); }

// Carga ficha.json de Backblaze (r√°pido) con fallback a "es"
async function loadFichaJSON(){
  async function pull(lang){
    const url = `${CDN_BASE}/${VINO_ID}/${ANYADA}/${lang}/ficha.json`;
    const r = await fetch(url, { cache: "no-store" });
    if (!r.ok) throw new Error(`No ficha.json ${lang}`);
    return r.json();
  }
  try { return await pull(LANG); } catch(e) {
    if (LANG !== "es") { try { return await pull("es"); } catch(_){} }
  }
  return null;
}

// Fallback a API antigua (solo datos b√°sicos para mantener compat)
async function loadFichaAPI(vinoId){
  try {
    const r = await fetch(API_VINO(vinoId));
    if (!r.ok) throw new Error("API vino not ok");
    return r.json();
  } catch(e){ console.warn("API vino fallback error", e); return null; }
}
// Render con preferencia ficha.json, manteniendo tus m√≥dulos
async function boot(){
  if (!VINO_ID || !ANYADA){
    $("#vinoTitulo").textContent = "Ruta inv√°lida";
    return;
  }

  // 1) Cargar ficha.json (r√°pido)
  const ficha = await loadFichaJSON();

  // 2) Pintar b√°sicos (si ficha.json existe)
  if (ficha){
    $("#vinoTitulo").textContent = ficha.title || ficha?.content?.title || "Vino";
    const subt = ficha.subtitle || ficha?.content?.subtitle || "";
    $("#subTitulo").textContent = subt;

    const doText = ficha.do || ficha.region || ficha?.details?.origen || "";
    if (doText){ $("#doChip").textContent = doText; show("#doChip", true); }

    const variedad = ficha.variedad || ficha?.details?.variedad || "";
    if (variedad){ $("#variedadChip").textContent = variedad; show("#variedadChip", true); }

    const img = ficha?.assets?.image_url || ficha.image;
    if (img){ $("#vinoImagen").src = img; show("#hero", true); }

    // Narrativa/audio desde JSON si viene (sin romper tu flow)
    const nar = ficha?.content?.narrative_text || "";
    if (nar){ $("#respuesta").textContent = nar; show("#bloque-narrativa", true); }
    const audio = ficha?.assets?.audio_url || "";
    if (audio){
      const p = $("#player"); p.innerHTML = "";
      const s = document.createElement("source"); s.src = audio; s.type="audio/mpeg"; p.appendChild(s);
      try{ p.load(); }catch{}
      show("#bloque-audio-narrativa", true); show("#bloque-narrativa", true);
    }

    // Organol√©ptico b√°sico (listas)
    const org = ficha?.modules?.organoleptico || {};
    const mar = ficha?.modules?.maridaje || ficha?.maridaje || [];
    const anyOrg = (org.visual?.length||0)+(org.aroma?.length||0)+(org.boca?.length||0)+(mar.length||0) > 0;
    if (anyOrg){
      fillList("#org-visual", org.visual || []);
      fillList("#org-aroma",  org.aroma || []);
      fillList("#org-boca",   org.boca || []);
      fillList("#org-maridaje", mar);
      show("#bloque-organoleptico", true);
    }

    // CTAs y habilitar/deshabilitar
    const compra  = withUtm(ficha?.cta?.compra?.url || null);
    const reserva = withUtm(ficha?.cta?.reserva?.url || null);
    const btnC = $("#btnComprar"), btnR = $("#btnReservar");
    if (compra){  btnC.disabled=false; btnC.dataset.href = compra; }
    if (reserva){ btnR.disabled=false; btnR.dataset.href = reserva; }
  }

  // 3) Fallback a API para mantener compatibilidad (si no hubo JSON)
  if (!ficha){
    const vinoIdLegacy = `${VINO_ID}-${ANYADA}`;
    const apiData = await loadFichaAPI(vinoIdLegacy);
    if (apiData){
      $("#vinoTitulo").textContent = apiData.nombre || "Vino";
      if (apiData.imagen?.[0]?.url){ $("#vinoImagen").src = apiData.imagen[0].url; show("#hero", true); }
      $("#subTitulo").textContent  = apiData.tipo || "";
      if (apiData.origen){ $("#doChip").textContent = apiData.origen; show("#doChip", true); }
      if (apiData.variedad){ $("#variedadChip").textContent = apiData.variedad; show("#variedadChip", true); }
      // narrativa/audio/organol√©ptico seguir√°n por tus flows antiguos si los tienes en este HTML.
    } else {
      $("#vinoTitulo").textContent = "Ficha no disponible";
    }
  }

  // 4) Valoraciones (GET) ‚Äî si tienes flow activo
  try{
    const r = await fetch(`${N8N_RATINGS_GET}?vino_id=${encodeURIComponent(VINO_ID)}&anyada=${encodeURIComponent(ANYADA)}`);
    if (r.ok){
      const j = await r.json(); // {avg,count}
      const avg = Number(j.avg||0).toFixed(1);
      const cnt = Number(j.count||0);
      $("#avgScore").textContent = avg;
      $("#countScore").textContent = `(${cnt} votos)`;
      $("#avgStars").innerHTML = stars(avg);
      show("#bloque-valoraciones", true);
    }
  }catch{}

  // 5) Comentarios (GET) ‚Äî si tienes flow activo
  try{
    const r = await fetch(`${N8N_COMMS_GET}?vino_id=${encodeURIComponent(VINO_ID)}&anyada=${encodeURIComponent(ANYADA)}`);
    if (r.ok){
      const arr = await r.json(); // [{nombre,texto,fecha,score?},...]
      const wrap = $("#listaComentarios"); wrap.innerHTML = "";
      (arr||[]).forEach(c=>{
        const div = document.createElement("div"); div.className = "comment";
        div.innerHTML = `<div class="muted">${c.nombre||"An√≥nimo"} ¬∑ ${c.fecha||""}</div><div>${c.texto||""}</div>`;
        wrap.appendChild(div);
      });
      show("#bloque-comentarios", true);
    }
  }catch{}

  // 6) Eventos de enviar puntuaci√≥n/comentario (POST) ‚Äî si flujos activos
  $("#formRating").addEventListener("submit", async (e)=>{
    e.preventDefault();
    const score = Number($("#ratingSelect").value||"5");
    try{
      await fetch(N8N_RATINGS_POST, { method:"POST", headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ vino_id: VINO_ID, anyada: ANYADA, score }) });
      alert("¬°Gracias por tu voto!");
    }catch{ alert("No se pudo enviar tu voto."); }
  });

  $("#formComentario").addEventListener("submit", async (e)=>{
    e.preventDefault();
    const texto = ($("#comentarioTexto").value||"").trim();
    if (!texto) return;
    try{
      await fetch(N8N_COMMS_POST, { method:"POST", headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ vino_id: VINO_ID, anyada: ANYADA, texto }) });
      $("#comentarioTexto").value = "";
      alert("¬°Comentario enviado!");
    }catch{ alert("No se pudo enviar el comentario."); }
  });

  // 7) Tracking n8n (scan y cta)
  const ids = { Bodega_ID: (ficha?.ids?.Bodega_ID||null), ID_Vino: VINO_ID, ID_A√±ada: `${VINO_ID}-${ANYADA}` };

  // scan al cargar (no bloquea)
  try{ navigator.sendBeacon(N8N.SCAN, new Blob([JSON.stringify({ ...ids, Ubicacion: SRC })], {type:"application/json"})); }catch{}

  // cta en clic
  $("#btnComprar").addEventListener("click", (e)=>{
    const href = e.currentTarget.dataset.href || null;
    try{ navigator.sendBeacon(N8N.CTA, new Blob([JSON.stringify({ ...ids, Ubicacion: SRC, CTA:"comprar" })], {type:"application/json"})); }catch{}
    if (href) setTimeout(()=>location.href = href, 40);
  });
  $("#btnReservar").addEventListener("click", (e)=>{
    const href = e.currentTarget.dataset.href || null;
    try{ navigator.sendBeacon(N8N.CTA, new Blob([JSON.stringify({ ...ids, Ubicacion: SRC, CTA:"reservar" })], {type:"application/json"})); }catch{}
    if (href) setTimeout(()=>location.href = href, 40);
  });

  // 8) Footer debug (qu√≠talo cuando quieras)
  $("#foot").textContent = `ID: ${VINO_ID}/${ANYADA} ¬∑ lang=${LANG} ¬∑ src=${SRC}`;
}

// ¬°arrancamos!
boot();
</script>
</body>
</html>

