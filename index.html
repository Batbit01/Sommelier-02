<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
  <title id="vinoTitle">Ficha del Vino</title>

  <style>
    body { font-family: sans-serif; padding: 2rem; background-color: #fefefe; color: #222; max-width: 700px; margin: auto; }
    .vino-ficha img { width: 100%; max-height: 300px; object-fit: contain; border-radius: 1rem; }
    .vino-dato { margin-bottom: 1rem; }
    .vino-dato strong { display: inline-block; width: 100px; }
    #respuesta { margin-top: 2rem; font-style: italic; background: #f1f1f1; padding: 1rem; border-radius: 0.5rem; }
    #hablar { display: inline-block; margin-top: 2rem; padding: 0.75rem 1.5rem; background: #800000; color: white; border: none; border-radius: 1rem; cursor: pointer; transition: background .2s; font-weight: bold;}
    #hablar[disabled] { background: #a09797; color: #fff; cursor: not-allowed; }
    .redes a { margin-right: 1rem; text-decoration: none; color: #800000; }

    /* Compartir */
    #modulo-compartir { margin: 2rem 0 0.5rem 0; position: relative; display: flex; flex-direction: column; align-items: flex-start; }
    #btn-compartir {
      background: #fff; color: #800000; border: 2px solid #800000; border-radius: 2rem;
      padding: 0.5rem 1.25rem 0.5rem 0.75rem; font-weight: 600; font-size: 1.07rem;
      display: flex; align-items: center; gap: 0.55rem; cursor: pointer;
      transition: background 0.2s, box-shadow 0.2s; box-shadow: 0 2px 6px #80000011;
    }
    #btn-compartir:hover { background: #f8eaea; box-shadow: 0 4px 12px #8000001a; }
    #btn-compartir svg { flex-shrink: 0; }
    #menu-compartir {
      display: none; position: absolute; top: 110%; left: 0; background: #fff; border: 1.5px solid #e5dede;
      border-radius: 1.3rem; box-shadow: 0 6px 28px #80000012; min-width: 240px; padding: 0.5rem 0; z-index: 40;
      animation: fadeInCompartir 0.32s; transition: opacity 0.22s, transform 0.2s;
    }
    @keyframes fadeInCompartir { from { opacity: 0; transform: translateY(12px);} to { opacity: 1; transform: translateY(0);} }
    #menu-compartir.open { display: block; }
    .menu-item-compartir {
      display: flex; align-items: center; gap: 0.7rem; padding: 0.62rem 1.1rem; cursor: pointer;
      color: #700d18; font-size: 1.02rem; background: none; border: none; width: 100%;
      transition: background 0.17s, color 0.17s;
    }
    .menu-item-compartir:hover, .menu-item-compartir:focus { background: #f8eaea; color: #c9003f; outline: none; }
    .menu-item-compartir svg { width: 1.35em; height: 1.35em; display: block; }
    .menu-item-compartir.copiado { color: #218838; font-weight: 600; }

    /* Radar */
    #radar-svg-container {
      width: 100%; max-width: 520px; margin: 0 auto 2.5rem auto; background: #f8f4f2;
      border-radius: 22px; box-shadow: 0 2px 24px #0001; padding: 2.5rem 0; display: flex; flex-direction: column; align-items: center;
    }
    .switch-buttons { display: flex; justify-content: center; gap: 0.7rem; margin-bottom: 1.6rem; }
    .switch-buttons button {
      background-color: #a97c7c; color: white; border: 2px solid #800000; padding: 0.65rem 1.25rem;
      border-radius: 20px; cursor: pointer; transition: all 0.3s; font-weight: bold;
    }
    .switch-buttons button:hover { background-color: #800000; }
    .switch-buttons button.active { background-color: #800000; box-shadow: 0 0 10px rgba(128,0,0,0.5 ); }
    #radarSVG { background: none; display: block; margin: 0 auto; }
    .radar-label { font-size: 1rem; font-weight: bold; fill: #800000; text-anchor: middle; alignment-baseline: middle; pointer-events: none; }

    /* Valoraciones */
    #score-container, #valoracion-container { margin-top: 3rem; }
    #score-bar { width: 100%; height: 20px; background-color: #ddd; border-radius: 10px; overflow: hidden; }
    #score-fill { height: 100%; background-color: #800000; text-align: center; line-height: 20px; color: white; font-size: 0.9rem; }
    #estrellas .estrella { font-size: 2rem; color: #ccc; cursor: pointer; }
    #estrellas .estrella.seleccionada { color: #800000; }
    #estrellas-nota { color: #800000; font-size: 1.8rem; vertical-align: middle; }
    #lista-comentarios .comentario { margin-bottom: 1rem; padding: 0.75rem; border: 1px solid #ddd; border-radius: 0.5rem; background-color: #fafafa; text-align: left; }

    /* Sommelier (candado QR) */
    #modulo-sommelier { margin-bottom: 2.3rem; }
    #modulo-sommelier #sommelier-aviso {
      margin-top:0.7rem; color:#7b7171; background:#f7f3f0; padding:1rem 1.2rem;
      border-radius:1.1rem; font-size:1.07rem; display:flex; align-items:center; gap:0.7rem;
    }
  </style>

  <!-- Plyr.io CSS -->
  <link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" />
  <style>
    /* Personalización Plyr */
    .plyr--audio .plyr__controls { background: #f1f1f1; border-radius: 2rem; box-shadow: 0 2px 12px #80000012; }
    .plyr__control.plyr__control--overlaid, .plyr__control { background: #800000; color: #fff; }
    .plyr__control[aria-pressed="true"], .plyr__control:hover { background: #a97c7c; color: #fff; }
    .plyr__progress--played, .plyr__volume--display { color: #800000; background: #a97c7c; }
    .plyr__progress input[type=range]::-webkit-slider-thumb { background: #800000; }
    .plyr__menu__container, .plyr__menu__container label { color: #800000; }
  </style>
</head>

<body>
  <h1 id="vinoTitulo">Ficha del Vino</h1>
  <div class="vino-ficha">
    <img alt="Imagen del vino" id="vinoImagen" src=""/>
    <div class="vino-dato"><strong>Tipo:</strong> <span id="vinoTipo">-</span></div>
    <div class="vino-dato"><strong>Origen:</strong> <span id="vinoOrigen">-</span></div>
    <div class="vino-dato"><strong>Variedad:</strong> <span id="vinoUva">-</span></div>
    <div class="vino-dato"><strong>Bodega:</strong> <span id="bodegaNombre">-</span></div>
    <div class="vino-dato redes" id="bodega-redes"></div>
  </div>

  <!-- MÓDULO COMPARTIR -->
  <div id="modulo-compartir">
    <button id="btn-compartir" aria-label="Compartir ficha" title="Compartir ficha">
      <svg width="28" height="28" viewBox="0 0 24 24" fill="none"><path d="M13.2 5.9l2.4-2.4a1.5 1.5 0 1 1 2.1 2.1l-2.5 2.5M16.8 8.6a7 7 0 1 1-2.6-2.6" stroke="#800000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
      Compartir
    </button>
    <div id="menu-compartir"></div>
  </div>
  
  <!-- Botón Sommelier (aparece solo si el módulo está activo) -->
  <button id="btnSommelier" hidden aria-controls="somm-modal">
  Hablar con el sommelier
  </button>

  <!-- MÓDULO SOMMELIER VIRTUAL -->
  <div id="modulo-sommelier">
    <button id="hablar" disabled style="opacity:0.6;pointer-events:none;">
      <svg width="23" height="23" style="vertical-align:middle; margin-right:7px;" viewBox="0 0 20 20" fill="none"><circle cx="10" cy="10" r="8.5" stroke="#888" stroke-width="1.6"/><path d="M10 6.5v4.2M10 14h.01" stroke="#888" stroke-width="1.5" stroke-linecap="round"/></svg>
      Hablar con el sommelier
    </button>
    <div id="sommelier-aviso">
      <svg width="23" height="23" viewBox="0 0 20 20" fill="none"><circle cx="10" cy="10" r="8.5" stroke="#888" stroke-width="1.6"/><path d="M10 6.5v4.2M10 14h.01" stroke="#888" stroke-width="1.5" stroke-linecap="round"/></svg>
      Para vivir la experiencia del Sommelier Virtual, escanea el QR en la botella.
    </div>
  </div>

  <!-- NARRATIVA -->
  <div id="respuesta">Cargando descripción del vino...</div>
  <div id="bloque-audio-narrativa" style="margin:2.5rem 0; display:none;">
    <h3 style="margin-bottom:0.7rem; color: #800000;">Narrativa del sommelier</h3>
    <audio id="player" controls>
      Tu navegador no soporta audio HTML5.
    </audio>
  </div>

  <!-- RADAR -->
  <div id="radar-svg-container">
    <h3 style="margin-bottom:1.7rem;">Perfil organoléptico</h3>
    <div class="switch-buttons">
      <button id="btn-aromatico" onclick="setRadarType('aromatico')">Aromático</button>
      <button id="btn-gustativo" onclick="setRadarType('gustativo')">Gustativo</button>
      <button id="btn-sensorial" onclick="setRadarType('sensorial')">Sensorial</button>
    </div>
    <svg id="radarSVG" width="430" height="430"></svg>
  </div>

  <!-- VALORACIONES -->
  <div id="score-container">
    <h3>Puntuación Total</h3>
    <div id="score-bar"><div id="score-fill" style="width: 0%">0</div></div>
    <div id="rating-summary" style="display: flex; align-items: center; gap: 0.5rem; margin-top: 1rem;">
      <span id="media-nota" style="font-size:2rem; font-weight:bold;">-</span>
      <span id="estrellas-nota" style="font-size:1.5rem; color: #800000;"></span>
      <span id="total-valoraciones" style="font-size:1rem; color:#555;"></span>
    </div>
  </div>

  <div id="valoracion-container">
    <h3>Valora este vino</h3>
    <div id="estrellas">
      <span class="estrella" data-value="1">★</span><span class="estrella" data-value="2">★</span><span class="estrella" data-value="3">★</span><span class="estrella" data-value="4">★</span><span class="estrella" data-value="5">★</span>
    </div>
    <textarea id="comentario" placeholder="Deja un comentario sobre el vino..." rows="4" style="width:100%; margin-top: 1rem; padding: 0.5rem;"></textarea>
    <button id="enviar-valoracion" style="margin-top: 1rem; background:#800000; color:white; border:none; padding:0.5rem 1rem; border-radius:0.5rem; cursor:pointer;">Enviar valoración</button>
    <p id="mensaje-valoracion" style="margin-top:1rem; color: green;"></p>
  </div>

  <div id="comentarios-container" style="margin-top: 3rem;">
    <h3 style="cursor:pointer; color:#800000;" onclick="toggleComentarios()">▼ Comentarios de otros usuarios</h3>
    <div id="lista-comentarios" style="max-height: 0; overflow: hidden; transition: max-height 0.5s ease-out;">
      <p style="padding: 1rem 0;">Cargando comentarios...</p>
    </div>
  </div>

  <!-- JS LIB Plyr -->
  <script src="https://cdn.plyr.io/3.7.8/plyr.polyfilled.js"></script>
<script>
/* ========= CONFIG ========= */
const N8N_BASE = "https://n8n-production-cb18.up.railway.app/webhook";

/* ========= PARSEO CONTEXTO (ruta o query) ========= */
function parseFromPath() {
  const segs = location.pathname.split('/').filter(Boolean);
  const i = segs.findIndex(s => s.toLowerCase() === 'qr2');
  if (i >= 0 && segs.length >= i + 4) {
    return { vino_id: segs[i+1], anyada: segs[i+2], lang: segs[i+3] };
  }
  return { vino_id: null, anyada: null, lang: null };
}
function parseFromQuery() {
  const q = new URLSearchParams(location.search);
  let vino = (q.get('vino_id') || "").trim();
  let any  = (q.get('anyada')  || "").trim();
  let lang = (q.get('lang')    || "").trim().slice(0,2).toLowerCase();
  if (vino && /(^|\/)qr2\//i.test(vino)) {
    const segs = vino.replace(/^\/+/, '').split('/').filter(Boolean);
    const i = Math.max(0, segs.findIndex(s => s.toLowerCase()==='qr2'));
    vino = segs[i+1] || vino;
    any  = segs[i+2] || any;
    lang = (segs[i+3] || lang || navigator.language || 'es').slice(0,2).toLowerCase();
  }
  return { vino_id: vino || null, anyada: any || null, lang: lang || null };
}
function resolveCtx() {
  const p = parseFromPath();
  const q = parseFromQuery();
  return {
    vino_id: q.vino_id || p.vino_id || "",
    anyada:  q.anyada  || p.anyada  || "",
    lang:    (q.lang || p.lang || (navigator.language||'es')).slice(0,2).toLowerCase(),
    src:     new URLSearchParams(location.search).get('src') || ""
  };
}

/* ========= URL de ficha.json (CDN) ========= */
function currentFichaUrl(ctx) {
  if (ctx.vino_id && ctx.anyada && ctx.lang) {
    const CDN_BASE = "https://f005.backblazeb2.com/file/SommelierLab-media";
    return `${CDN_BASE}/qr2/${ctx.vino_id}/${ctx.anyada}/${ctx.lang}/ficha.json`;
  }
  const segs = location.pathname.split('/').filter(Boolean);
  const i = segs.findIndex(s => s.toLowerCase()==='qr2');
  if (i >= 0 && segs.length >= i + 4) {
    return new URL('./ficha.json', location.href).href;
  }
  return null;
}

/* ========= FETCH JSON (CDN) ========= */
async function loadFicha(url) {
  if (!url) return null;
  const res = await fetch(url, { cache: 'no-store' });
  if (!res.ok) throw new Error(`HTTP ${res.status} en ${url}`);
  return await res.json();
}

/* ========= PINTADO BÁSICO (DOM) ========= */
function paintBasics(data) {
  const title = data?.ficha?.title || data?.title || data?.meta?.title || "Ficha del Vino";
  const image = data?.ficha?.assets?.image_url || data?.assets?.image_url || data?.image || "";
  document.title = document.getElementById("vinoTitulo").innerText = title;
  if (image) document.getElementById("vinoImagen").src = image;

  document.getElementById("vinoTipo").innerText =
    data?.ficha?.tipo || data?.details?.tipo || "-";
  document.getElementById("vinoUva").innerText =
    data?.ficha?.variedad || data?.details?.variedad || "-";
  document.getElementById("vinoOrigen").innerText =
    data?.ficha?.do || data?.details?.origen || data?.region || "-";
  document.getElementById("bodegaNombre").innerText =
    data?.ficha?.bodega || data?.bodega || "-";

  const redes = data?.ficha?.bodega_info?.redes || {};
  const redesEl = document.getElementById("bodega-redes");
  const parts = [];
  if (data?.ficha?.bodega_info?.sitio_web) parts.push(`<a target="_blank" href="${data.ficha.bodega_info.sitio_web}">🌐 Web</a>`);
  if (redes.instagram) parts.push(`<a target="_blank" href="${redes.instagram}">📸 Instagram</a>`);
  if (redes.facebook)  parts.push(`<a target="_blank" href="${redes.facebook}">📘 Facebook</a>`);
  if (redes.x)         parts.push(`<a target="_blank" href="${redes.x}">𝕏</a>`);
  redesEl.innerHTML = parts.join(" · ");
}

/* ========= NARRATIVA + AUDIO DESDE JSON ========= */
function paintNarrativa(data) {
  const texto = data?.ficha?.narrativa?.texto || "";
  const audio = (data?.ficha?.narrativa?.audio_url || "").replace(/^http:\/\//i, "https://");
  const respuestaEl = document.getElementById("respuesta");
  const bloqueAudio = document.getElementById("bloque-audio-narrativa");
  const playerEl    = document.getElementById("player");

  respuestaEl.innerText = texto || "—";
  if (audio) {
    playerEl.innerHTML = "";
    const src = document.createElement("source");
    src.src  = audio;
    src.type = "audio/mpeg";
    playerEl.appendChild(src);
    playerEl.load();
    try { if (playerEl._plyr) playerEl._plyr.destroy(); } catch(_) {}
    playerEl._plyr = new Plyr(playerEl, { speed: { selected: 1, options: [0.75,1,1.25,1.5,2] } });
    bloqueAudio.style.display = "block";
  } else {
    bloqueAudio.style.display = "none";
  }
}

/* ========= RADAR ORGANOLÉPTICO DESDE JSON ========= */
const perfilesConfig = {
  gustativo: { labels:["Cuerpo","Acidez","Dulzor","Taninos","Frescura","Mineralidad"], fields:["cuerpo","acidez","dulzor","taninos","frescura","mineralidad"] },
  aromatico: { labels:["Fruta","Floral","Especiado","Tostado","Herbáceo"], fields:["fruta","floral","especiado","tostado","herbaceo"] },
  sensorial: { labels:["Persistencia","Complejidad","Astringencia","Alcohol","Armonía"], fields:["persistencia","complejidad","astringencia","alcohol_percibido","armonia"] }
};
let radarType = "aromatico";
function setRadarType(tipo){ radarType = tipo; document.querySelectorAll('.switch-buttons button').forEach(b=>b.classList.remove('active')); const b=document.getElementById(`btn-${tipo}`); if(b) b.classList.add('active'); renderRadar(window.__ORGANO__||{}); }
window.setRadarType = setRadarType;

function polarToCartesian(cx,cy,r,a){ return [cx + r*Math.cos(a), cy + r*Math.sin(a)]; }
function renderRadar(organo) {
  const svg = document.getElementById("radarSVG");
  svg.innerHTML = `<rect x="0" y="0" width="430" height="430" fill="#f8f4f2"/>`;
  const cfg = perfilesConfig[radarType];
  const N = cfg.labels.length, R=155, cx=215, cy=215, min=0, max=10;
  const values = cfg.fields.map(f => Number(organo[f] ?? 0));
  for (let c=1;c<=5;c++){
    const r=(R*c)/5, mesh=[];
    for (let i=0;i<N;i++){ const ang=-Math.PI/2 + (2*Math.PI*i)/N; mesh.push(polarToCartesian(cx,cy,r,ang)); }
    svg.innerHTML += `<polygon points="${mesh.map(p=>p.join(',')).join(' ')}" fill="none" stroke="#d7bebe" stroke-width="1"/>`;
  }
  for (let i=0;i<N;i++){
    const ang=-Math.PI/2 + (2*Math.PI*i)/N;
    const [x2,y2]=polarToCartesian(cx,cy,R,ang);
    svg.innerHTML += `<line x1="${cx}" y1="${cy}" x2="${x2}" y2="${y2}" stroke="#bfa1a1" stroke-width="1"/>`;
    const [lx,ly]=polarToCartesian(cx,cy,R+30,ang);
    svg.innerHTML += `<text x="${lx}" y="${ly}" class="radar-label">${cfg.labels[i]}</text>`;
  }
  const poly=[];
  for (let i=0;i<N;i++){
    const v=values[i], r=(v-min)/(max-min)*R, ang=-Math.PI/2 + (2*Math.PI*i)/N;
    poly.push(polarToCartesian(cx,cy,r,ang));
  }
  svg.innerHTML += `<polygon points="${poly.map(p=>p.join(',')).join(' ')}" fill="rgba(128,0,0,0.17)" stroke="#800000" stroke-width="3"/>`;
  for (let i=0;i<N;i++){
    const v=values[i], r=(v-min)/(max-min)*R, ang=-Math.PI/2 + (2*Math.PI*i)/N;
    const [px,py]=polarToCartesian(cx,cy,r,ang);
    svg.innerHTML += `<circle cx="${px}" cy="${py}" r="8" fill="#800000" stroke="white" stroke-width="2"/>`;
  }
}

/* ========= VALORACIONES / COMENTARIOS (webhooks) ========= */
function sessionId(){
  let sid = localStorage.getItem('user_id');
  if (!sid){ sid = `user_${Math.random().toString(36).slice(2,10)}`; localStorage.setItem('user_id', sid); }
  return sid;
}
async function cargarValoraciones(vino_id){
  try{
    const url = `${N8N_BASE}/consultar-valoraciones?vino_id=${encodeURIComponent(vino_id)}`;
    const res = await fetch(url, { cache: 'no-store' });
    const data = await res.json();
    const nota = Number(data.nota_media || data.media || 0);
    const total = Number(data.total_valoraciones || data.total || 0);

    document.getElementById("media-nota").innerText = nota ? nota.toFixed(1) : "-";
    const est = document.getElementById("estrellas-nota"); est.innerHTML="";
    const estrellas = Math.floor(nota), media = nota - estrellas;
    for (let i=1;i<=5;i++){
      if (i<=estrellas) est.innerHTML += "★";
      else if (i===estrellas+1 && media>=0.25 && media<0.75) est.innerHTML += "⯪";
      else est.innerHTML += "☆";
    }
    document.getElementById("total-valoraciones").innerText = total ? `(${total} valoraciones)` : "";
    const fill = document.getElementById("score-fill");
    const pct  = nota ? Math.round((nota/5)*100) : 0;
    fill.style.width = pct + "%";
    fill.innerText = nota ? `${nota.toFixed(1)} / 5` : "0 / 5";
  }catch(e){ console.error("Valoraciones:", e); }
}
async function cargarComentarios(vino_id){
  try{
    const res = await fetch(`${N8N_BASE}/consultar-comentarios?vino_id=${encodeURIComponent(vino_id)}`, { cache: 'no-store' });
    const data = await res.json();
    const lista = document.getElementById("lista-comentarios");
    const comentarios = Array.isArray(data.comentarios) ? data.comentarios : (Array.isArray(data) ? data : []);
    lista.innerHTML = "";
    if (!comentarios.length){
      lista.innerHTML = '<p style="padding:1rem 0;">No hay comentarios aún. ¡Sé el primero!</p>';
    } else {
      comentarios.slice(0,10).forEach(c=>{
        const div = document.createElement("div");
        div.className = "comentario";
        div.innerHTML = `<strong style="color:#800000;">${c.ciudad || "Usuario"}</strong> · <span style="color:#666;">${(c.fecha||"").slice(0,10)}</span> <em>“${c.comentario}”</em>`;
        lista.appendChild(div);
      });
    }
    if (lista.style.maxHeight && lista.style.maxHeight !== "0px") {
      lista.style.maxHeight = lista.scrollHeight + "px";
    }
  }catch(e){
    console.error("Comentarios:", e);
    document.getElementById("lista-comentarios").innerHTML = "<p>No se pudieron cargar los comentarios.</p>";
  }
}
function wireEnviarValoracion(vino_id){
  let puntuacionSeleccionada = 0;
  document.querySelectorAll(".estrella").forEach(e=>{
    e.addEventListener("click", ()=>{
      puntuacionSeleccionada = parseInt(e.dataset.value);
      document.querySelectorAll(".estrella").forEach(star=>{
        star.classList.toggle("seleccionada", parseInt(star.dataset.value) <= puntuacionSeleccionada);
      });
    });
  });
  document.getElementById("enviar-valoracion").addEventListener("click", async()=>{
    const comentario = document.getElementById("comentario").value || "";
    const msg = document.getElementById("mensaje-valoracion");
    if (!puntuacionSeleccionada){
      msg.innerText = "Selecciona una puntuación (1–5)."; msg.style.color="red"; return;
    }
    try{
      await fetch(`${N8N_BASE}/comentar-vino`, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({
          vino_id, puntuacion: puntuacionSeleccionada, comentario,
          user_id: sessionId(), idioma: (new URLSearchParams(location.search).get('lang')||'es').slice(0,2),
          ua: navigator.userAgent || "", src: new URLSearchParams(location.search).get('src')||""
        })
      });
      msg.innerText = "¡Gracias por tu valoración!"; msg.style.color="green";
      document.querySelectorAll(".estrella").forEach(star=>star.classList.remove("seleccionada"));
      document.getElementById("comentario").value = "";
      cargarValoraciones(vino_id); cargarComentarios(vino_id);
    }catch(e){
      msg.innerText = "Error al enviar tu valoración."; msg.style.color="red";
    }
  });
}
window.toggleComentarios = function(){
  const el = document.getElementById("lista-comentarios");
  if (el.style.maxHeight === "0px" || !el.style.maxHeight) el.style.maxHeight = el.scrollHeight + "px";
  else el.style.maxHeight = "0px";
};

/* ========= TRACKING (scan) ========= */
function trackScan(vino_id){
  const lang = (new URLSearchParams(location.search).get('lang') || (navigator.language||'es')).slice(0,2).toLowerCase();
  const src  = new URLSearchParams(location.search).get('src') || "";
  fetch(`${N8N_BASE}/qr/scan?vino_id=${encodeURIComponent(vino_id)}&lang=${encodeURIComponent(lang)}&src=${encodeURIComponent(src)}`).catch(()=>{});
}

/* ========= BOOT ========= */
document.addEventListener("DOMContentLoaded", async function(){
  try{
    const CTX = resolveCtx();
    if (!CTX.vino_id){ document.getElementById("respuesta").innerText = "No se especificó ningún vino."; return; }

    const params = new URLSearchParams(location.search);
    if (!params.has('lang')) { params.set('lang', CTX.lang); history.replaceState({}, '', `${location.pathname}?${params.toString()}`); }

    const fichaUrl = currentFichaUrl(CTX);
    const data = await loadFicha(fichaUrl);
    if (!data) throw new Error("No se pudo cargar la ficha publicada.");
    window.__FICHA_DATA__ = data;
    paintBasics(data);
    paintNarrativa(data);
    window.__ORGANO__ = data?.ficha?.organoleptico || {};
    setRadarType('aromatico');

    trackScan(CTX.vino_id);
    await Promise.all([cargarValoraciones(CTX.vino_id), cargarComentarios(CTX.vino_id)]);
    wireEnviarValoracion(CTX.vino_id);
  }catch(err){
    console.error(err);
    document.getElementById("respuesta").innerText = "No se pudo cargar la ficha publicada de este vino.";
  }
});
</script>

  <!-- JS APP -->
 

  </script>
  <script type="module">
 
</body>
</html>
