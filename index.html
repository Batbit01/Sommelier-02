
 <!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title id="vinoTitle">Ficha del Vino</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: sans-serif; padding: 2rem; background-color: #fefefe; color: #222; max-width: 600px; margin: auto; }
        .vino-ficha img { width: 100%; max-height: 300px; object-fit: contain; border-radius: 1rem; }
        .vino-dato { margin-bottom: 1rem; }
        .vino-dato strong { display: inline-block; width: 100px; }
        #respuesta { margin-top: 2rem; font-style: italic; background: #f1f1f1; padding: 1rem; border-radius: 0.5rem; }
        #hablar { display: inline-block; margin-top: 2rem; padding: 0.75rem 1.5rem; background: #800000; color: white; border: none; border-radius: 1rem; cursor: pointer; }
        .redes a { margin-right: 1rem; text-decoration: none; color: #800000; }
        .switch-buttons button { margin-right: 1rem; padding: 0.5rem 1rem; background: #eee; border: 1px solid #ccc; border-radius: 0.5rem; cursor: pointer; }
        #radar-container, #score-container, #valoracion-container { margin-top: 3rem; }
        #score-bar { width: 100%; height: 20px; background-color: #ddd; border-radius: 10px; overflow: hidden; }
        #score-fill { height: 100%; background-color: #800000; text-align: center; line-height: 20px; color: white; font-size: 0.9rem; }
        #estrellas .estrella { font-size: 2rem; color: #ccc; cursor: pointer; }
        #estrellas .estrella.seleccionada { color: #800000; }
        #estrellas-nota { color: #800000; font-size: 1.8rem; vertical-align: middle; }
        #lista-comentarios .comentario { margin-bottom: 1rem; padding: 0.75rem; border: 1px solid #ddd; border-radius: 0.5rem; background-color: #fafafa; }
    </style>
</head>
<body>
    <!-- ESTRUCTURA HTML (SIN CAMBIOS ) -->
    <h1 id="vinoTitulo">Ficha del Vino</h1>
    <div class="vino-ficha">
        <img alt="Imagen del vino" id="vinoImagen" src=""/>
        <div class="vino-dato"><strong>Tipo:</strong> <span id="vinoTipo">-</span></div>
        <div class="vino-dato"><strong>Origen:</strong> <span id="vinoOrigen">-</span></div>
        <div class="vino-dato"><strong>Variedad:</strong> <span id="vinoUva">-</span></div>
        <div class="vino-dato"><strong>Bodega:</strong> <span id="bodegaNombre">-</span></div>
        <div class="vino-dato redes" id="bodega-redes"></div>
    </div>
    <div id="respuesta">Cargando descripci√≥n del vino...</div>
    <button id="hablar">Hablar con el sommelier</button>
    <div id="rating-summary" style="margin-top:2rem; display:none;">
        <span id="media-nota" style="font-size:2rem; font-weight:bold; margin-right:0.5rem;">-</span>
        <span id="estrellas-nota"></span>
        <span id="total-valoraciones" style="margin-left:0.5rem; font-size:1rem; color:#555;"></span>
    </div>
    <div id="radar-container">
        <h3>Perfil organol√©ptico</h3>
        <div class="switch-buttons">
            <button onclick="renderRadar('gustativo')">Gustativo</button>
            <button onclick="renderRadar('aromatico')">Arom√°tico</button>
            <button onclick="renderRadar('sensorial')">Sensorial</button>
        </div>
        <canvas height="400" id="radarChart" width="400"></canvas>
    </div>
    <div id="score-container">
        <h3>Puntuaci√≥n Total</h3>
        <div id="score-bar"><div id="score-fill" style="width: 0%">0</div></div>
    </div>
    <div id="valoracion-container">
        <h3>Valora este vino</h3>
        <div id="estrellas">
            <span class="estrella" data-value="1">‚òÖ</span><span class="estrella" data-value="2">‚òÖ</span><span class="estrella" data-value="3">‚òÖ</span><span class="estrella" data-value="4">‚òÖ</span><span class="estrella" data-value="5">‚òÖ</span>
        </div>
        <textarea id="comentario" placeholder="Deja un comentario sobre el vino..." rows="4" style="width:100%; margin-top: 1rem; padding: 0.5rem;"></textarea>
        <button id="enviar-valoracion" style="margin-top: 1rem; background:#800000; color:white; border:none; padding:0.5rem 1rem; border-radius:0.5rem; cursor:pointer;">Enviar valoraci√≥n</button>
        <p id="mensaje-valoracion" style="margin-top:1rem; color: green;"></p>
    </div>
    <div id="datos-usuario-debug" style="margin-top: 2rem; padding: 1rem; background-color: #f2f2f2; border-radius: 0.5rem; font-family: sans-serif;">
        <strong>üåç Datos detectados:</strong>  

        Ciudad: <span id="debug-ciudad">...</span> | Pa√≠s: <span id="debug-pais">...</span> | Idioma: <span id="debug-idioma">...</span>
    </div>
    <div id="comentarios-container" style="margin-top: 3rem;">
        <h3 style="cursor:pointer; color:#800000;" onclick="toggleComentarios()">‚ñº Comentarios de otros usuarios</h3>
        <div id="lista-comentarios" style="max-height: 0; overflow: hidden; transition: max-height 0.5s ease-out;">
            <p style="padding: 1rem 0;">Cargando comentarios...</p>
        </div>
    </div>

    <!-- =============================================================== -->
    <!-- ============= UN √öNICO SCRIPT PARA TODA LA L√ìGICA ============= -->
    <!-- =============================================================== -->
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            // --- VARIABLES GLOBALES Y CONFIGURACI√ìN ---
            let radarChart;
            let organo = {};
            let puntuacionSeleccionada = 0;
            const urlParams = new URLSearchParams(window.location.search);
            const vinoId = urlParams.get("vino_id");

            // --- FUNCIONES DE RENDERIZADO ---
            window.renderRadar = function(tipo) {
                if (!organo || Object.keys(organo).length === 0) return;
                const ctx = document.getElementById('radarChart').getContext('2d');
                if (radarChart) radarChart.destroy();
                let labels = [], data = [];
                if (tipo === 'gustativo') {
                    labels = ["Cuerpo", "Acidez", "Dulzor", "Taninos", "Frescura", "Mineralidad"];
                    data = [organo.cuerpo, organo.acidez, organo.dulzor, organo.taninos, organo.frescura, organo.mineralidad];
                } else if (tipo === 'aromatico') {
                    labels = ["Fruta", "Floral", "Especiado", "Tostado", "Herb√°ceo"];
                    data = [organo.fruta, organo.floral, organo.especiado, organo.tostado, organo.herbaceo];
                } else if (tipo === 'sensorial') {
                    labels = ["Persistencia", "Complejidad", "Astringencia", "Alcohol percibido", "Armon√≠a"];
                    data = [organo.persistencia, organo.complejidad, organo.astringencia, organo.alcohol_percibido, organo.armonia];
                }
                radarChart = new Chart(ctx, { type: 'radar', data: { labels, datasets: [{ label: `Perfil ${tipo}`, data: data.map(x => parseInt(x) || 0), fill: true, backgroundColor: "rgba(128,0,0,0.2)", borderColor: "rgba(128,0,0,1)", pointBackgroundColor: "rgba(128,0,0,1)" }] }, options: { responsive: true, scales: { r: { min: 0, max: 10, ticks: { stepSize: 2 } } } } });
            }

            function calcularPuntuacionTotal() {
                let total = 0;
                for (const key in organo) total += parseInt(organo[key]) || 0;
                const maxScore = Object.keys(organo).length * 10;
                const porcentaje = maxScore > 0 ? Math.round((total / maxScore) * 100) : 0;
                const fill = document.getElementById("score-fill");
                fill.style.width = porcentaje + "%";
                fill.innerText = porcentaje + " / 100";
            }

            function renderEstrellas(nota) {
                const contenedor = document.getElementById("estrellas-nota");
                contenedor.innerHTML = "";
                const estrellas = Math.floor(nota);
                const media = nota - estrellas;
                for (let i = 1; i <= 5; i++) {
                    if (i <= estrellas) contenedor.innerHTML += "‚òÖ";
                    else if (i === estrellas + 1 && media >= 0.25 && media < 0.75) contenedor.innerHTML += "‚Ø™";
                    else contenedor.innerHTML += "‚òÜ";
                }
            }

            // --- FUNCIONES DE CARGA DE DATOS (APIs) ---
            async function cargarFichaVino() {
                try {
                    const fichaData = await (await fetch(`https://sommelierlab-api-production.up.railway.app/api/vino/${vinoId}` )).json();
                    document.getElementById("vinoImagen").src = fichaData.imagen?.[0]?.url || "";
                    document.title = document.getElementById("vinoTitulo").innerText = fichaData.nombre || "Ficha del Vino";
                    document.getElementById("vinoTipo").innerText = fichaData.tipo;
                    document.getElementById("vinoUva").innerText = fichaData.variedad;
                    document.getElementById("vinoOrigen").innerText = fichaData.origen;
                    document.getElementById("bodegaNombre").innerText = fichaData.bodega?.nombre || "";
                    const redesHtml = [];
                    if (fichaData.bodega?.web) redesHtml.push(`<a href="${fichaData.bodega.web}" target="_blank">üåê Web</a>`);
                    if (fichaData.bodega?.facebook) redesHtml.push(`<a href="${fichaData.bodega.facebook}" target="_blank">üìò Facebook</a>`);
                    if (fichaData.bodega?.instagram) redesHtml.push(`<a href="${fichaData.bodega.instagram}" target="_blank">üì∏ Instagram</a>`);
                    if (fichaData.bodega?.twitter) redesHtml.push(`<a href="${fichaData.bodega.twitter}" target="_blank">üê¶ Twitter</a>`);
                    document.getElementById("bodega-redes").innerHTML = redesHtml.join(" ¬∑ ");
                } catch (error) { console.error("‚ùå Error cargando la ficha del vino:", error); }
            }

            async function cargarPerfilOrganoleptico() {
                try {
                    organo = await (await fetch(`https://sommelierlab-api-production.up.railway.app/api/organoleptica/${vinoId}` )).json();
                    renderRadar("gustativo");
                    calcularPuntuacionTotal();
                } catch (error) { console.error("‚ùå Error cargando el perfil organol√©ptico:", error); }
            }

            async function cargarNarrativaVino() {
                try {
                    const dataCerebro = await (await fetch(`https://n8n-production-cb18.up.railway.app/webhook/consultar-vino?vino_id=${vinoId}` )).json();
                    document.getElementById("respuesta").innerText = dataCerebro.narrativa || "No se pudo generar la narrativa del vino.";
                } catch (error) { console.error("‚ùå Error cargando la narrativa del vino:", error); }
            }

            async function cargarResumenValoraciones() {
                try {
                    const data = await (await fetch(`https://n8n-production-cb18.up.railway.app/webhook/consultar-valoraciones?vino_id=${vinoId}` )).json();
                    if (data.total_valoraciones > 0) {
                        document.getElementById("rating-summary").style.display = "block";
                        document.getElementById("media-nota").innerText = data.nota_media.toFixed(1);
                        renderEstrellas(data.nota_media);
                        document.getElementById("total-valoraciones").innerText = `(${data.total_valoraciones} valoraciones)`;
                    }
                } catch (error) { console.error("Error al cargar resumen de valoraciones:", error); }
            }

            // --- L√ìGICA DE COMENTARIOS ---
            const listaComentariosEl = document.getElementById("lista-comentarios");
            window.toggleComentarios = function() {
                if (listaComentariosEl.style.maxHeight === "0px" || !listaComentariosEl.style.maxHeight) {
                    listaComentariosEl.style.maxHeight = listaComentariosEl.scrollHeight + "px";
                } else {
                    listaComentariosEl.style.maxHeight = "0px";
                }
            }
            function formatearFecha(fechaStr) {
                return new Date(fechaStr).toLocaleDateString("es-ES", { year: "numeric", month: "long", day: "numeric" });
            }
            async function cargarComentarios() {
                try {
                    const comentarios = await (await fetch(`https://n8n-production-cb18.up.railway.app/webhook/consultar-comentarios?vino_id=${vinoId}` )).json();
                    listaComentariosEl.innerHTML = "";
                    if (comentarios.length === 0) {
                        listaComentariosEl.innerHTML = '<p style="padding: 1rem 0;">No hay comentarios a√∫n. ¬°S√© el primero en opinar!</p>';
                    } else {
                        comentarios.slice(0, 10).forEach(c => {
                            const div = document.createElement("div");
                            div.className = "comentario";
                            div.innerHTML = `<strong style="color:#800000;">${c.ciudad || "Usuario an√≥nimo"}</strong> ¬∑ <span style="color: #666;">${formatearFecha(c.fecha)}</span>  
<em>‚Äú${c.comentario}‚Äù</em>`;
                            listaComentariosEl.appendChild(div);
                        });
                    }
                    // ===== LA CORRECCI√ìN EST√Å AQU√ç =====
                    if (listaComentariosEl.style.maxHeight !== "0px" && listaComentariosEl.style.maxHeight !== "") {
                        listaComentariosEl.style.maxHeight = listaComentariosEl.scrollHeight + "px";
                    }
                } catch (error) { 
                    console.error("Error al cargar comentarios:", error);
                    listaComentariosEl.innerHTML = "<p>No se pudieron cargar los comentarios.</p>";
                }
            }

            // --- L√ìGICA DE INICIALIZACI√ìN Y EVENTOS ---
            if (!vinoId) {
                document.getElementById("respuesta").innerText = "No se especific√≥ ning√∫n vino.";
                return;
            }

            // 1. Cargar datos de geolocalizaci√≥n PRIMERO
            fetch("https://ipapi.co/json/" )
                .then(response => response.json())
                .then(data => {
                    window._datosUsuario = { ciudad: data.city, pais: data.country_name, idioma: navigator.language };
                    document.getElementById("debug-ciudad").innerText = data.city || "No detectado";
                    document.getElementById("debug-pais").innerText = data.country_name || "No detectado";
                    document.getElementById("debug-idioma").innerText = navigator.language;
                })
                .catch(error => {
                    console.warn("No se pudo obtener geolocalizaci√≥n:", error);
                    window._datosUsuario = {}; // Asegurarse de que exista el objeto aunque falle
                })
                .finally(() => {
                    // 2. Una vez TERMINADA la geolocalizaci√≥n, configurar los listeners y cargar el resto
                    
                    // Listener para las estrellas
                    document.querySelectorAll(".estrella").forEach(e => {
                        e.addEventListener("click", () => {
                            puntuacionSeleccionada = parseInt(e.dataset.value);
                            document.querySelectorAll(".estrella").forEach(star => {
                                star.classList.toggle("seleccionada", parseInt(star.dataset.value) <= puntuacionSeleccionada);
                            });
                        });
                    });

                    // Listener para el bot√≥n de enviar valoraci√≥n
                    document.getElementById("enviar-valoracion").addEventListener("click", async () => {
                        const comentario = document.getElementById("comentario").value || "";
                        const mensaje = document.getElementById("mensaje-valoracion");
                        if (!puntuacionSeleccionada) {
                            mensaje.innerText = "Por favor, selecciona una puntuaci√≥n (de 1 a 5 estrellas).";
                            mensaje.style.color = "red";
                            return;
                        }
                        try {
                            await fetch("https://n8n-production-cb18.up.railway.app/webhook/comentar-vino", {
                                method: "POST",
                                headers: { "Content-Type": "application/json" },
                                body: JSON.stringify({
                                    vino_id: vinoId,
                                    puntuacion: puntuacionSeleccionada,
                                    comentario: comentario,
                                    user_id: localStorage.getItem("user_id" ) || "user_" + Math.random().toString(36).substring(2, 10),
                                    ciudad: window._datosUsuario?.ciudad || "Desconocida",
                                    pais: window._datosUsuario?.pais || "Desconocido",
                                    idioma: window._datosUsuario?.idioma || "es"
                                })
                            });
                            mensaje.innerText = "¬°Gracias por tu valoraci√≥n!";
                            mensaje.style.color = "green";
                        } catch (err) {
                            mensaje.innerText = "Error al enviar tu valoraci√≥n.";
                            mensaje.style.color = "red";
                        }
                    });

                    // 3. Cargar todos los datos del vino en paralelo
                    cargarFichaVino();
                    cargarPerfilOrganoleptico();
                    cargarNarrativaVino();
                    cargarResumenValoraciones();
                    cargarComentarios();
                });
        });
    </script>
</body>
</html>
