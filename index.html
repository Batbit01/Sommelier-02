<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>SommelierLab Â· Ficha del vino</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Tailwind CDN solo para MVP -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{ --accent-color:#c79a5a; }
    body{ background:#0f0a0a; color:#fff; }
    .frame-soft{ box-shadow:0 8px 30px rgba(0,0,0,.35), inset 0 0 0 1px rgba(255,255,255,.04); }
    .fade-in{ animation:fadeIn .35s ease-out both }
    @keyframes fadeIn{ from{opacity:0;transform:translateY(4px)} to{opacity:1;transform:none} }
    #debug{max-height:280px}
  </style>
</head>
<body class="min-h-screen">
  <pre id="debug" class="hidden bg-red-900/25 text-[10px] leading-snug p-3 overflow-auto"></pre>
  <div id="app" class="max-w-[1100px] mx-auto px-4 sm:px-6 pb-28 sm:pb-12"></div>

  <script>
  /* =================== CONFIG =================== */
  const CDN_BASE = "https://f005.backblazeb2.com/file/SommelierLab-media";

  /* =================== I18N =================== */
  const UI = {
    es:{share:"Compartir",sommelier:"PresentaciÃ³n del sommelier",gallery:"GalerÃ­a",social:"Redes y contacto",legal:"Bebe con responsabilidad"},
    en:{share:"Share",sommelier:"Sommelier presentation",gallery:"Gallery",social:"Social & contact",legal:"Drink responsibly"},
    fr:{share:"Partager",sommelier:"PrÃ©sentation du sommelier",gallery:"Galerie",social:"RÃ©seaux et contact",legal:"Buvez avec modÃ©ration"}
  };

  /* =================== STATE =================== */
  const S = { q:{}, ficha:null, t:UI.es };

  /* =================== HELPERS =================== */
  const $ = (s,sc=document)=>sc.querySelector(s);
  function getQ(){
    const p=new URLSearchParams(location.search);
    return {
      vino_id: p.get("vino_id")||"",
      anyada:  p.get("anyada")||"",
      lang:    (p.get("lang")||"es").slice(0,2).toLowerCase(),
      context: p.get("context")||"",
      debug:   p.get("debug")==="1"
    };
  }
  function dbg(x){ const d=$("#debug"); if(!d||!S.q.debug) return; d.classList.remove("hidden"); d.textContent = typeof x==="string"?x:JSON.stringify(x,null,2).slice(0,4000); }

  const pickImg=(v)=>{
    if(!v) return "";
    if(typeof v==="string") return v;
    if(Array.isArray(v)&&v.length){ const f=v[0]; if(typeof f==="string") return f; if(f&&f.url) return f.url; }
    return v.url||"";
  };

  /* =================== CDN =================== */
  const urlFicha=(vino,any,lang)=>`${CDN_BASE}/qr2/${encodeURIComponent(vino)}/${encodeURIComponent(any)}/${encodeURIComponent(lang)}/ficha.json`;
  const urlAudio=(vino,any,lang)=>`${CDN_BASE}/qr2/audio/${encodeURIComponent(vino)}/${encodeURIComponent(any)}/${encodeURIComponent(lang)}/base.mp3`;

  async function fetchJSON(u){ const r=await fetch(u,{cache:"no-store"}); if(!r.ok) throw new Error(String(r.status)); return r.json(); }
  async function headOk(u){ try{ const r=await fetch(u,{method:"HEAD"}); return r.ok; }catch{ return false; } }

  async function loadFicha(vino,any,lang){
    const tries = [
      urlFicha(vino, any||"default", lang),
      urlFicha(vino, any||"default", "es"),
      ...(any? [urlFicha(vino, "default", lang), urlFicha(vino, "default", "es")] : [])
    ];
    // ordenar para que si hay anyada se pruebe primero anyada/lang â†’ anyada/es â†’ default/lang â†’ default/es
    const ordered = any ? [urlFicha(vino,any,lang), urlFicha(vino,any,"es"), urlFicha(vino,"default",lang), urlFicha(vino,"default","es")] :
                           [urlFicha(vino,"default",lang), urlFicha(vino,"default","es")];
    for(const u of ordered){
      try{
        const j=await fetchJSON(u);
        j.__cdn_url=u; j.__cdn_lang=(j.lang||lang||"es").toLowerCase();
        return j;
      }catch(e){ /* siguiente */ }
    }
    throw new Error("No hay ficha en CDN");
  }

  function normalize(raw,q){
    // Si ya es el esquema final, solo aseguro imagen y estructura mÃ­nima
    if(raw && raw.schema_version==="qr2-ficha-1" && raw.ficha){
      const h = raw.for_front && raw.for_front.header || {};
      const img = raw.ficha?.bottle_media?.image_url || h.imagen || raw.assets?.image_url || pickImg(raw.ficha?.vino?.Imagen);
      raw.ficha.bottle_media = { image_url: img||"", video_url: "" };
      // narrativa texto si venÃ­a plano
      if(typeof raw.ficha.narrativa === "string"){
        raw.ficha.narrativa = { texto: raw.ficha.narrativa, audio_url: "" };
      }else{
        raw.ficha.narrativa = raw.ficha.narrativa || { texto:"", audio_url:"" };
      }
      // organolÃ©ptico
      if(!raw.ficha.organoleptico){
        const of = raw.for_front?.organoleptico || {};
        raw.ficha.organoleptico = { texto: of.texto || raw.organoleptico?.texto || "", servicio: of.servicio || raw.organoleptico?.servicio || null, barras: {} };
      }
      // DO y variedad
      raw.ficha.do = raw.ficha.do || raw.for_front?.header?.do || raw.bodega_info?.["Origen/DO"] || "";
      raw.ficha.variedad = raw.ficha.variedad || raw.for_front?.header?.variedad || raw.ficha?.vino?.["Variedad de uva"] || "";
      return raw;
    }

    // NormalizaciÃ³n defensiva para JSONs previos
    const h = raw?.for_front?.header || {};
    const v = raw?.ficha?.vino || raw?.vino || {};
    const b = raw?.bodega_info || {};
    return {
      schema_version:"qr2-ficha-1",
      vino_id: raw?.vino_id || q.vino_id,
      anyada:  raw?.anyada  || q.anyada,
      lang:    raw?.lang    || q.lang,
      ficha:{
        bodega: h.bodega || b["Bodega"] || raw?.ficha?.bodega || "",
        nombre: h.titulo || raw?.ficha?.title || v["Nombre del vino"] || "",
        year:   h.anyada || raw?.anyada || q.anyada || "",
        do:     h.do || raw?.ficha?.do || b["Origen/DO"] || v["Origen/DO"] || "",
        variedad: h.variedad || raw?.ficha?.variedad || v["Variedad de uva"] || "",
        bottle_media:{ image_url: raw?.assets?.image_url || h.imagen || pickImg(v.Imagen) || "", video_url:"" },
        narrativa:{ texto: (raw?.ficha?.narrativa && typeof raw.ficha.narrativa==="string") ? raw.ficha.narrativa : (raw?.for_front?.narrativa_es||""),
                    audio_url:"" },
        organoleptico:{ texto: raw?.for_front?.organoleptico?.texto || raw?.organoleptico?.texto || "",
                        servicio: raw?.for_front?.organoleptico?.servicio || raw?.organoleptico?.servicio || null,
                        barras:{} },
        tech_info:{
          vinificacion_y_crianza: raw?.ficha?.["Proceso de crianza"] ? [String(raw.ficha["Proceso de crianza"])] : [],
          notas_de_cata: v["Notas de cata"] ? [String(v["Notas de cata"])] : [],
          curiosidad: raw?.modules?.curiosidad ? [String(raw.modules.curiosidad)] : []
        },
        cta:{
          comprar_url:"",
          visita_url: raw?.for_front?.enoturismo?.reserva_url || b["Reservas_URL_Base"] || "",
          contacto_url: (raw?.for_front?.contacto?.email || b["Email de contacto"]) ? `mailto:${raw?.for_front?.contacto?.email || b["Email de contacto"]}` : ""
        },
        gallery:[]
      },
      social:{
        website: raw?.for_front?.contacto?.web || b["Web URL"] || "",
        email:   raw?.for_front?.contacto?.email || b["Email de contacto"] || ""
      },
      modules: raw?.modules || { narrativa:true, organoleptico:true, tech:true, cta:true, actions:true, social:true, sommelier:true },
      for_front: raw?.for_front || null,
      __cdn_url: raw?.__cdn_url || raw?.ficha_path || "",
      __cdn_lang: raw?.__cdn_lang || (raw?.lang || q.lang || "es")
    };
  }

  async function attachAudio(data,q){
    const langs=[(q.lang||"es").toLowerCase(),"es"];
    const anys=[q.anyada||"default", "default"];
    for(const a of (q.anyada? [q.anyada,"default"] : ["default"])){
      for(const l of langs){
        const u = urlAudio(q.vino_id, a, l);
        if(await headOk(u)){ data.ficha.narrativa.audio_url=u; return data; }
      }
    }
    return data;
  }

  /* =================== RENDER =================== */
  function headerHTML(d){
    const langs = d.available_langs?.length ? d.available_langs : [d.__cdn_lang||S.q.lang||"es"];
    return `
    <header class="py-4 flex items-center justify-between gap-3">
      <div>
        <div class="text-sm text-neutral-300">${d.ficha.bodega||''}</div>
        <div class="text-2xl font-semibold">${d.ficha.nombre||''} <span class="text-neutral-400">${d.ficha.year||''}</span></div>
        <div class="mt-1 flex flex-wrap items-center gap-2 text-[11px]">
          ${ d.ficha.do ? `<span class="px-2 py-1 rounded-full bg-neutral-800 border border-neutral-700">${d.ficha.do}</span>` : '' }
          ${ d.ficha.variedad ? `<span class="px-2 py-1 rounded-full bg-neutral-800 border border-neutral-700">${d.ficha.variedad}</span>` : '' }
        </div>
        <div class="text-[10px] text-neutral-600 mt-1">CDN: ${d.__cdn_url||"â€“"} (${d.__cdn_lang||"?"})</div>
      </div>
      <div class="flex items-center gap-3">
        <select id="langSel" class="bg-neutral-900 border border-neutral-700 rounded-lg px-2 py-1 text-sm">
          ${ langs.map(l=>`<option value="${l}" ${l===(d.__cdn_lang||S.q.lang)?'selected':''}>${l.toUpperCase()}</option>`).join('') }
        </select>
        <button id="shareBtn" class="text-amber-400 underline">${S.t.share}</button>
      </div>
    </header>
    <hr class="border-neutral-800">`;
  }
  function heroHTML(d){
    const img = d.ficha?.bottle_media?.image_url;
    if(!img) return "";
    return `
      <section class="py-6">
        <img src="${img}" alt="bottle"
          class="w-40 h-64 mx-auto object-contain rounded-xl border border-neutral-700 bg-neutral-800 frame-soft shadow-xl">
      </section>
      <hr class="border-neutral-800">`;
  }
  function narrativaHTML(d){
    const n=d.ficha?.narrativa?.texto||"";
    const au=d.ficha?.narrativa?.audio_url||"";
    if(!n && !au) return "";
    return `
      <section class="py-6">
        <h2 class="text-xl font-semibold mb-2">${S.t.sommelier}</h2>
        ${ n ? `<p class="text-neutral-200 leading-relaxed mb-3">${n.replace(/\n/g,"<br>")}</p>` : "" }
        ${ au ? `<audio controls class="w-full"><source src="${au}" type="audio/mpeg"></audio>` : `<p class="text-[11px] text-neutral-500">Audio no disponible.</p>` }
      </section>
      <hr class="border-neutral-800">`;
  }
  function organoHTML(d){
    const o=d.ficha?.organoleptico||{};
    if(!(o.texto || o.servicio?.temperatura)) return "";
    return `
      <section class="py-6">
        ${ o.texto ? `<p class="text-sm leading-relaxed text-neutral-200">${o.texto.replace(/\n/g,"<br>")}</p>` : "" }
        ${ o.servicio?.temperatura ? `<p class="text-[12px] text-neutral-400 mt-2">Temperatura de servicio: ${o.servicio.temperatura}</p>` : "" }
      </section>
      <hr class="border-neutral-800">`;
  }
  function techHTML(d){
    const t=d.ficha?.tech_info||{};
    const entries = Object.entries(t).filter(([,v])=>Array.isArray(v)&&v.length);
    if(!entries.length) return "";
    return `
      <section class="py-6">
        <div class="space-y-4">
          ${entries.map(([k,arr])=>`
           <details class="group border border-neutral-800 rounded-xl p-3">
             <summary class="cursor-pointer font-medium text-neutral-100">${k.replaceAll('_',' ')}</summary>
             <div class="mt-2 text-neutral-300">${arr.map(x=>`<p class="mb-2">${x}</p>`).join('')}</div>
           </details>`).join('')}
        </div>
      </section>
      <hr class="border-neutral-800">`;
  }
  function ctaHTML(d){
    const c=d.ficha?.cta||{};
    if(!c.comprar_url && !c.visita_url && !c.contacto_url) return "";
    return `
      <section class="py-6 flex flex-wrap gap-3">
        ${ c.comprar_url ? `<a href="${c.comprar_url}" class="bg-amber-500 text-neutral-900 rounded-xl px-4 py-2">Comprar</a>` : "" }
        ${ c.visita_url ? `<a href="${c.visita_url}" class="bg-neutral-800 border border-neutral-700 rounded-xl px-4 py-2">Visitar bodega</a>` : "" }
        ${ c.contacto_url ? `<a href="${c.contacto_url}" class="underline text-amber-400">Contacto</a>` : "" }
      </section>
      <hr class="border-neutral-800">`;
  }
  function socialHTML(d){
    const s=d.social||{};
    if(!(s.website||s.email)) return "";
    return `
      <section class="py-6">
        <h2 class="text-lg mb-3 text-neutral-100">${S.t.social}</h2>
        <div class="flex flex-wrap gap-3 text-sm">
          ${ s.website ? `<a href="${s.website}" class="underline text-amber-400" target="_blank">Web</a>` : "" }
          ${ s.email ? `<a href="mailto:${s.email}" class="underline text-amber-400">Email</a>` : "" }
        </div>
      </section>
      <hr class="border-neutral-800">`;
  }
  function footerHTML(d){
    return `<footer class="py-10 text-center text-neutral-400">
      <div><a href="https://sommelierlab.com" class="underline">Powered by SommelierLab</a></div>
      <div class="mt-4">${(UI[d.__cdn_lang]||UI.es).legal}</div>
    </footer>`;
  }

  function render(d){
    S.t = UI[d.__cdn_lang] || UI.es;
    const app=$("#app");
    app.innerHTML = [
      headerHTML(d),
      heroHTML(d),
      narrativaHTML(d),
      organoHTML(d),
      techHTML(d),
      ctaHTML(d),
      socialHTML(d),
      footerHTML(d)
    ].join("");

    const sel=$("#langSel");
    if(sel){ sel.addEventListener("change",()=>{ const u=new URL(location.href); u.searchParams.set("lang", sel.value); location.href=u.toString(); }); }
    const sb=$("#shareBtn");
    if(sb){ sb.addEventListener("click", async ()=>{ try{
      if(navigator.share) await navigator.share({title:document.title, url:location.href});
      else { await navigator.clipboard.writeText(location.href); sb.textContent="Copiado"; setTimeout(()=>sb.textContent=S.t.share,1200); }
    }catch{} }); }
  }

  /* =================== BOOT =================== */
  (async function(){
    S.q = getQ();
    if(!S.q.vino_id || !S.q.anyada){
      $("#app").innerHTML = '<div class="p-6 text-red-400">Faltan parÃ¡metros ?vino_id=...&anyada=...</div>';
      return;
    }
    try{
      const raw = await loadFicha(S.q.vino_id, S.q.anyada, S.q.lang);
      dbg(raw);
      const norm = normalize(raw, S.q);
      await attachAudio(norm, S.q);
      S.ficha = norm;
      render(norm);
    }catch(e){
      console.error(e);
      $("#app").innerHTML = '<div class="p-6 text-red-400">Error cargando la ficha.</div>';
    }
  })();
  </script>

  <!-- Sommelier conversacional flotante -->
  <style>
    #sommelier-float{ position:fixed; right:18px; bottom:100px; z-index:60;
      background: radial-gradient(circle at 30% 30%, #facc15 0%, #b45309 90%);
      box-shadow:0 0 18px rgba(0,0,0,0.4); border-radius:50px; cursor:pointer;
      display:flex; align-items:center; gap:10px; padding:10px 14px; }
    #sommelier-wrapper{ position:fixed; right:18px; bottom:165px; z-index:65; display:none; }
    #sommelier-close{ position:absolute; top:-28px; right:-14px; width:28px; height:28px; border-radius:50%;
      border:none; background:#facc15; color:#111; font-size:18px; font-weight:bold; cursor:pointer; z-index:99999; }
  </style>

  <div id="sommelier-float"><span style="font-size:28px">ðŸŽ™</span><span class="font-semibold text-neutral-900">Preguntar al sommelier</span></div>
  <div id="sommelier-wrapper">
    <button id="sommelier-close">âœ•</button>
    <elevenlabs-convai id="sommelier-widget"
      agent-id="agent_01jy4198vjepzb9yz3jwz3b93c"
      position="floating" behavior="expanded" variant="compact"></elevenlabs-convai>
  </div>
  <script src="https://unpkg.com/@elevenlabs/convai-widget-embed" async></script>
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const btn = document.getElementById("sommelier-float");
      const wrapper = document.getElementById("sommelier-wrapper");
      const widget = document.getElementById("sommelier-widget");
      const btnClose = document.getElementById("sommelier-close");
      const start = ()=>{
        if(widget?.startConversation) try{ widget.startConversation(); }catch{}
        setTimeout(()=>{ try{
          const sr = widget.shadowRoot; const b = sr && sr.querySelector("button,[role='button']"); if(b) b.click();
        }catch{} }, 400);
      };
      btn.addEventListener("click", ()=>{ wrapper.style.display="block"; setTimeout(start, 200); });
      btnClose.addEventListener("click", ()=>{ wrapper.style.display="none"; if(widget?.endConversation) widget.endConversation(); });
      document.addEventListener("click",(e)=>{ if(!e.target.closest("#sommelier-wrapper") && !e.target.closest("#sommelier-float")) wrapper.style.display="none"; });
    });
  </script>
</body>
</html>
