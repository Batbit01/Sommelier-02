
<!DOCTYPE html>
<!-- OMITIDO POR LONGITUD: ya fue generado anteriormente -->
<!-- El contenido completo est√° en el paso anterior. -->
="margin-top:1rem;color: green;"></p>
  </div>

<script>
let radarChart;
let organo = {};

function renderRadar(tipo) {
  if (!organo || Object.keys(organo).length === 0) return;
  const ctx = document.getElementById('radarChart').getContext('2d');
  if (radarChart) radarChart.destroy();
  let labels = [], data = [];

  if (tipo === 'gustativo') {
    labels = ["Cuerpo", "Acidez", "Dulzor", "Taninos", "Frescura", "Mineralidad"];
    data = [organo["cuerpo"], organo["acidez"], organo["dulzor"], organo["taninos"], organo["frescura"], organo["mineralidad"]];
  } else if (tipo === 'aromatico') {
    labels = ["Fruta", "Floral", "Especiado", "Tostado", "Herb√°ceo"];
    data = [organo["fruta"], organo["floral"], organo["especiado"], organo["tostado"], organo["herbaceo"]];
  } else if (tipo === 'sensorial') {
    labels = ["Persistencia", "Complejidad", "Astringencia", "Alcohol percibido", "Armon√≠a"];
    data = [organo["persistencia"], organo["complejidad"], organo["astringencia"], organo["alcohol_percibido"], organo["armonia"]];
  }

  radarChart = new Chart(ctx, {
    type: 'radar',
    data: {
      labels,
      datasets: [{
        label: `Perfil ${tipo}`,
        data: data.map(x => parseInt(x) || 0),
        fill: true,
        backgroundColor: "rgba(128,0,0,0.2)",
        borderColor: "rgba(128,0,0,1)",
        pointBackgroundColor: "rgba(128,0,0,1)"
      }]
    },
    options: {
      responsive: true,
      scales: {
        r: {
          min: 0,
          max: 10,
          ticks: { stepSize: 2 }
        }
      }
    }
  });
}

function calcularPuntuacionTotal() {
  let total = 0;
  for (const key in organo) total += parseInt(organo[key]) || 0;
  const maxScore = Object.keys(organo).length * 10;
  const porcentaje = Math.round((total / maxScore) * 100);
  const fill = document.getElementById("score-fill");
  fill.style.width = porcentaje + "%";
  fill.innerText = porcentaje + " / 100";
}

document.addEventListener("DOMContentLoaded", async () => {
  const urlParams = new URLSearchParams(window.location.search);
  const vinoId = urlParams.get("vino_id");
  const apiBase = "https://sommelierlab-api-production.up.railway.app/api/vino";
  const organoBase = "https://sommelierlab-api-production.up.railway.app/api/organoleptica";
  const webhookBase = "https://n8n-production-cb18.up.railway.app/webhook/consultar-vino";
  const webhookComentario = "https://n8n-production-cb18.up.railway.app/webhook/registrar-comentario";

  if (!vinoId) {
    document.getElementById("respuesta").innerText = "No se especific√≥ ning√∫n vino.";
    return;
  }

  try {
    const fichaData = await (await fetch(`${apiBase}/${vinoId}`)).json();
    document.getElementById("vinoImagen").src = (fichaData.imagen && Array.isArray(fichaData.imagen) && fichaData.imagen[0]?.url) ? fichaData.imagen[0].url : "";
    document.getElementById("vinoTitulo").innerText = fichaData.nombre || "Ficha del Vino";
    document.getElementById("vinoTipo").innerText = fichaData.tipo;
    document.getElementById("vinoUva").innerText = fichaData.variedad;
    document.getElementById("vinoOrigen").innerText = fichaData.origen;
    document.getElementById("bodegaNombre").innerText = fichaData.bodega.nombre;

    const redesHtml = [];
    if (fichaData.bodega.web) redesHtml.push(`<a href="${fichaData.bodega.web}" target="_blank">üåê Web</a>`);
    if (fichaData.bodega.facebook) redesHtml.push(`<a href="${fichaData.bodega.facebook}" target="_blank">üìò Facebook</a>`);
    if (fichaData.bodega.instagram) redesHtml.push(`<a href="${fichaData.bodega.instagram}" target="_blank">üì∏ Instagram</a>`);
    if (fichaData.bodega.twitter) redesHtml.push(`<a href="${fichaData.bodega.twitter}" target="_blank">üê¶ Twitter</a>`);
    document.getElementById("bodega-redes").innerHTML = redesHtml.join(" ¬∑ ");
  } catch (error) {
    console.error("‚ùå Error cargando ficha del vino:", error);
    document.getElementById("respuesta").innerText = "No se pudo cargar la ficha del vino.";
  }

  try {
    const narrativaData = await (await fetch(`${webhookBase}?vino_id=${vinoId}`)).json();
    document.getElementById("respuesta").innerText = narrativaData.narrativa || "Narrativa no disponible.";
  } catch (error) {
    console.error("‚ùå Error cargando narrativa:", error);
  }

  try {
    organo = await (await fetch(`${organoBase}/${vinoId}`)).json();
    renderRadar("gustativo");
    calcularPuntuacionTotal();
  } catch (error) {
    console.error("‚ùå Error cargando gr√°fico organol√©ptico:", error);
  }

  document.getElementById("hablar").addEventListener("click", async () => {
    try {
      await fetch(`${webhookBase}?vino_id=${vinoId}&accion=retell`);
      RetellWebSDK.init({
        agentId: "agent_dd24626bd6f65f2453277829bb",
        callType: "web",
        context: { vino_id: vinoId },
        start: true
      });
    } catch (e) {
      console.error("‚ùå Error iniciando Retell:", e);
    }
  });

  document.querySelectorAll(".estrella").forEach(e => {
    e.addEventListener("click", () => {
      const valor = parseInt(e.dataset.value);
      document.querySelectorAll(".estrella").forEach(star => {
        star.classList.toggle("seleccionada", parseInt(star.dataset.value) <= valor);
      });
      document.getElementById("mensaje-valoracion").innerText = `Has valorado este vino con ${valor} estrella${valor > 1 ? 's' : ''}.`;
      document.getElementById("enviarValoracion").dataset.valor = valor;
    });
  });

  document.getElementById("enviarValoracion").addEventListener("click", async () => {
    const valor = parseInt(document.getElementById("enviarValoracion").dataset.valor || "0");
    const comentario = document.getElementById("comentario").value || "";
    if (!valor) {
      document.getElementById("mensaje-valoracion").innerText = "Por favor selecciona una valoraci√≥n.";
      return;
    }
    try {
      await fetch(webhookComentario, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          vino_id: vinoId,
          comentario: comentario,
          puntuacion: valor
        })
      });
      document.getElementById("mensaje-valoracion").innerText = "¬°Gracias por tu valoraci√≥n!";
    } catch (err) {
      console.error("‚ùå Error enviando valoraci√≥n:", err);
      document.getElementById("mensaje-valoracion").innerText = "Error al enviar tu valoraci√≥n.";
    }
  });
});
</script>
</body>
</html>
