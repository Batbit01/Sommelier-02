
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title id="vinoTitle">Ficha del Vino</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: sans-serif; padding: 2rem; background-color: #fefefe; color: #222; max-width: 600px; margin: auto; }
        .vino-ficha img { width: 100%; max-height: 300px; object-fit: contain; border-radius: 1rem; }
        .vino-dato { margin-bottom: 1rem; }
        .vino-dato strong { display: inline-block; width: 100px; }
        #respuesta { margin-top: 2rem; font-style: italic; background: #f1f1f1; padding: 1rem; border-radius: 0.5rem; }
        #hablar { display: inline-block; margin-top: 2rem; padding: 0.75rem 1.5rem; background: #800000; color: white; border: none; border-radius: 1rem; cursor: pointer; }
        .redes a { margin-right: 1rem; text-decoration: none; color: #800000; }
        
        #radar-container { margin-top: 3rem; text-align: center; }
        .switch-buttons {
            display: flex;
            justify-content: center;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
        }
        .switch-buttons button {
            background-color: #a97c7c; 
            color: white;
            border: 2px solid #800000;
            padding: 0.6rem 1.2rem;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
        }
        .switch-buttons button:hover {
            background-color: #800000;
        }
        .switch-buttons button.active {
            background-color: #800000;
            box-shadow: 0 0 10px rgba(128,0,0,0.5 );
        }

        #score-container, #valoracion-container { margin-top: 3rem; }
        #score-bar { width: 100%; height: 20px; background-color: #ddd; border-radius: 10px; overflow: hidden; }
        #score-fill { height: 100%; background-color: #800000; text-align: center; line-height: 20px; color: white; font-size: 0.9rem; }
        #estrellas .estrella { font-size: 2rem; color: #ccc; cursor: pointer; }
        #estrellas .estrella.seleccionada { color: #800000; }
        #estrellas-nota { color: #800000; font-size: 1.8rem; vertical-align: middle; }
        #lista-comentarios .comentario { margin-bottom: 1rem; padding: 0.75rem; border: 1px solid #ddd; border-radius: 0.5rem; background-color: #fafafa; text-align: left; }
        #radarChart { max-width: 420px; max-height: 420px; margin: 0 auto; }
    </style>
</head>
<body>
    <!-- ESTRUCTURA HTML -->
    <h1 id="vinoTitulo">Ficha del Vino</h1>
    <div class="vino-ficha">
        <img alt="Imagen del vino" id="vinoImagen" src=""/>
        <div class="vino-dato"><strong>Tipo:</strong> <span id="vinoTipo">-</span></div>
        <div class="vino-dato"><strong>Origen:</strong> <span id="vinoOrigen">-</span></div>
        <div class="vino-dato"><strong>Variedad:</strong> <span id="vinoUva">-</span></div>
        <div class="vino-dato"><strong>Bodega:</strong> <span id="bodegaNombre">-</span></div>
        <div class="vino-dato redes" id="bodega-redes"></div>
    </div>
    <div id="respuesta">Cargando descripción del vino...</div>
    <button id="hablar">Hablar con el sommelier</button>
    
    <div id="radar-container">
        <h3>Perfil organoléptico</h3>
        <div class="switch-buttons">
            <button id="btn-aromatico" onclick="renderRadar('aromatico')">Aromático</button>
            <button id="btn-gustativo" onclick="renderRadar('gustativo')">Gustativo</button>
            <button id="btn-sensorial" onclick="renderRadar('sensorial')">Sensorial</button>
        </div>
        <div style="width: 100%; max-width: 420px; height: 420px; margin: auto;">
             <canvas id="radarChart" width="400" height="400"></canvas>
        </div>
    </div>
    <div id="score-container">
        <h3>Puntuación Total</h3>
        <div id="score-bar"><div id="score-fill" style="width: 0%">0</div></div>
        <div id="rating-summary" style="display: flex; align-items: center; gap: 0.5rem; margin-top: 1rem;">
           <span id="media-nota" style="font-size:2rem; font-weight:bold;">-</span>
           <span id="estrellas-nota" style="font-size:1.5rem; color: #800000;"></span>
           <span id="total-valoraciones" style="font-size:1rem; color:#555;"></span>
        </div>
    </div>

    <div id="valoracion-container">
        <h3>Valora este vino</h3>
        <div id="estrellas">
            <span class="estrella" data-value="1">★</span><span class="estrella" data-value="2">★</span><span class="estrella" data-value="3">★</span><span class="estrella" data-value="4">★</span><span class="estrella" data-value="5">★</span>
        </div>
        <textarea id="comentario" placeholder="Deja un comentario sobre el vino..." rows="4" style="width:100%; margin-top: 1rem; padding: 0.5rem;"></textarea>
        <button id="enviar-valoracion" style="margin-top: 1rem; background:#800000; color:white; border:none; padding:0.5rem 1rem; border-radius:0.5rem; cursor:pointer;">Enviar valoración</button>
        <p id="mensaje-valoracion" style="margin-top:1rem; color: green;"></p>
    </div>
    
    <div id="comentarios-container" style="margin-top: 3rem;">
        <h3 style="cursor:pointer; color:#800000;" onclick="toggleComentarios()">▼ Comentarios de otros usuarios</h3>
        <div id="lista-comentarios" style="max-height: 0; overflow: hidden; transition: max-height 0.5s ease-out;">
            <p style="padding: 1rem 0;">Cargando comentarios...</p>
        </div>
    </div>
    <!-- =============================================================== -->
    <!-- ============= UN ÚNICO SCRIPT PARA TODA LA LÓGICA ============= -->
    <!-- =============================================================== -->
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            // --- VARIABLES GLOBALES Y CONFIGURACIÓN ---
            let radarChart = null;
            let organo = {};
            let puntuacionSeleccionada = 0;
            const urlParams = new URLSearchParams(window.location.search);
            const vinoId = urlParams.get("vino_id");

            // --- FUNCIÓN DE RENDERIZADO DEL RADAR (pentágono/hexágono real, centro alineado) ---
            window.renderRadar = function(tipo) {
                if (!organo || Object.keys(organo).length === 0) return;
                const ctx = document.getElementById('radarChart').getContext('2d');
                if (radarChart) radarChart.destroy();

                let labels = [], data = [];
                if (tipo === 'gustativo') {
                    labels = ["Cuerpo", "Acidez", "Dulzor", "Taninos", "Frescura", "Mineralidad"]; // Hexágono
                    data = [organo.cuerpo, organo.acidez, organo.dulzor, organo.taninos, organo.frescura, organo.mineralidad];
                } else if (tipo === 'aromatico') {
                    labels = ["Fruta", "Floral", "Especiado", "Tostado", "Herbáceo"]; // Pentágono
                    data = [organo.fruta, organo.floral, organo.especiado, organo.tostado, organo.herbaceo];
                } else if (tipo === 'sensorial') {
                    labels = ["Persistencia", "Complejidad", "Astringencia", "Alcohol", "Armonía"]; // Pentágono
                    data = [organo.persistencia, organo.complejidad, organo.astringencia, organo.alcohol_percibido, organo.armonia];
                }

                document.querySelectorAll('.switch-buttons button').forEach(btn => btn.classList.remove('active'));
                document.getElementById(`btn-${tipo}`).classList.add('active');

                radarChart = new Chart(ctx, {
                    type: 'radar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: `Perfil ${tipo}`,
                            data: data.map(x => parseInt(x) || 0),
                            fill: true,
                            backgroundColor: "rgba(128,0,0,0.18)",
                            borderColor: "rgba(128,0,0,1)",
                            pointBackgroundColor: "rgba(128,0,0,1)",
                            pointRadius: 7,
                            pointHoverRadius: 10
                        }]
                    },
                    options: {
                        responsive: true,
                        aspectRatio: 1,
                        maintainAspectRatio: true,
                        layout: { padding: 24 },
                        plugins: { legend: { display: false } },
                        elements: { line: { borderWidth: 3 } },
                        scales: {
                            r: {
                                min: 0,
                                max: 10,
                                beginAtZero: true,
                                ticks: { stepSize: 2, color: "#888", z: 1 },
                                pointLabels: {
                                    font: { size: 15, weight: "bold" },
                                    centerPointLabels: true
                                },
                                angleLines: {
                                    display: true,
                                    color: "#ccc",
                                    lineWidth: 1,
                                    borderDash: [4, 4],
                                },
                                grid: { circular: true },
                                startAngle: -Math.PI / 2, // Polígono orientado siempre igual
                            }
                        }
                    }
                });
            }

            function calcularPuntuacionTotal() {
                let total = 0;
                for (const key in organo) total += parseInt(organo[key]) || 0;
                const maxScore = Object.keys(organo).length * 10;
                const porcentaje = maxScore > 0 ? Math.round((total / maxScore) * 100) : 0;
                const fill = document.getElementById("score-fill");
                fill.style.width = porcentaje + "%";
                fill.innerText = porcentaje + " / 100";
            }

            function renderEstrellas(nota) {
                const contenedor = document.getElementById("estrellas-nota");
                contenedor.innerHTML = "";
                const estrellas = Math.floor(nota);
                const media = nota - estrellas;
                for (let i = 1; i <= 5; i++) {
                    if (i <= estrellas) contenedor.innerHTML += "★";
                    else if (i === estrellas + 1 && media >= 0.25 && media < 0.75) contenedor.innerHTML += "⯪";
                    else contenedor.innerHTML += "☆";
                }
            }

            // --- FUNCIONES DE CARGA DE DATOS (APIs) ---
            async function cargarFichaVino() {
                try {
                    const fichaData = await (await fetch(`https://sommelierlab-api-production.up.railway.app/api/vino/${vinoId}` )).json();
                    document.getElementById("vinoImagen").src = fichaData.imagen?.[0]?.url || "";
                    document.title = document.getElementById("vinoTitulo").innerText = fichaData.nombre || "Ficha del Vino";
                    document.getElementById("vinoTipo").innerText = fichaData.tipo;
                    document.getElementById("vinoUva").innerText = fichaData.variedad;
                    document.getElementById("vinoOrigen").innerText = fichaData.origen;
                    document.getElementById("bodegaNombre").innerText = fichaData.bodega?.nombre || "";
                    const redesHtml = [];
                    if (fichaData.bodega?.web) redesHtml.push(`<a href="${fichaData.bodega.web}" target="_blank">🌐 Web</a>`);
                    if (fichaData.bodega?.facebook) redesHtml.push(`<a href="${fichaData.bodega.facebook}" target="_blank">📘 Facebook</a>`);
                    if (fichaData.bodega?.instagram) redesHtml.push(`<a href="${fichaData.bodega.instagram}" target="_blank">📸 Instagram</a>`);
                    if (fichaData.bodega?.twitter) redesHtml.push(`<a href="${fichaData.bodega.twitter}" target="_blank">🐦 Twitter</a>`);
                    document.getElementById("bodega-redes").innerHTML = redesHtml.join(" · ");
                } catch (error) { console.error("❌ Error cargando la ficha del vino:", error); }
            }

            async function cargarPerfilOrganoleptico() {
                try {
                    organo = await (await fetch(`https://sommelierlab-api-production.up.railway.app/api/organoleptica/${vinoId}` )).json();
                    renderRadar("aromatico");
                    calcularPuntuacionTotal();
                } catch (error) { console.error("❌ Error cargando el perfil organoléptico:", error); }
            }

            async function cargarNarrativaVino() {
                try {
                    const dataCerebro = await (await fetch(`https://n8n-production-cb18.up.railway.app/webhook/consultar-vino?vino_id=${vinoId}` )).json();
                    document.getElementById("respuesta").innerText = dataCerebro.narrativa || "No se pudo generar la narrativa del vino.";
                } catch (error) { console.error("❌ Error cargando la narrativa del vino:", error); }
            }

            async function cargarResumenValoraciones() {
                try {
                    const data = await (await fetch(`https://n8n-production-cb18.up.railway.app/webhook/consultar-valoraciones?vino_id=${vinoId}` )).json();
                    if (data.total_valoraciones > 0) {
                        document.getElementById("rating-summary").style.display = "flex";
                        document.getElementById("media-nota").innerText = data.nota_media.toFixed(1);
                        renderEstrellas(data.nota_media);
                        document.getElementById("total-valoraciones").innerText = `(${data.total_valoraciones} valoraciones)`;
                    }
                } catch (error) { console.error("Error al cargar resumen de valoraciones:", error); }
            }

            // --- LÓGICA DE COMENTARIOS ---
            const listaComentariosEl = document.getElementById("lista-comentarios");
            window.toggleComentarios = function() {
                if (listaComentariosEl.style.maxHeight === "0px" || !listaComentariosEl.style.maxHeight) {
                    listaComentariosEl.style.maxHeight = listaComentariosEl.scrollHeight + "px";
                } else {
                    listaComentariosEl.style.maxHeight = "0px";
                }
            }
            function formatearFecha(fechaStr) {
                return new Date(fechaStr).toLocaleDateString("es-ES", { year: "numeric", month: "long", day: "numeric" });
            }
            async function cargarComentarios() {
                try {
                    const data = await (await fetch(`https://n8n-production-cb18.up.railway.app/webhook/consultar-comentarios?vino_id=${vinoId}` )).json();
                    const comentarios = Array.isArray(data.comentarios) ? data.comentarios : Array.isArray(data) ? data : [];
                    listaComentariosEl.innerHTML = "";
                    if (comentarios.length === 0) {
                        listaComentariosEl.innerHTML = '<p style="padding: 1rem 0;">No hay comentarios aún. ¡Sé el primero en opinar!</p>';
                    } else {
                        comentarios.slice(0, 10).forEach(c => {
                            const div = document.createElement("div");
                            div.className = "comentario";
                            div.innerHTML = `<strong style="color:#800000;">${c.ciudad || "Usuario anónimo"}</strong> · <span style="color: #666;">${formatearFecha(c.fecha)}</span>  
<em>“${c.comentario}”</em>`;
                            listaComentariosEl.appendChild(div);
                        });
                    }
                    if (listaComentariosEl.style.maxHeight !== "0px" && listaComentariosEl.style.maxHeight !== "") {
                        listaComentariosEl.style.maxHeight = listaComentariosEl.scrollHeight + "px";
                    }
                } catch (error) { 
                    console.error("Error al cargar o procesar comentarios:", error);
                    listaComentariosEl.innerHTML = "<p>No se pudieron cargar los comentarios.</p>";
                }
            }

            // --- LÓGICA DE INICIALIZACIÓN Y EVENTOS ---
            if (!vinoId) {
                document.getElementById("respuesta").innerText = "No se especificó ningún vino.";
                return;
            }

            fetch("https://ipapi.co/json/" )
                .then(response => response.json())
                .then(data => {
                    window._datosUsuario = { ciudad: data.city, pais: data.country_name, idioma: navigator.language };
                })
                .catch(error => {
                    console.warn("No se pudo obtener geolocalización:", error);
                    window._datosUsuario = {};
                })
                .finally(() => {
                    document.querySelectorAll(".estrella").forEach(e => {
                        e.addEventListener("click", () => {
                            puntuacionSeleccionada = parseInt(e.dataset.value);
                            document.querySelectorAll(".estrella").forEach(star => {
                                star.classList.toggle("seleccionada", parseInt(star.dataset.value) <= puntuacionSeleccionada);
                            });
                        });
                    });

                    document.getElementById("enviar-valoracion").addEventListener("click", async () => {
                        const comentario = document.getElementById("comentario").value || "";
                        const mensaje = document.getElementById("mensaje-valoracion");
                        if (!puntuacionSeleccionada) {
                            mensaje.innerText = "Por favor, selecciona una puntuación (de 1 a 5 estrellas).";
                            mensaje.style.color = "red";
                            return;
                        }
                        try {
                            await fetch("https://n8n-production-cb18.up.railway.app/webhook/comentar-vino", {
                                method: "POST",
                                headers: { "Content-Type": "application/json" },
                                body: JSON.stringify({
                                    vino_id: vinoId,
                                    puntuacion: puntuacionSeleccionada,
                                    comentario: comentario,
                                    user_id: localStorage.getItem("user_id" ) || "user_" + Math.random().toString(36).substring(2, 10),
                                    ciudad: window._datosUsuario?.ciudad || "Desconocida",
                                    pais: window._datosUsuario?.pais || "Desconocido",
                                    idioma: window._datosUsuario?.idioma || "es"
                                })
                            });
                            mensaje.innerText = "¡Gracias por tu valoración!";
                            mensaje.style.color = "green";
                        } catch (err) {
                            mensaje.innerText = "Error al enviar tu valoración.";
                            mensaje.style.color = "red";
                        }
                    });

                    cargarFichaVino();
                    cargarPerfilOrganoleptico();
                    cargarNarrativaVino();
                    cargarResumenValoraciones();
                    cargarComentarios();
                });
        });
    </script>
</body>
</html>
