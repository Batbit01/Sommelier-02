<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>SommelierLab Â· Ficha del vino</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{ --accent:#c79a5a }
    body{ background:#0f0a0a; color:#fff }
    .frame-soft{ box-shadow:0 8px 30px rgba(0,0,0,.35), inset 0 0 0 1px rgba(255,255,255,.04) }
    .fade-in{ animation:fadeIn .25s ease-out both }
    @keyframes fadeIn{ from{opacity:.0;transform:translateY(4px)} to{opacity:1;transform:none} }
    .grow-x{ transition:width .35s ease }
    #debug{max-height:280px}
  </style>
</head>
<body class="min-h-screen">
  <pre id="debug" class="hidden bg-red-900/25 text-[10px] leading-snug p-3 overflow-auto"></pre>
  <div id="app" class="max-w-[1100px] mx-auto px-4 sm:px-6 pb-28 sm:pb-12"></div>

  <script type="module">
    /* =================== CONFIG =================== */
    const CDN_BASE = "https://f005.backblazeb2.com/file/SommelierLab-media";

    /* =================== I18N =================== */
    const UI = {
      es:{share:"Compartir",sommelier:"PresentaciÃ³n del sommelier",gallery:"GalerÃ­a",social:"Redes y contacto",legal:"Bebe con responsabilidad",
          indicators:{aroma:"Aroma",cuerpo:"Cuerpo",acidez:"Acidez",dulzor:"Dulzor",tanino:"Tanino"}},
      en:{share:"Share",sommelier:"Sommelier presentation",gallery:"Gallery",social:"Social & contact",legal:"Drink responsibly",
          indicators:{aroma:"Aroma",cuerpo:"Body",acidez:"Acidity",dulzor:"Sweetness",tanino:"Tannin"}},
      fr:{share:"Partager",sommelier:"PrÃ©sentation du sommelier",gallery:"Galerie",social:"RÃ©seaux et contact",legal:"Buvez avec modÃ©ration",
          indicators:{aroma:"ArÃ´me",cuerpo:"Corps",acidez:"AciditÃ©",dulzor:"SucrÃ©",tanino:"Tanin"}},
    };

    /* =================== STATE =================== */
    const appState = { q:{}, fichaData:null, t:UI.es };

    /* =================== HELPERS =================== */
    const $ = (s,sc=document)=>sc.querySelector(s);
    function getQ(){
      const p=new URLSearchParams(location.search);
      return {
        vino_id: p.get("vino_id")||"",
        anyada:  p.get("anyada")||"",
        lang:    (p.get("lang")||"es").slice(0,2).toLowerCase(),
        context: p.get("context")||"",
        debug:   p.get("debug")==="1"
      };
    }
    function dbg(x){ const d=$("#debug"); if(!d||!appState.q.debug) return; d.classList.remove("hidden"); d.textContent = typeof x==="string"?x:JSON.stringify(x,null,2).slice(0,4000); }

    /* =================== CDN PATHS =================== */
    const cdnFichaUrl=(vino,any,lang)=>`${CDN_BASE}/qr2/${encodeURIComponent(vino)}/${encodeURIComponent(any)}/${encodeURIComponent(lang)}/ficha.json`;
    const cdnAudioUrl=(vino,any,lang)=>`${CDN_BASE}/qr2/audio/${encodeURIComponent(vino)}/${encodeURIComponent(any)}/${encodeURIComponent(lang)}/base.mp3`;

    /* =================== FETCH =================== */
    async function fetchJSON(u){
      const r=await fetch(u,{cache:"no-store"});
      if(!r.ok) throw new Error(`HTTP ${r.status}`);
      return r.json();
    }

    // Fallbacks: anyada/lang â†’ anyada/es â†’ default/lang â†’ default/es
    async function fetchFicha(){
      const {vino_id, anyada, lang} = appState.q;
      const urls = anyada
        ? [cdnFichaUrl(vino_id,anyada,lang), cdnFichaUrl(vino_id,anyada,'es'), cdnFichaUrl(vino_id,'default',lang), cdnFichaUrl(vino_id,'default','es')]
        : [cdnFichaUrl(vino_id,'default',lang), cdnFichaUrl(vino_id,'default','es')];

      const errors=[];
      for(const u of urls){
        try{
          const j=await fetchJSON(u);
          j.__cdn_url=u; j.__cdn_lang=(j.lang||lang||'es').toLowerCase();
          return j;
        }catch(e){ errors.push({u,err:String(e)}); }
      }
      dbg({fetch_errors:errors});
      throw new Error('NO_FICHA_CDN');
    }

    /* =================== NORMALIZE =================== */
    function normalizeForFront(raw, q){
      if (!raw) return raw;
      const ff = raw.for_front || {};
      const h  = ff.header || {};
      const bi = raw.bodega_info || {};
      const lang = (raw.lang || q?.lang || 'es').toLowerCase();

      const out = structuredClone(raw);
      out.ficha           = out.ficha || {};
      out.ficha.narrativa = out.ficha.narrativa || {};
      out.ficha.cta       = out.ficha.cta || {};
      out.social          = out.social || {};

      // Header bÃ¡sicos
      out.ficha.bodega   = out.ficha.bodega   || h.bodega || bi['Bodega'] || '';
      out.ficha.nombre   = out.ficha.nombre   || h.titulo || '';
      out.ficha.year     = out.ficha.year     || h.anyada || out.anyada || '';
      out.ficha.do       = out.ficha.do       || h.do || bi['Origen/DO'] || '';
      out.ficha.variedad = out.ficha.variedad || h.variedad || '';

      // Botella
      out.ficha.bottle_media = out.ficha.bottle_media || { image_url:'', video_url:'' };
      if(!out.ficha.bottle_media.image_url) out.ficha.bottle_media.image_url = h.imagen || '';

      // Narrativa
      if(!out.ficha.narrativa.texto) out.ficha.narrativa.texto = ff.narrativa_es || '';

      // OrganolÃ©ptico merge
      const orgF  = out.ficha.organoleptico || {};
      const orgFF = ff.organoleptico || {};
      out.ficha.organoleptico = {
        texto:    orgF.texto    ?? orgFF.texto    ?? '',
        servicio: orgF.servicio ?? orgFF.servicio ?? null,
        aromatico: orgF.aromatico ?? orgFF.aromatico ?? [],
        gustativo: orgF.gustativo ?? orgFF.gustativo ?? [],
        sensor ial: orgF.sensorial ?? orgFF.sensorial ?? [],
        chips: orgF.chips ?? orgFF.chips ?? { aromatico:[], gustativo:[], sensorial:[] },
        barras: orgF.barras ?? orgFF.indicadores ?? {}
      };

      // Tech info
      out.ficha.tech_info = out.ficha.tech_info || {};
      const ti = out.ficha.tech_info;
      ti.vinificacion_y_crianza = ti.vinificacion_y_crianza || [];
      ti.origen_y_vendimia      = ti.origen_y_vendimia || [];
      ti.produccion             = ti.produccion || [];
      ti.notas_de_cata          = ti.notas_de_cata || [];
      ti.curiosidad             = ti.curiosidad || [];

      // Premios â†’ badges simples si vienen como raÃ­z `premios`
      if(Array.isArray(out.premios) && out.premios.length){
        out.ficha.awards = out.premios.map(p=>({label:p.fuente||'Award', score:p.puntuacion||null}));
      }

      // CTA desde social/bodega_info
      out.ficha.cta.visita_url   = out.ficha.cta.visita_url || ff.enoturismo?.reserva_url || bi['Reservas_URL_Base'] || out.social.website || '';
      out.ficha.cta.contacto_url = out.ficha.cta.contacto_url || (out.social.email ? `mailto:${out.social.email}` : '');

      // Social mÃ­nimos
      out.social.website = out.social.website || ff.contacto?.web || bi['Web URL'] || '';
      out.social.email   = out.social.email   || ff.contacto?.email || bi['Email de contacto'] || '';

      out.available_langs = Array.isArray(out.available_langs) && out.available_langs.length
        ? out.available_langs.map(x=>String(x).toLowerCase())
        : [lang];
      out.__cdn_lang = (out.__cdn_lang || lang);
      return out;
    }

    function enrichLegacy(d){
      if(!d || !d.ficha) return d;

      // Audio fallback preferente anyada/lang
      if(!d.ficha.narrativa?.audio_url){
        const tries = [
          cdnAudioUrl(d.vino_id||'', d.anyada||'default', (d.lang||'es').toLowerCase()),
          cdnAudioUrl(d.vino_id||'', d.anyada||'default', 'es'),
          cdnAudioUrl(d.vino_id||'', 'default', (d.lang||'es').toLowerCase()),
          cdnAudioUrl(d.vino_id||'', 'default', 'es'),
        ];
        d.ficha.narrativa = d.ficha.narrativa || {};
        d.ficha.narrativa.audio_url = tries[0];
      }

      // Social â†’ CTA fallback
      if(d.social){
        d.ficha.cta ??= {};
        if(!d.ficha.cta.visita_url && d.social.website) d.ficha.cta.visita_url = d.social.website;
        if(!d.ficha.cta.contacto_url && d.social.email)  d.ficha.cta.contacto_url = `mailto:${d.social.email}`;
      }
      return d;
    }

    /* =================== RENDER =================== */
    function headerHTML(d){
      const langs = d.available_langs?.length ? d.available_langs : [d.__cdn_lang||appState.q.lang||"es"];
      return `
      <header class="py-4 flex items-center justify-between gap-3">
        <div>
          <div class="text-sm text-neutral-300">${d.ficha.bodega||''}</div>
          <div class="text-2xl font-semibold">${d.ficha.nombre||''} <span class="text-neutral-400">${d.ficha.year||''}</span></div>
          <div class="mt-1 flex flex-wrap items-center gap-2 text-[11px]">
            ${ d.ficha.do ? `<span class="px-2 py-1 rounded-full bg-neutral-800 border border-neutral-700">${d.ficha.do}</span>` : '' }
            ${ d.ficha.variedad ? `<span class="px-2 py-1 rounded-full bg-neutral-800 border border-neutral-700">${d.ficha.variedad}</span>` : '' }
          </div>
          <div class="text-[10px] text-neutral-600 mt-1">CDN: ${d.__cdn_url||"â€“"} (${d.__cdn_lang||"?"})</div>
        </div>
        <div class="flex items-center gap-3">
          <select id="langSel" class="bg-neutral-900 border border-neutral-700 rounded-lg px-2 py-1 text-sm">
            ${ langs.map(l=>`<option value="${l}" ${l===(d.__cdn_lang||appState.q.lang)?'selected':''}>${l.toUpperCase()}</option>`).join('') }
          </select>
          <button id="shareBtn" class="text-amber-400 underline">${appState.t.share}</button>
        </div>
      </header>
      <hr class="border-neutral-800">`;
    }

    function heroHTML(d){
      const img = d.ficha?.bottle_media?.image_url || d.for_front?.header?.imagen || "";
      if(!img) return "";
      return `
        <section class="py-6">
          <img src="${img}" alt="bottle"
            class="w-40 h-64 mx-auto object-contain rounded-xl border border-neutral-700 bg-neutral-800 frame-soft shadow-xl">
        </section>
        <hr class="border-neutral-800">`;
    }

    function narrativaHTML(d){
      const n=d.ficha?.narrativa?.texto||"";
      const au=d.ficha?.narrativa?.audio_url||"";
      if(!n && !au) return "";
      return `
        <section class="py-6">
          <h2 class="text-xl font-semibold mb-2">${appState.t.sommelier}</h2>
          ${ n ? `<p class="text-neutral-200 leading-relaxed mb-3">${String(n).replace(/\n/g,"<br>")}</p>` : "" }
          ${ au ? `<audio controls class="w-full"><source src="${au}" type="audio/mpeg"></audio>` : `<p class="text-[11px] text-neutral-500">Audio no disponible.</p>` }
        </section>
        <hr class="border-neutral-800">`;
    }

    function renderOrganoleptico(d){
      const o=d.ficha?.organoleptico || {};
      const hasTexto = !!(o.texto && String(o.texto).trim());
      const hasTemp  = !!(o.servicio && o.servicio.temperatura);
      const hasChips = (o.aromatico?.length||o.gustativo?.length||o.sensorial?.length);
      const hasBars  = !!(o.barras && Object.keys(o.barras).length);
      if(!(hasTexto || hasTemp || hasChips || hasBars)) return '';

      const textoHTML = hasTexto
        ? `<p class="text-sm leading-relaxed text-neutral-200 mb-3">${String(o.texto).replace(/\n/g,'<br>')}</p>`
        : '';

      const tempHTML = hasTemp
        ? `<p class="text-[12px] text-neutral-400 mb-4">Temperatura de servicio: ${o.servicio.temperatura}</p>`
        : '';

      const chips = (title, arr)=>!arr?.length ? '' : `
        <div class="fade-in">
          <div class="text-sm mb-2 text-neutral-300">${title}</div>
          <div class="flex flex-wrap gap-2">
            ${arr.map(x=>`<span class="px-2 py-1 rounded-full bg-neutral-800 border border-neutral-700 text-[11px]">${x}</span>`).join('')}
          </div>
        </div>`;

      const bars = !hasBars ? '' : (()=>{
        const rows = Object.entries(o.barras).map(([k,val])=>{
          const pct = Math.max(0,Math.min(10,Number(val||0)))*10;
          const label = (UI[d.__cdn_lang]?.indicators?.[k]) || k;
          return `<div class="flex items-center gap-3">
            <div class="w-28 text-[12px] text-neutral-300">${label}</div>
            <div class="flex-1 h-2 bg-neutral-800 rounded">
              <div class="h-2 bg-amber-500 grow-x rounded" style="width:${pct}%"></div>
            </div>
            <div class="w-10 text-right text-[12px] text-neutral-400">${val||0}/10</div>
          </div>`;
        }).join('');
        return `<div class="space-y-2 fade-in mb-4">${rows}</div>`;
      })();

      return `
        <section class="py-6">
          ${textoHTML}
          ${tempHTML}
          ${bars}
          ${chips('Aromas', o.aromatico)}
          ${chips('Boca', o.gustativo)}
          ${chips('Sensorial', o.sensorial)}
        </section>
        <hr class="border-neutral-800">`;
    }

    function renderTech(d){
      const t=d.ficha?.tech_info||{};
      const entries = Object.entries(t).filter(([,v])=>Array.isArray(v)&&v.length);
      if(!entries.length) return "";
      return `
        <section class="py-6">
          <div class="space-y-4">
            ${entries.map(([k,arr])=>`
             <details open class="group border border-neutral-800 rounded-xl p-3">
               <summary class="cursor-pointer font-medium text-neutral-100">${k.replaceAll('_',' ')}</summary>
               <div class="mt-2 text-neutral-300">${arr.map(x=>`<p class="mb-2">${x}</p>`).join('')}</div>
             </details>`).join('')}
          </div>
        </section>
        <hr class="border-neutral-800">`;
    }

    function renderAwards(d){
      const a = d.ficha?.awards || [];
      if(!a.length) return '';
      return `
        <section class="py-4">
          <div class="flex flex-wrap gap-2">
            ${a.map(w=>`<span class="px-2 py-1 rounded-full bg-neutral-800 border border-neutral-700 text-[11px]">${w.label}${w.score?` Â· ${w.score}`:''}</span>`).join('')}
          </div>
        </section>
        <hr class="border-neutral-800">`;
    }

    function ctaHTML(d){
      const c=d.ficha?.cta||{};
      if(!c.comprar_url && !c.visita_url && !c.contacto_url) return "";
      return `
        <section class="py-6 flex flex-wrap gap-3">
          ${ c.comprar_url ? `<a href="${c.comprar_url}" class="bg-amber-500 text-neutral-900 rounded-xl px-4 py-2">Comprar</a>` : "" }
          ${ c.visita_url ? `<a href="${c.visita_url}" class="bg-neutral-800 border border-neutral-700 rounded-xl px-4 py-2">Visitar bodega</a>` : "" }
          ${ c.contacto_url ? `<a href="${c.contacto_url}" class="underline text-amber-400">Contacto</a>` : "" }
        </section>
        <hr class="border-neutral-800">`;
    }

    function socialHTML(d){
      const s=d.social||{};
      if(!(s.website||s.email)) return "";
      return `
        <section class="py-6">
          <h2 class="text-lg mb-3 text-neutral-100">${appState.t.social}</h2>
          <div class="flex flex-wrap gap-3 text-sm">
            ${ s.website ? `<a href="${s.website}" class="underline text-amber-400" target="_blank">Web</a>` : "" }
            ${ s.email ? `<a href="mailto:${s.email}" class="underline text-amber-400">Email</a>` : "" }
          </div>
        </section>
        <hr class="border-neutral-800">`;
    }

    function footerHTML(d){
      return `<footer class="py-10 text-center text-neutral-400">
        <div><a href="https://sommelierlab.com" class="underline">Powered by SommelierLab</a></div>
        <div class="mt-4">${(UI[d.__cdn_lang]||UI.es).legal}</div>
      </footer>`;
    }

    function render(d){
      appState.t = UI[d.__cdn_lang] || UI.es;
      const app=$("#app");
      app.innerHTML = [
        headerHTML(d),
        heroHTML(d),
        narrativaHTML(d),
        renderAwards(d),
        renderOrganoleptico(d),
        renderTech(d),
        ctaHTML(d),
        socialHTML(d),
        footerHTML(d)
      ].join("");

      const sel=$("#langSel");
      if(sel){ sel.addEventListener("change",()=>{ const u=new URL(location.href); u.searchParams.set("lang", sel.value); location.href=u.toString(); }); }
      const sb=$("#shareBtn");
      if(sb){ sb.addEventListener("click", async ()=>{ try{
        if(navigator.share) await navigator.share({title:document.title, url:location.href});
        else { await navigator.clipboard.writeText(location.href); sb.textContent="Copiado"; setTimeout(()=>sb.textContent=appState.t.share,1200); }
      }catch{} }); }
    }

    /* =================== BOOT =================== */
    (async function bootstrap(){
      appState.q = getQ();
      if(!appState.q.vino_id || !appState.q.anyada){
        $("#app").innerHTML = '<div class="p-6 text-red-400">Faltan parÃ¡metros ?vino_id=...&anyada=...</div>';
        return;
      }
      try{
        const raw = await fetchFicha();
        const data = normalizeForFront(enrichLegacy(raw), appState.q);
        dbg({loaded_from:data.__cdn_url, lang:data.__cdn_lang, organoleptico:{
          texto: !!data.ficha?.organoleptico?.texto,
          barras: data.ficha?.organoleptico?.barras && Object.keys(data.ficha.organoleptico.barras).length
        }});
        appState.fichaData = data;
        render(data);
      }catch(e){
        console.error(e);
        $("#app").innerHTML = '<div class="p-6 text-red-400">Error cargando la ficha.</div>';
      }
    })();
  </script>

  <!-- Sommelier conversacional flotante -->
  <style>
    #sommelier-float{ position:fixed; right:18px; bottom:100px; z-index:60;
      background: radial-gradient(circle at 30% 30%, #facc15 0%, #b45309 90%);
      box-shadow:0 0 18px rgba(0,0,0,0.4); border-radius:50px; cursor:pointer;
      display:flex; align-items:center; gap:10px; padding:10px 14px; }
    #sommelier-wrapper{ position:fixed; right:18px; bottom:165px; z-index:65; display:none; }
    #sommelier-close{ position:absolute; top:-28px; right:-14px; width:28px; height:28px; border-radius:50%;
      border:none; background:#facc15; color:#111; font-size:18px; font-weight:bold; cursor:pointer; z-index:99999; }
  </style>

  <div id="sommelier-float"><span style="font-size:28px">ðŸŽ™</span><span class="font-semibold text-neutral-900">Preguntar al sommelier</span></div>
  <div id="sommelier-wrapper">
    <button id="sommelier-close">âœ•</button>
    <elevenlabs-convai id="sommelier-widget"
      agent-id="agent_01jy4198vjepzb9yz3jwz3b93c"
      position="floating" behavior="expanded" variant="compact"></elevenlabs-convai>
  </div>
  <script src="https://unpkg.com/@elevenlabs/convai-widget-embed" async></script>
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const btn = document.getElementById("sommelier-float");
      const wrapper = document.getElementById("sommelier-wrapper");
      const widget = document.getElementById("sommelier-widget");
      const btnClose = document.getElementById("sommelier-close");
      const start = ()=>{
        if(widget?.startConversation) try{ widget.startConversation(); }catch{}
        setTimeout(()=>{ try{
          const sr = widget.shadowRoot; const b = sr && sr.querySelector("button,[role='button']"); if(b) b.click();
        }catch{} }, 400);
      };
      btn.addEventListener("click", ()=>{ wrapper.style.display="block"; setTimeout(start, 200); });
      btnClose.addEventListener("click", ()=>{ wrapper.style.display="none"; if(widget?.endConversation) widget.endConversation(); });
      document.addEventListener("click",(e)=>{ if(!e.target.closest("#sommelier-wrapper") && !e.target.closest("#sommelier-float")) wrapper.style.display="none"; });
    });
  </script>
</body>
</html>
